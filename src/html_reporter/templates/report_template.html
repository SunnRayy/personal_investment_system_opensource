<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Investment Report</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 1rem 1rem;
        }

        .kpi-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            border: none;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .table-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-unmapped {
            background-color: #fff3cd !important;
            color: #856404;
        }

        .status-non-rebalanceable {
            background-color: #f8d7da !important;
            color: #721c24;
        }

        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: #495057;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        /* Phase 3 Enhancement: Warning indicators for approximated XIRR */
        .xirr-warning {
            color: #ffc107;
            font-size: 0.8rem;
            margin-left: 0.25rem;
            cursor: help;
        }

        .xirr-warning:hover {
            color: #e0a800;
        }

        .kpi-label-with-warning {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        /* Tooltip styling */
        .tooltip-inner {
            max-width: 300px;
            text-align: left;
            font-size: 0.875rem;
        }

        color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        /* Hierarchical Recommendations Styling */
        .recommendation-hierarchy {
            margin-top: 20px;
        }

        .recommendation-card {
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .recommendation-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* PHASE 7.1: Ensure recommendation card headers always have proper contrast */
        .recommendation-card .card-header {
            border-bottom: 1px solid #e0e0e0;
        }

        /* Explicit background colors to prevent overrides */
        .recommendation-card .card-header.bg-danger {
            background-color: #dc3545 !important;
        }

        .recommendation-card .card-header.bg-warning {
            background-color: #ffc107 !important;
        }

        .recommendation-card .card-header.bg-info {
            background-color: #0dcaf0 !important;
        }

        /* Ensure text inside headers respects the color classes */
        .recommendation-card .card-header h5,
        .recommendation-card .card-header small {
            color: inherit !important;
        }

        /* Override text-white and text-dark for headers to ensure visibility */
        .recommendation-card .card-header .text-white,
        .recommendation-card .card-header h5.text-white,
        .recommendation-card .card-header small.text-white {
            color: #ffffff !important;
        }

        .recommendation-card .card-header .text-dark,
        .recommendation-card .card-header h5.text-dark,
        .recommendation-card .card-header small.text-dark {
            color: #212529 !important;
        }

        .recommendation-card .card-header h5 {
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        /* PHASE 6.2.3: Strategic Recommendation Specific Styling */
        .recommendation-card.strategic-card .card-body {
            background-color: #ffffff !important;
            color: #212529 !important;
        }

        .recommendation-card.strategic-card .card-body p,
        .recommendation-card.strategic-card .card-body li,
        .recommendation-card.strategic-card .card-body strong {
            color: #212529 !important;
        }

        .recommendation-card.strategic-card .text-muted {
            color: #6c757d !important;
        }

        .strategic-badge {
            background-color: #ffc107 !important;
            color: #212529 !important;
            font-size: 0.85rem !important;
            padding: 0.3em 0.6em !important;
            font-weight: 600 !important;
        }

        .sub-recommendations {
            padding: 0;
        }

        .sub-recommendation-item {
            border-bottom: 1px solid #f0f0f0 !important;
            padding: 12px 0 !important;
            margin: 0;
        }

        .sub-recommendation-item:last-child {
            border-bottom: none !important;
        }

        .sub-action-details {
            flex: 1;
        }

        .sub-action-meta {
            min-width: 140px;
        }

        .sub-recommendation-item .fw-medium {
            font-weight: 600;
        }

        .sub-recommendation-item .text-muted {
            font-size: 0.9rem;
        }

        /* Holdings Table Styling */
        .subtotal-row {
            font-weight: bold;
            border-top: 2px solid #dee2e6 !important;
        }

        .top-class-subtotal {
            background-color: #e9ecef !important;
            color: #495057;
            font-size: 1.1rem;
        }

        .sub-class-subtotal {
            background-color: #f8f9fa !important;
            color: #6c757d;
            font-size: 1.05rem;
        }

        .asset-row {
            background-color: white;
        }

        .asset-row:hover {
            background-color: #f5f5f5 !important;
        }

        .subtotal-row:hover {
            background-color: inherit !important;
        }

        /* Market Thermometer Styling */
        .thermometer-card {
            height: 280px;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .thermometer-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .thermometer-card .card-header {
            border-radius: 1rem 1rem 0 0 !important;
            padding: 1.5rem;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none !important;
        }

        .thermometer-card .card-body {
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .indicator-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .indicator-zone {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .indicator-explanation {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            word-break: break-word;
            white-space: normal;
        }

        .indicator-meta {
            font-size: 0.85rem;
            color: #6c757d;
            text-align: center;
            white-space: nowrap;
        }

        .indicator-warning {
            font-size: 0.85rem;
            color: #ff9800;
            text-align: center;
            white-space: normal;
            word-break: break-word;
        }

        /* Level-based color classes */
        .level-0-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .level-1-header {
            background: linear-gradient(135deg, #17a2b8 0%, #3498db 100%);
        }

        .level-2-header {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
        }

        .level-3-header {
            background: linear-gradient(135deg, #fd7e14 0%, #ff922b 100%);
        }

        .level-4-header {
            background: linear-gradient(135deg, #dc3545 0%, #c92a2a 100%);
        }

        .level-error-header {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
        }

        .level-0-text {
            color: #28a745;
        }

        .level-1-text {
            color: #17a2b8;
        }

        .level-2-text {
            color: #ffc107;
        }

        .level-3-text {
            color: #fd7e14;
        }

        .level-4-text {
            color: #dc3545;
        }

        .level-error-text {
            color: #6c757d;
        }

        .thermometer-info-box {
            background-color: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 2rem;
        }
    </style>
</head>

<body>
    <!-- Report Header -->
    <div class="report-header">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="display-4 mb-0">{{ _('Personal Investment Report') }}</h1>
                    <p class="lead mb-0">{{ _('Comprehensive Portfolio Analysis') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                    <i class="bi bi-speedometer2 me-2"></i>{{ _('Dashboard') }}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="action-compass-tab" data-bs-toggle="tab" data-bs-target="#action-compass"
                    type="button" role="tab" aria-controls="action-compass" aria-selected="false">
                    <i class="bi bi-compass me-2"></i>{{ _('Action Compass') }}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="market-thermometer-tab" data-bs-toggle="tab"
                    data-bs-target="#market-thermometer" type="button" role="tab" aria-controls="market-thermometer"
                    aria-selected="false">
                    <i class="bi bi-thermometer-half me-2"></i>{{ _('Market Thermometer') }}
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="reportTabsContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">

                <!-- Portfolio At-a-Glance Section -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h2 class="section-title">{{ _('Portfolio At-a-Glance') }}</h2>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">¥{{ total_portfolio_value }}</div>
                            <div class="kpi-label">{{ _('Total Portfolio Value') }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">¥{{ total_liability }}</div>
                            <div class="kpi-label">{{ _('Total Liability') }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">¥{{ total_net_assets }}</div>
                            <div class="kpi-label">{{ _('Total Net Assets') }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">¥{{ total_liquid_portfolio }}</div>
                            <div class="kpi-label">{{ _('Total Liquid Portfolio') }}</div>
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">
                                {{ overall_xirr }}%
                                {% if xirr_metadata.show_warning %}
                                <i class="bi bi-exclamation-triangle-fill xirr-warning" data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="This XIRR calculation is approximated using {{ xirr_metadata.method_used }} method. Confidence: {{ xirr_metadata.confidence }}."></i>
                                {% endif %}
                            </div>
                            <div class="kpi-label-with-warning">
                                <span>{{ _('Overall XIRR') }}</span>
                                {% if xirr_metadata.show_warning %}
                                <small class="text-muted">({{ _('approximated') }})</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="kpi-card">
                            <div class="kpi-value">{{ sharpe_ratio }}</div>
                            <div class="kpi-label">{{ _('Sharpe Ratio') }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <!-- Empty space for future metrics -->
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <!-- Empty space for future metrics -->
                    </div>
                </div>

                <!-- Current Asset Allocation Section -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h2 class="section-title">{{ _('Current Asset Allocation') }}</h2>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Top-Level Asset Classes') }}</h4>
                            <canvas id="topLevelChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Sub-Class Allocation') }}</h4>
                            <canvas id="subClassChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Historical Performance Section -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h2 class="section-title">{{ _('Historical Performance') }}</h2>
                    </div>

                    <!-- Portfolio Growth Chart -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Portfolio Growth Over Time') }}</h4>
                            <p class="text-muted mb-3">{{ _('Total portfolio value progression over historical periods')
                                }}</p>
                            <div style="position: relative; height: 400px;">
                                <canvas id="portfolioGrowthChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Analysis Chart -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Monthly Cash Flow Analysis') }}</h4>
                            <p class="text-muted mb-3">{{ _('Income, expenses, and investments breakdown over time') }}
                            </p>
                            <div style="position: relative; height: 400px;">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Time-Weighted Return (TWR) Chart -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Time-Weighted Return (TWR)') }}</h4>
                            <p class="text-muted mb-3">{{ _('Pure investment performance excluding the impact of cash
                                flows') }}</p>
                            <div style="position: relative; height: 400px;">
                                <canvas id="twrChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio Drawdown History Chart -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <h4 class="chart-title">{{ _('Portfolio Drawdown History') }}</h4>
                            <p class="text-muted mb-3">{{ _('Historical peak-to-trough decline analysis showing
                                portfolio volatility') }}</p>
                            <div style="position: relative; height: 400px;">
                                <canvas id="drawdownChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Performance by Asset Class Tables -->
                    <div class="col-12">
                        <div class="table-container">
                            <h4 class="section-title">{{ _('Performance by Asset Class') }}</h4>

                            <!-- Top-Level Performance Table -->
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3">{{ _('Top-Level Classes') }}</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{{ _('Asset Class') }}</th>
                                                    <th class="text-end">{{ _('Market Value (CNY)') }}</th>
                                                    <th class="text-end">{{ _('% of Portfolio') }}</th>
                                                    <th class="text-end">{{ _('Weighted Avg. XIRR (%)') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in top_level_performance %}
                                                <tr>
                                                    <td>{{ item.class_name }}</td>
                                                    <td class="text-end">¥{{ "{:,.0f}".format(item.market_value) }}</td>
                                                    <td class="text-end">{{ "{:.1f}".format(item.portfolio_percentage)
                                                        }}%</td>
                                                    <td
                                                        class="text-end {% if item.xirr and item.xirr > 0 %}positive{% elif item.xirr and item.xirr < 0 %}negative{% else %}text-muted{% endif %}">
                                                        {% if item.xirr is not none %}
                                                        {{ "{:.2f}".format(item.xirr) }}%
                                                        {% if item.metadata and item.metadata.show_warning %}
                                                        <i class="bi bi-exclamation-triangle-fill xirr-warning"
                                                            data-bs-toggle="tooltip" data-bs-placement="top"
                                                            title="{{ item.metadata.approximated_count }}/{{ item.metadata.total_count }} assets approximated ({{ '{:.0f}'.format(item.metadata.approximation_percentage) }}%)"></i>
                                                        {% endif %}
                                                        {% else %}
                                                        N/A
                                                        <i class="bi bi-exclamation-triangle-fill xirr-warning"
                                                            data-bs-toggle="tooltip" data-bs-placement="top"
                                                            title="No XIRR data available for this asset class"></i>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Sub-Class Performance Table -->
                                <div class="col-md-6">
                                    <h5 class="mb-3">{{ _('Sub-Classes') }}</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{{ _('Sub-Class') }}</th>
                                                    <th class="text-end">{{ _('Market Value (CNY)') }}</th>
                                                    <th class="text-end">{{ _('% of Portfolio') }}</th>
                                                    <th class="text-end">{{ _('Weighted Avg. XIRR (%)') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in sub_class_performance %}
                                                <tr>
                                                    <td>{{ item.class_name }}</td>
                                                    <td class="text-end">¥{{ "{:,.0f}".format(item.market_value) }}</td>
                                                    <td class="text-end">{{ "{:.1f}".format(item.portfolio_percentage)
                                                        }}%</td>
                                                    <td
                                                        class="text-end {% if item.xirr and item.xirr > 0 %}positive{% elif item.xirr and item.xirr < 0 %}negative{% else %}text-muted{% endif %}">
                                                        {% if item.xirr is not none %}
                                                        {{ "{:.2f}".format(item.xirr) }}%
                                                        {% if item.metadata and item.metadata.show_warning %}
                                                        <i class="bi bi-exclamation-triangle-fill xirr-warning"
                                                            data-bs-toggle="tooltip" data-bs-placement="top"
                                                            title="{{ item.metadata.approximated_count }}/{{ item.metadata.total_count }} assets approximated ({{ '{:.0f}'.format(item.metadata.approximation_percentage) }}%)"></i>
                                                        {% endif %}
                                                        {% else %}
                                                        N/A
                                                        <i class="bi bi-exclamation-triangle-fill xirr-warning"
                                                            data-bs-toggle="tooltip" data-bs-placement="top"
                                                            title="No XIRR data available for this sub-class"></i>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 12-Month Financial Forecast Section -->
                <div class="row">
                    <div class="col-12">
                        <h2 class="section-title">{{ _('12-Month Financial Forecast') }}</h2>
                        <p class="section-description">
                            {{ _('SARIMA-based forecasting for the next 12 months of income, expenses, and
                            investments.') }}
                            {{ _('Projections are based on historical patterns and trends in your financial data.') }}
                        </p>
                    </div>

                    <!-- Forecast Chart -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h4 class="chart-title">{{ _('Cash Flow Forecast (Next 12 Months)') }}</h4>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="forecastChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forecast Summary Table -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Forecast Summary') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>{{ _('Metric') }}</th>
                                                <th class="text-end">{{ _('Monthly Average') }}</th>
                                                <th class="text-end">{{ _('12-Month Total') }}</th>
                                                <th>{{ _('Trend') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>{{ _('Income') }}</strong></td>
                                                <td class="text-end text-success" id="avgIncome">¥--</td>
                                                <td class="text-end text-success" id="totalIncome">¥--</td>
                                                <td><span id="incomeTrend" class="badge bg-info">Stable</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>{{ _('Expenses') }}</strong></td>
                                                <td class="text-end text-danger" id="avgExpenses">¥--</td>
                                                <td class="text-end text-danger" id="totalExpenses">¥--</td>
                                                <td><span id="expensesTrend" class="badge bg-info">Stable</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>{{ _('Investments') }}</strong></td>
                                                <td class="text-end text-primary" id="avgInvestments">¥--</td>
                                                <td class="text-end text-primary" id="totalInvestments">¥--</td>
                                                <td><span id="investmentsTrend" class="badge bg-info">Stable</span></td>
                                            </tr>
                                            <tr class="table-light">
                                                <td><strong>{{ _('Net Cash Flow') }}</strong></td>
                                                <td class="text-end" id="avgNetFlow">¥--</td>
                                                <td class="text-end" id="totalNetFlow">¥--</td>
                                                <td><span id="netFlowTrend" class="badge bg-success">Positive</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        {{ _('Forecasts are generated using SARIMA (Seasonal AutoRegressive Integrated
                                        Moving Average) models based on historical data patterns.') }}
                                        {{ _('Actual results may vary due to market conditions and personal financial
                                        decisions.') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Realized vs. Unrealized Gains Analysis Section -->
                <div class="container">
                    <div class="row mb-5">
                        <div class="col-12">
                            <h2 class="section-title">{{ _('Realized vs. Unrealized Gains Analysis') }}</h2>

                            <!-- KPI Cards Row -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="kpi-card gains-card realized-gains">
                                        <div class="kpi-value">¥{{ "{:,.0f}".format(gains_analysis_data.realized_gains)
                                            }}</div>
                                        <div class="kpi-label">{{ _('Total Realized Gains') }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="kpi-card gains-card unrealized-gains">
                                        <div class="kpi-value">¥{{
                                            "{:,.0f}".format(gains_analysis_data.unrealized_gains) }}</div>
                                        <div class="kpi-label">{{ _('Total Unrealized Gains') }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="kpi-card gains-card total-gains">
                                        <div class="kpi-value">¥{{ "{:,.0f}".format(gains_analysis_data.total_gains) }}
                                        </div>
                                        <div class="kpi-label">{{ _('Total Gains') }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gains Comparison Chart -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <h5>{{ _('Gains Breakdown') }}</h5>
                                        <div style="position: relative; height: 300px;">
                                            <canvas id="gainsComparisonChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                {% if gains_analysis_data.subclass_breakdown %}
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <h5>{{ _('Sub-Class Level Realized vs Unrealized') }}</h5>
                                        <div style="position: relative; height: 300px;">
                                            <canvas id="subclassGainsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PHASE 7.2.1: Detailed Holdings Section - Moved here for better information flow -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="table-container">
                            <h2 class="section-title">{{ _('Detailed Holdings') }}</h2>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>{{ _('Top Class') }}</th>
                                            <th>{{ _('Sub-class') }}</th>
                                            <th>{{ _('Asset Name') }}</th>
                                            <th>{{ _('Asset Class') }}</th>
                                            <th class="text-end">{{ _('Market Value (CNY)') }}</th>
                                            <th class="text-end">{{ _('% of Portfolio') }}</th>
                                            <th class="text-end">{{ _('XIRR') }}</th>
                                            <th class="text-center">{{ _('Status') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for holding in holdings %}
                                        {% if holding.is_subtotal %}
                                        {% if holding.subtotal_type == 'top_class' %}
                                        <!-- Top Class Subtotal Row -->
                                        <tr class="subtotal-row top-class-subtotal">
                                            <td colspan="3"><strong>{{ holding.top_class }}</strong></td>
                                            <td></td>
                                            <td class="text-end"><strong>¥{{ holding.market_value }}</strong></td>
                                            <td class="text-end"><strong>{{ holding.portfolio_percentage }}%</strong>
                                            </td>
                                            <td class="text-end"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        {% elif holding.subtotal_type == 'sub_class' %}
                                        <!-- Sub-class Subtotal Row -->
                                        <tr class="subtotal-row sub-class-subtotal">
                                            <td></td>
                                            <td colspan="2"><strong>{{ holding.sub_class }}</strong></td>
                                            <td></td>
                                            <td class="text-end"><strong>¥{{ holding.market_value }}</strong></td>
                                            <td class="text-end"><strong>{{ holding.portfolio_percentage }}%</strong>
                                            </td>
                                            <td class="text-end"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        {% endif %}
                                        {% else %}
                                        <!-- Individual Asset Row -->
                                        <tr
                                            class="asset-row {% if holding.status == 'Unmapped' %}status-unmapped{% elif holding.status == 'Non-Rebalanceable' %}status-non-rebalanceable{% endif %}">
                                            <td>{% if holding.top_class %}<span class="badge bg-primary">{{
                                                    holding.top_class }}</span>{% endif %}</td>
                                            <td>{% if holding.sub_class %}<span class="badge bg-secondary">{{
                                                    holding.sub_class }}</span>{% endif %}</td>
                                            <td>{{ holding.asset_name }}</td>
                                            <td>{{ holding.asset_class }}</td>
                                            <td class="text-end">¥{{ holding.market_value }}</td>
                                            <td class="text-end">{{ holding.portfolio_percentage }}%</td>
                                            <td class="text-end">
                                                {% if holding.xirr is not none %}
                                                {{ "{:.2f}".format(holding.xirr) }}%
                                                {% else %}
                                                N/A
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if holding.status == 'Unmapped' %}
                                                <span class="badge bg-warning">{{ holding.status }}</span>
                                                {% elif holding.status == 'Non-Rebalanceable' %}
                                                <span class="badge bg-danger">{{ holding.status }}</span>
                                                {% else %}
                                                <span class="badge bg-success">{{ holding.status }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lifetime Asset Performance Section -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h2 class="section-title d-flex align-items-center">
                            <span>{{ _('Lifetime Asset Performance') }}</span>
                            <button id="toggleLifetimeBtn" class="btn btn-sm btn-outline-secondary ms-3" type="button"
                                onclick="toggleLifetimePerf()">{{ _('Show Table') }}</button>
                        </h2>
                        <div id="lifetimePerformancePanel" class="table-container" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped" id="lifetimePerformanceTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortLifetimeTable(0)">{{ _('Asset Name') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(1)">{{ _('Asset Class') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(2)">{{ _('Holding Period') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(3)">{{ _('Status') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(4)">{{ _('Total Invested') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(5)">{{ _('Current Value') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(6)">{{ _('Profit/Loss') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(7)">{{ _('Return %') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(8)">{{ _('XIRR') }} <i
                                                    class="fas fa-sort"></i></th>
                                            <th onclick="sortLifetimeTable(9)">{{ _('Performance Status') }} <i
                                                    class="fas fa-sort"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for asset in lifetime_performance %}
                                        <tr>
                                            <td><strong>{{ asset.asset_name }}</strong></td>
                                            <td>{{ asset.asset_class }}</td>
                                            <td>{{ asset.holding_period }}</td>
                                            <td>
                                                {% if asset.status == 'Active' %}
                                                <span class="badge bg-success">{{ asset.status }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ asset.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>¥{{ asset.total_invested }}</td>
                                            <td>¥{{ asset.current_value }}</td>
                                            <td
                                                class="{% if asset.profit_loss_float >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ¥{{ asset.profit_loss }}
                                            </td>
                                            <td
                                                class="{% if asset.return_percent_float >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ asset.return_percent }}%
                                            </td>
                                            <td
                                                class="{% if asset.xirr_float and asset.xirr_float >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {% if asset.xirr %}{{ asset.xirr }}%{% else %}N/A{% endif %}
                                            </td>
                                            <td>
                                                {% if asset.performance_status == 'Excellent' %}
                                                <span class="badge bg-success">{{ asset.performance_status }}</span>
                                                {% elif asset.performance_status == 'Good' %}
                                                <span class="badge bg-info">{{ asset.performance_status }}</span>
                                                {% elif asset.performance_status == 'Average' %}
                                                <span class="badge bg-warning">{{ asset.performance_status }}</span>
                                                {% else %}
                                                <span class="badge bg-danger">{{ asset.performance_status }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- XIRR Diagnostics Section -->
                <div class="row mb-5 mt-5">
                    <div class="col-12">
                        <h2 class="section-title d-flex align-items-center">
                            <span>{{ _('XIRR Diagnostics') }}</span>
                            <button id="toggleXirrBtn" class="btn btn-sm btn-outline-secondary ms-3" type="button"
                                onclick="toggleXirrDiag()">{{ _('Show Diagnostics') }}</button>
                        </h2>
                    </div>
                    <div class="col-12">
                        <div id="xirrDiagnosticsPanel" class="table-container" style="display:none;">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <strong><i class="bi bi-info-circle"></i> {{ _('XIRR Calculation Details:')
                                            }}</strong><br>
                                        {{ _('XIRR (Extended Internal Rate of Return) calculations include all cash
                                        flows: purchases, sales, dividends, and current market value.') }}
                                        {{ _('A robust Newton-Raphson method with multiple fallback approaches ensures
                                        accurate calculations even for complex cash flow patterns.') }}
                                    </div>
                                </div>
                            </div>

                            {% if xirr_diagnostics and xirr_diagnostics.calculations %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped" id="xirrDiagnosticsTable">
                                            <thead>
                                                <tr>
                                                    <th>{{ _('Asset Name') }}</th>
                                                    <th>{{ _('XIRR Result') }}</th>
                                                    <th>{{ _('Calculation Method') }}</th>
                                                    <th>{{ _('Status') }}</th>
                                                    <th>{{ _('Reason/Notes') }}</th>
                                                    <th>{{ _('Cash Flows Count') }}</th>
                                                    <th>{{ _('Period (Days)') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for diag in xirr_diagnostics.calculations %}
                                                <tr
                                                    class="{% if diag.status == 'success' %}table-success{% elif diag.status == 'warning' %}table-warning{% else %}table-danger{% endif %}">
                                                    <td><strong>{{ diag.asset_name }}</strong></td>
                                                    <td>
                                                        {% if diag.xirr %}
                                                        <span
                                                            class="{% if diag.xirr >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ "{:.2f}".format(diag.xirr * 100) }}%
                                                        </span>
                                                        {% else %}
                                                        <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge 
                                                    {% if diag.method == 'newton_raphson' %}bg-success
                                                    {% elif diag.method == 'scipy_optimization' %}bg-info
                                                    {% elif diag.method == 'simple_irr' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                            {{ diag.method|title|replace('_', ' ') }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge 
                                                    {% if diag.status == 'success' %}bg-success
                                                    {% elif diag.status == 'warning' %}bg-warning
                                                    {% else %}bg-danger{% endif %}">
                                                            {{ diag.status|title }}
                                                        </span>
                                                    </td>
                                                    <td><small class="text-muted">{{ diag.reason }}</small></td>
                                                    <td class="text-center">{{ diag.cash_flows_count }}</td>
                                                    <td class="text-center">{{ diag.period_days }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Statistics -->
                            <div class="row mt-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">{{ xirr_diagnostics.summary.successful
                                                }}</h5>
                                            <p class="card-text">{{ _('Successful') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-warning">{{ xirr_diagnostics.summary.warnings }}
                                            </h5>
                                            <p class="card-text">{{ _('Warnings') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-danger">{{ xirr_diagnostics.summary.failures }}
                                            </h5>
                                            <p class="card-text">{{ _('Failures') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-primary">{{ xirr_diagnostics.summary.total }}
                                            </h5>
                                            <p class="card-text">{{ _('Total Assets') }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                {{ _('No XIRR diagnostic data available. This may occur if no assets have sufficient
                                transaction history for XIRR calculation.') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>


            </div>

        </div>
        <!-- End of Dashboard Tab -->

        <!-- Action Compass Tab -->
        <div class="tab-pane fade" id="action-compass" role="tabpanel" aria-labelledby="action-compass-tab">

            <div class="row mb-5">
                <div class="col-12">
                    <h2 class="section-title">
                        <i class="bi bi-compass me-2"></i>{{ _('Action Compass - Actionable Insights') }}
                    </h2>
                    <p class="text-muted">{{ _('Intelligent recommendations and alerts to help you optimize your
                        investment strategy.') }}</p>
                </div>
            </div>

            <!-- PHASE 4: Market Regime Display Card -->
            {% if market_regime %}
            <div class="row mb-4">
                <div class="col-12">
                    <div
                        class="card shadow-sm border-{% if market_regime.priority == 1 %}danger{% elif market_regime.priority == 2 %}warning{% elif market_regime.priority == 3 %}success{% else %}secondary{% endif %} border-2">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h4 class="mb-2">
                                        <i class="bi bi-speedometer me-2"></i>
                                        <strong>{{ _('Current Market Regime:') }}</strong>
                                        '#50C878', // Emerald Green
                                        '#6C757D', // Professional Grey
                                        '#17A2B8', // Teal
                                        '#6F42C1', // Purple
                                        '#E83E8C', // Pink
                                        '#FFC107' // Amber
                                        ];

                                        const subClassColors = [
                                        '#2E86AB', // Ocean Blue
                                        '#3A9BC1', // Light Ocean Blue
                                        '#A23B72', // Deep Rose
                                        '#C75B8C', // Light Rose
                                        '#F18F01', // Vibrant Orange
                                        '#F4A431', // Light Orange
                                        '#C73E1D', // Brick Red
                                        '#D1604D', // Light Red
                                        '#4A90E2', // Sky Blue
                                        '#6BA3E8', // Light Sky Blue
                                        '#7ED321', // Fresh Green
                                        '#95DC51', // Light Green
                                        '#50C878', // Emerald Green
                                        '#73D398', // Light Emerald
                                        '#6C757D', // Professional Grey
                                        '#8A9196', // Light Grey
                                        '#17A2B8', // Teal
                                        '#41B5C6', // Light Teal
                                        '#6F42C1', // Purple
                                        '#8A5FCF' // Light Purple
                                        ];

                                        // Register Chart.js datalabels plugin
                                        Chart.register(ChartDataLabels);

                                        // Common chart options
                                        const chartOptions = {
                                        responsive: true,
                                        maintainAspectRatio: true,
                                        plugins: {
                                        legend: {
                                        position: 'bottom',
                                        labels: {
                                        padding: 20,
                                        usePointStyle: true,
                                        font: {
                                        size: 12
                                        }
                                        }
                                        },
                                        tooltip: {
                                        callbacks: {
                                        label: function(context) {
                                        const label = context.label || '';
                                        const value = context.formattedValue;
                                        const percentage = ((context.raw / context.dataset.data.reduce((a, b) => a + b,
                                        0)) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: function(context) {
                                        // Only show labels for slices > 3% to avoid clutter
                                        const percentage = (context.parsed / context.dataset.data.reduce((a, b) => a +
                                        b, 0)) * 100;
                                        return percentage > 3;
                                        },
                                        formatter: function(value, context) {
                                        const percentage = ((value / context.dataset.data.reduce((a, b) => a + b, 0)) *
                                        100).toFixed(1);
                                        return percentage + '%';
                                        },
                                        color: '#ffffff',
                                        font: {
                                        weight: 'bold',
                                        size: 11
                                        },
                                        textStrokeColor: '#000000',
                                        textStrokeWidth: 1
                                        }
                                        }
                                        };

                                        // Top-Level Chart
                                        const topLevelCtx = document.getElementById('topLevelChart').getContext('2d');
                                        new Chart(topLevelCtx, {
                                        type: 'doughnut',
                                        data: {
                                        labels: topLevelData.labels,
                                        datasets: [{
                                        data: topLevelData.values,
                                        backgroundColor: topLevelColors.slice(0, topLevelData.labels.length),
                                        borderWidth: 2,
                                        borderColor: '#ffffff'
                                        }]
                                        },
                                        options: chartOptions
                                        });

                                        // Sub-Class Chart
                                        const subClassCtx = document.getElementById('subClassChart').getContext('2d');
                                        new Chart(subClassCtx, {
                                        type: 'doughnut',
                                        data: {
                                        labels: subClassData.labels,
                                        datasets: [{
                                        data: subClassData.values,
                                        backgroundColor: subClassColors.slice(0, subClassData.labels.length),
                                        borderWidth: 2,
                                        borderColor: '#ffffff'
                                        }]
                                        },
                                        options: chartOptions
                                        });

                                        // Portfolio Growth Chart
                                        const portfolioGrowthData = JSON.parse('{{ portfolio_growth_json | safe }}');
                                        const portfolioGrowthCtx =
                                        document.getElementById('portfolioGrowthChart').getContext('2d');
                                        new Chart(portfolioGrowthCtx, {
                                        type: 'line',
                                        data: {
                                        labels: portfolioGrowthData.dates,
                                        datasets: [{
                                        label: 'Portfolio Value (CNY)',
                                        data: portfolioGrowthData.values,
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.4,
                                        pointBackgroundColor: '#667eea',
                                        pointBorderColor: '#ffffff',
                                        pointBorderWidth: 2,
                                        pointRadius: 4,
                                        pointHoverRadius: 6
                                        }]
                                        },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                        intersect: false,
                                        mode: 'index'
                                        },
                                        plugins: {
                                        legend: {
                                        display: false
                                        },
                                        tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: '#667eea',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        callbacks: {
                                        label: function(context) {
                                        return '¥' + context.parsed.y.toLocaleString();
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: false
                                        }
                                        },
                                        scales: {
                                        x: {
                                        grid: {
                                        display: false
                                        },
                                        ticks: {
                                        color: '#6c757d'
                                        }
                                        },
                                        y: {
                                        grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                        color: '#6c757d',
                                        callback: function(value) {
                                        return '¥' + (value / 1000000).toFixed(1) + 'M';
                                        }
                                        }
                                        }
                                        }
                                        }
                                        });

                                        // Cash Flow Stacked Chart
                                        const cashFlowData = JSON.parse('{{ cash_flow_json | safe }}');
                                        const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
                                        new Chart(cashFlowCtx, {
                                        type: 'bar',
                                        data: {
                                        labels: cashFlowData.dates,
                                        datasets: [
                                        {
                                        label: 'Income',
                                        data: cashFlowData.income,
                                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                        borderColor: 'rgba(40, 167, 69, 1)',
                                        borderWidth: 1
                                        },
                                        {
                                        label: 'Expenses',
                                        data: cashFlowData.expenses,
                                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                        borderColor: 'rgba(220, 53, 69, 1)',
                                        borderWidth: 1
                                        },
                                        {
                                        label: 'Investments',
                                        data: cashFlowData.investments,
                                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        borderWidth: 1
                                        }
                                        ]
                                        },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                        intersect: false,
                                        mode: 'index'
                                        },
                                        plugins: {
                                        legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                        usePointStyle: true,
                                        padding: 20
                                        }
                                        },
                                        tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: '#667eea',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        callbacks: {
                                        label: function(context) {
                                        const value = Math.abs(context.parsed.y);
                                        return context.dataset.label + ': ¥' + value.toLocaleString();
                                        },
                                        footer: function(tooltipItems) {
                                        let income = 0, expense = 0, investment = 0;
                                        tooltipItems.forEach(function(item) {
                                        if (item.dataset.label === 'Income') income = item.parsed.y;
                                        else if (item.dataset.label === 'Expenses') expense = Math.abs(item.parsed.y);
                                        else if (item.dataset.label === 'Investments') investment =
                                        Math.abs(item.parsed.y);
                                        });
                                        const netFlow = income - expense - investment;
                                        return 'Net Cash Flow: ¥' + netFlow.toLocaleString();
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: false
                                        }
                                        },
                                        scales: {
                                        x: {
                                        stacked: true,
                                        grid: {
                                        display: false
                                        },
                                        ticks: {
                                        color: '#6c757d'
                                        }
                                        },
                                        y: {
                                        stacked: true,
                                        grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                        color: '#6c757d',
                                        callback: function(value) {
                                        return '¥' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        }
                                        }
                                        }
                                        }
                                        });

                                        // Time-Weighted Return Chart
                                        const twrData = JSON.parse('{{ twr_json | safe }}');
                                        const twrCtx = document.getElementById('twrChart').getContext('2d');
                                        new Chart(twrCtx, {
                                        type: 'line',
                                        data: {
                                        labels: twrData.dates,
                                        datasets: [{
                                        label: 'Time-Weighted Return (%)',
                                        data: twrData.twr_values,
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.1,
                                        pointRadius: 3,
                                        pointHoverRadius: 5,
                                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                                        pointBorderColor: '#ffffff',
                                        pointBorderWidth: 2
                                        }]
                                        },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                        intersect: false,
                                        mode: 'index'
                                        },
                                        plugins: {
                                        legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                        usePointStyle: true,
                                        padding: 20
                                        }
                                        },
                                        tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: '#667eea',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        callbacks: {
                                        label: function(context) {
                                        const value = context.parsed.y;
                                        return 'TWR: ' + (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: false
                                        }
                                        },
                                        scales: {
                                        x: {
                                        grid: {
                                        display: false
                                        },
                                        ticks: {
                                        color: '#6c757d'
                                        }
                                        },
                                        y: {
                                        grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                        color: '#6c757d',
                                        callback: function(value) {
                                        return (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
                                        }
                                        }
                                        }
                                        }
                                        }
                                        });

                                        // Portfolio Drawdown History Chart
                                        const drawdownData = JSON.parse('{{ drawdown_json | safe }}');
                                        const drawdownCtx = document.getElementById('drawdownChart').getContext('2d');
                                        new Chart(drawdownCtx, {
                                        type: 'line',
                                        data: {
                                        labels: drawdownData.dates,
                                        datasets: [{
                                        label: 'Drawdown (%)',
                                        data: drawdownData.drawdown_values,
                                        borderColor: 'rgba(220, 53, 69, 1)',
                                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.1,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                                        pointBorderColor: '#ffffff',
                                        pointBorderWidth: 2
                                        }]
                                        },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                        intersect: false,
                                        mode: 'index'
                                        },
                                        plugins: {
                                        legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                        usePointStyle: true,
                                        padding: 20
                                        }
                                        },
                                        tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: '#dc3545',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        callbacks: {
                                        label: function(context) {
                                        const value = context.parsed.y;
                                        return 'Drawdown: -' + value.toFixed(2) + '%';
                                        },
                                        afterLabel: function(context) {
                                        if (drawdownData.max_drawdown_pct && context.dataIndex ===
                                        drawdownData.dates.length - 1) {
                                        return ['Max Drawdown: -' + drawdownData.max_drawdown_pct.toFixed(2) + '%'];
                                        }
                                        return [];
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: false
                                        }
                                        },
                                        scales: {
                                        x: {
                                        grid: {
                                        display: false
                                        },
                                        ticks: {
                                        color: '#6c757d'
                                        }
                                        },
                                        y: {
                                        grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                        color: '#6c757d',
                                        callback: function(value) {
                                        return '-' + value.toFixed(1) + '%';
                                        }
                                        },
                                        reverse: false
                                        }
                                        }
                                        }
                                        });

                                        // 12-Month Forecast Chart
                                        const forecastData = JSON.parse('{{ forecast_json|safe }}');
                                        const forecastCtx = document.getElementById('forecastChart').getContext('2d');
                                        new Chart(forecastCtx, {
                                        type: 'line',
                                        data: {
                                        labels: forecastData.dates,
                                        datasets: [
                                        {
                                        label: 'Income Forecast',
                                        data: forecastData.income_forecast,
                                        borderColor: 'rgba(40, 167, 69, 1)',
                                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2,
                                        pointRadius: 6
                                        },
                                        {
                                        label: 'Expenses Forecast',
                                        data: forecastData.expenses_forecast,
                                        borderColor: 'rgba(220, 53, 69, 1)',
                                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2,
                                        pointRadius: 6
                                        },
                                        {
                                        label: 'Investments Forecast',
                                        data: forecastData.investments_forecast,
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2,
                                        pointRadius: 6
                                        }
                                        ]
                                        },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                        intersect: false,
                                        mode: 'index'
                                        },
                                        plugins: {
                                        legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                        font: {
                                        size: 12
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                        }
                                        },
                                        tooltip: {
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        titleColor: '#333',
                                        bodyColor: '#333',
                                        borderColor: '#dee2e6',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        displayColors: true,
                                        callbacks: {
                                        label: function(context) {
                                        const value = Math.abs(context.parsed.y);
                                        return context.dataset.label + ': ¥' + value.toLocaleString();
                                        },
                                        afterBody: function(tooltipItems) {
                                        if (tooltipItems.length > 0) {
                                        let income = 0, expense = 0, investment = 0;
                                        tooltipItems.forEach(function(item) {
                                        if (item.dataset.label === 'Income Forecast') income = item.parsed.y;
                                        else if (item.dataset.label === 'Expenses Forecast') expense =
                                        Math.abs(item.parsed.y);
                                        else if (item.dataset.label === 'Investments Forecast') investment =
                                        Math.abs(item.parsed.y);
                                        });
                                        const netFlow = income - expense - investment;
                                        return 'Projected Net Flow: ¥' + netFlow.toLocaleString();
                                        }
                                        }
                                        }
                                        },
                                        datalabels: {
                                        display: false
                                        }
                                        },
                                        scales: {
                                        x: {
                                        grid: {
                                        display: false
                                        },
                                        ticks: {
                                        color: '#6c757d'
                                        }
                                        },
                                        y: {
                                        grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                        color: '#6c757d',
                                        callback: function(value) {
                                        return '¥' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        }
                                        }
                                        }
                                        }
                                        });

                                        // Update Forecast Summary Table
                                        const forecastSummary = calculateForecastSummary(forecastData);
                                        updateForecastSummaryTable(forecastSummary);

                                        function calculateForecastSummary(data) {
                                        const income = data.income_forecast;
                                        const expenses = data.expenses_forecast.map(x => Math.abs(x));
                                        const investments = data.investments_forecast.map(x => Math.abs(x));

                                        return {
                                        avgIncome: income.reduce((a, b) => a + b, 0) / income.length,
                                        totalIncome: income.reduce((a, b) => a + b, 0),
                                        avgExpenses: expenses.reduce((a, b) => a + b, 0) / expenses.length,
                                        totalExpenses: expenses.reduce((a, b) => a + b, 0),
                                        avgInvestments: investments.reduce((a, b) => a + b, 0) / investments.length,
                                        totalInvestments: investments.reduce((a, b) => a + b, 0)
                                        };
                                        }

                                        function updateForecastSummaryTable(summary) {
                                        document.getElementById('avgIncome').textContent = '¥' +
                                        summary.avgIncome.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('totalIncome').textContent = '¥' +
                                        summary.totalIncome.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('avgExpenses').textContent = '¥' +
                                        summary.avgExpenses.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('totalExpenses').textContent = '¥' +
                                        summary.totalExpenses.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('avgInvestments').textContent = '¥' +
                                        summary.avgInvestments.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('totalInvestments').textContent = '¥' +
                                        summary.totalInvestments.toLocaleString('en-US', {maximumFractionDigits: 0});

                                        const avgNetFlow = summary.avgIncome - summary.avgExpenses -
                                        summary.avgInvestments;
                                        const totalNetFlow = summary.totalIncome - summary.totalExpenses -
                                        summary.totalInvestments;

                                        document.getElementById('avgNetFlow').textContent = '¥' +
                                        avgNetFlow.toLocaleString('en-US', {maximumFractionDigits: 0});
                                        document.getElementById('totalNetFlow').textContent = '¥' +
                                        totalNetFlow.toLocaleString('en-US', {maximumFractionDigits: 0});
                                </div>
                                <!-- End of Dashboard Tab -->

                                <!-- Action Compass Tab -->
                                <div class="tab-pane fade" id="action-compass" role="tabpanel"
                                    aria-labelledby="action-compass-tab">

                                    <div class="row mb-5">
                                        <div class="col-12">
                                            <h2 class="section-title">
                                                <i class="bi bi-compass me-2"></i>{{ _('Action Compass - Actionable
                                                Insights') }}
                                            </h2>
                                            <p class="text-muted">{{ _('Intelligent recommendations and alerts to help
                                                you optimize your investment strategy.') }}</p>
                                        </div>
                                    </div>

                                    <!-- PHASE 4: Market Regime Display Card -->
                                    {% if market_regime %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div
                                                class="card shadow-sm border-{% if market_regime.priority == 1 %}danger{% elif market_regime.priority == 2 %}warning{% elif market_regime.priority == 3 %}success{% else %}secondary{% endif %} border-2">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-8">
                                                            <h4 class="mb-2">
                                                                <i class="bi bi-speedometer me-2"></i>
                                                                <strong>{{ _('Current Market Regime:') }}</strong>
                                                                <span
                                                                    class="badge bg-{% if market_regime.priority == 1 %}danger{% elif market_regime.priority == 2 %}warning{% elif market_regime.priority == 3 %}success{% else %}secondary{% endif %} ms-2">
                                                                    {{ market_regime.regime_name_cn }} ({{
                                                                    market_regime.regime_name }})
                                                                </span>
                                                            </h4>
                                                            <p class="text-muted mb-2">
                                                                {{
                                                                market_regime.description_cn|default(market_regime.description)
                                                                }}
                                                            </p>

                                                            {% if market_regime.matched_conditions %}
                                                            <div class="mt-3">
                                                                <small class="text-muted"><strong>{{ _('Trigger
                                                                        Conditions:') }}</strong></small>
                                                                <ul class="list-unstyled ms-3 small">
                                                                    {% if market_regime.matched_conditions.valuation_or
                                                                    %}
                                                                    <li>
                                                                        <i
                                                                            class="bi bi-check-circle-fill text-warning me-1"></i>
                                                                        {{ _('Valuation:') }}
                                                                        {% if
                                                                        market_regime.matched_conditions.valuation_or.shiller_pe.met
                                                                        %}
                                                                        {{ _('Shiller PE') }} {{
                                                                        market_regime.matched_conditions.valuation_or.shiller_pe.value
                                                                        }}
                                                                        {% endif %}
                                                                        {% if
                                                                        market_regime.matched_conditions.valuation_or.buffett_us.met
                                                                        %}
                                                                        {{ _('OR Buffett US') }} {{
                                                                        market_regime.matched_conditions.valuation_or.buffett_us.value
                                                                        }}%
                                                                        {% endif %}
                                                                    </li>
                                                                    {% endif %}
                                                                    {% if market_regime.matched_conditions.fear_greed %}
                                                                    <li>
                                                                        <i
                                                                            class="bi bi-check-circle-fill text-warning me-1"></i>
                                                                        {{ _('Fear & Greed:') }} {{
                                                                        market_regime.matched_conditions.fear_greed.value
                                                                        }}
                                                                    </li>
                                                                    {% endif %}
                                                                    {% if
                                                                    market_regime.matched_conditions.regional_divergence
                                                                    %}
                                                                    <li>
                                                                        <i
                                                                            class="bi bi-check-circle-fill text-warning me-1"></i>
                                                                        {{ _('Regional Divergence:') }} {{ _('US') }} {{
                                                                        market_regime.matched_conditions.regional_divergence.buffett_us.value
                                                                        }}% {{ _('vs China') }} {{
                                                                        market_regime.matched_conditions.regional_divergence.buffett_china.value
                                                                        }}%
                                                                    </li>
                                                                    {% endif %}
                                                                </ul>
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="col-md-4 text-end">
                                                            {% if market_regime.dynamic_targets %}
                                                            <div
                                                                class="alert alert-{% if market_regime.priority == 1 %}danger{% elif market_regime.priority == 2 %}warning{% elif market_regime.priority == 3 %}success{% else %}secondary{% endif %} mb-0">
                                                                <small><strong>{{ _('Dynamic Targets Active')
                                                                        }}</strong></small><br>
                                                                <small class="text-muted">{{ _('Allocation adjusted for
                                                                    regime') }}</small>
                                                            </div>
                                                            {% else %}
                                                            <div class="alert alert-secondary mb-0">
                                                                <small><strong>{{ _('Baseline Targets')
                                                                        }}</strong></small><br>
                                                                <small class="text-muted">{{ _('Standard allocation')
                                                                    }}</small>
                                                            </div>
                                                            {% endif %}

                                                            <small class="text-muted d-block mt-2">
                                                                <i class="bi bi-clock me-1"></i>
                                                                {{ _('Detected:') }} {{
                                                                market_regime.detection_timestamp|default('Now') }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- End Market Regime Display -->

                                    <!-- Phase 2: Multi-Dimensional Recommendations (MOVED TO TOP) -->
                                    {% if recommendations and recommendations|length > 0 %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h4 class="border-bottom pb-2 mb-3">
                                                <i class="bi bi-lightbulb me-2"></i>{{ _('Intelligent Recommendations')
                                                }}
                                                <span class="badge bg-primary ms-2">{{ recommendations|length }}</span>
                                            </h4>
                                            <p class="text-muted mb-3">
                                                {{ _('Personalized, actionable recommendations based on your current
                                                portfolio state, performance metrics, and market conditions.') }}
                                            </p>
                                        </div>
                                    </div>

                                    <div class="row g-4 mb-5" id="recommendationsGrid">
                                        {% for rec in recommendations|sort(attribute='priority', reverse=True) %}
                                        <div class="col-lg-6 col-md-12">
                                            <!-- PHASE 6.2.3: Apply strategic-card class conditionally -->
                                            <div
                                                class="card recommendation-card h-100 shadow-sm
                                    {% if rec.type == 'STRATEGIC_REGIME' %}strategic-card{% endif %}
                                    {% if rec.priority >= 80 %}border-danger border-3{% elif rec.priority >= 60 %}border-warning border-3{% else %}border-info border-2{% endif %}">

                                                <!-- Card Header -->
                                                <!-- PHASE 7.1: Fixed header text visibility - simplified CSS logic -->
                                                <div
                                                    class="card-header 
                                        {% if rec.priority >= 80 %}bg-danger{% elif rec.priority >= 60 %}bg-warning{% else %}bg-info{% endif %}">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h5
                                                            class="mb-0 {% if rec.priority >= 60 and rec.priority < 80 %}text-dark{% else %}text-white{% endif %}">
                                                            <!-- PHASE 6.2.1: Strategic Recommendation Badge - REDUCED SIZE -->
                                                            {% if rec.type == 'STRATEGIC_REGIME' %}
                                                            <span
                                                                class="badge bg-warning text-dark fw-bold me-2 strategic-badge"
                                                                style="padding: 0.3em 0.6em; font-size: 0.85rem;"
                                                                title="Strategic recommendation from market regime">⭐ {{
                                                                _('STRATEGIC') }}</span>
                                                            {% endif %}
                                                            <span class="me-2">{{ rec.icon|default('📌') }}</span>
                                                            {{ rec.title_cn }}
                                                        </h5>
                                                        <span
                                                            class="badge 
                                                {% if rec.priority >= 80 %}bg-dark{% elif rec.priority >= 60 %}bg-secondary{% else %}bg-dark{% endif %}">
                                                            {{ _('Priority:') }} {{ rec.priority }}
                                                        </span>
                                                    </div>
                                                    <small
                                                        class="d-block mt-1 {% if rec.priority >= 60 and rec.priority < 80 %}text-dark opacity-75{% else %}text-white opacity-75{% endif %}">{{
                                                        rec.title }}</small>
                                                </div>

                                                <!-- Card Body -->
                                                <!-- PHASE 6.2.2: Add explicit background and text colors -->
                                                <div class="card-body" style="background-color: white;">
                                                    <p class="text-muted" style="color: #6c757d !important;">{{
                                                        rec.description_cn|default(rec.description) }}</p>

                                                    <!-- Impact Metrics -->
                                                    <div class="row mb-3">
                                                        {% if rec.impact.dollar_value %}
                                                        <div class="col-6">
                                                            <small class="text-muted">{{ _('Financial Impact')
                                                                }}</small>
                                                            <div class="h5">¥{{
                                                                '{:,.0f}'.format(rec.impact.dollar_value) }}</div>
                                                        </div>
                                                        {% endif %}
                                                        {% if rec.impact.risk_reduction %}
                                                        <div class="col-6">
                                                            <small class="text-muted">{{ _('Risk Reduction') }}</small>
                                                            <div class="h5">
                                                                <span class="badge 
                                                        {% if rec.impact.risk_reduction == 'HIGH' %}bg-success
                                                        {% elif rec.impact.risk_reduction == 'MEDIUM' %}bg-warning
                                                        {% else %}bg-secondary{% endif %}">
                                                                    {{ rec.impact.risk_reduction }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                        {% if rec.impact.drift_reduction %}
                                                        <div class="col-6">
                                                            <small class="text-muted">{{ _('Drift Reduction') }}</small>
                                                            <div class="h5">{{
                                                                '{:.1f}'.format(rec.impact.drift_reduction) }}%</div>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Action Items -->
                                                    {% if rec.action_items and rec.action_items|length > 0 %}
                                                    <h6 class="border-bottom pb-2 mb-2">
                                                        <i class="bi bi-list-check me-1"></i>{{ _('Action Steps:') }}
                                                    </h6>
                                                    <ol class="mb-3">
                                                        {% for action in rec.action_items %}
                                                        <!-- PHASE 6.2.2: Add explicit text colors to action items -->
                                                        <li class="mb-2" style="color: #212529;">
                                                            <strong style="color: #212529;">{{ action.action }}</strong>
                                                            {% if action.amount %}
                                                            <span class="badge bg-secondary">¥{{
                                                                '{:,.0f}'.format(action.amount) }}</span>
                                                            {% endif %}
                                                            <br>
                                                            <small class="text-muted"
                                                                style="color: #6c757d !important;">{{ action.rationale
                                                                }}</small>
                                                        </li>
                                                        {% endfor %}
                                                    </ol>
                                                    {% endif %}

                                                    <!-- Product Recommendations (Phase 3) -->
                                                    {% if rec.product_recommendations and
                                                    rec.product_recommendations|length > 0 %}
                                                    <div class="accordion mb-3" id="productAccordion{{ rec.id }}">
                                                        <div class="accordion-item border-0">
                                                            <h6 class="accordion-header"
                                                                id="productHeading{{ rec.id }}">
                                                                <button class="accordion-button collapsed bg-light"
                                                                    type="button" data-bs-toggle="collapse"
                                                                    data-bs-target="#productCollapse{{ rec.id }}"
                                                                    aria-expanded="false"
                                                                    aria-controls="productCollapse{{ rec.id }}">
                                                                    <i class="bi bi-cart-check me-2"></i>
                                                                    <strong>{{ _('Specific Product Recommendations') }}
                                                                        ({{ rec.product_recommendations|length }} {{
                                                                        _('asset classes') }})</strong>
                                                                </button>
                                                            </h6>
                                                            <div id="productCollapse{{ rec.id }}"
                                                                class="accordion-collapse collapse"
                                                                aria-labelledby="productHeading{{ rec.id }}"
                                                                data-bs-parent="#productAccordion{{ rec.id }}">
                                                                <div class="accordion-body bg-white">
                                                                    {% for prod_rec in rec.product_recommendations %}
                                                                    <div
                                                                        class="product-recommendation-section mb-4 pb-3 border-bottom">
                                                                        <h6 class="text-primary">
                                                                            {{ prod_rec.asset_class }} ({{
                                                                            prod_rec.asset_class_en }})
                                                                            <span class="badge bg-primary ms-2">¥{{
                                                                                '{:,.0f}'.format(prod_rec.amount)
                                                                                }}</span>
                                                                        </h6>
                                                                        <p class="text-muted small mb-3">
                                                                            <i class="bi bi-lightbulb me-1"></i>{{
                                                                            prod_rec.strategy }}
                                                                        </p>

                                                                        {% if prod_rec.products and
                                                                        prod_rec.products|length > 0 %}
                                                                        <div class="products-list">
                                                                            {% for product in prod_rec.products %}
                                                                            <div
                                                                                class="card mb-2 border-start border-3 
                                                                    {% if product.priority == 'high' %}border-success{% else %}border-info{% endif %}">
                                                                                <div class="card-body p-3">
                                                                                    <div
                                                                                        class="d-flex justify-content-between align-items-start mb-2">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                {{ product.sequence }}.
                                                                                                {{ product.name }}
                                                                                                {% if
                                                                                                product.is_existing %}
                                                                                                <span
                                                                                                    class="badge bg-secondary text-white">{{
                                                                                                    _('Current Holding')
                                                                                                    }}</span>
                                                                                                {% else %}
                                                                                                <span
                                                                                                    class="badge bg-success">{{
                                                                                                    _('New Suggestion')
                                                                                                    }}</span>
                                                                                                {% endif %}
                                                                                            </h6>
                                                                                            {% if product.code %}
                                                                                            <small class="text-muted">{{
                                                                                                _('Code:') }} {{
                                                                                                product.code }}</small>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                        <span class="badge 
                                                                                {% if 'high' in product.priority.lower() %}bg-success
                                                                                {% else %}bg-info{% endif %}">
                                                                                            {{ product.priority|upper }}
                                                                                        </span>
                                                                                    </div>

                                                                                    <div class="row g-2 small mb-2">
                                                                                        <div class="col-6">
                                                                                            <i
                                                                                                class="bi bi-graph-up text-success me-1"></i>
                                                                                            <strong>{{ _('Yield:')
                                                                                                }}</strong> {{
                                                                                            product.yield_estimate }}
                                                                                        </div>
                                                                                        <div class="col-6">
                                                                                            <i
                                                                                                class="bi bi-shield text-warning me-1"></i>
                                                                                            <strong>{{ _('Risk:')
                                                                                                }}</strong> {{
                                                                                            product.risk_level }}
                                                                                        </div>
                                                                                        <div class="col-6">
                                                                                            <i
                                                                                                class="bi bi-clock text-info me-1"></i>
                                                                                            <strong>{{ _('Liquidity:')
                                                                                                }}</strong> {{
                                                                                            product.liquidity }}
                                                                                        </div>
                                                                                        <div class="col-6">
                                                                                            <i
                                                                                                class="bi bi-coin text-primary me-1"></i>
                                                                                            <strong>{{ _('Min:')
                                                                                                }}</strong> {{
                                                                                            product.min_investment }}
                                                                                        </div>
                                                                                    </div>

                                                                                    <p class="mb-2 small">
                                                                                        <i
                                                                                            class="bi bi-lightbulb-fill text-warning me-1"></i>
                                                                                        <strong>{{ _('Rationale:')
                                                                                            }}</strong> {{
                                                                                        product.rationale }}
                                                                                    </p>

                                                                                    {% if product.execution_steps and
                                                                                    product.execution_steps|length > 0
                                                                                    %}
                                                                                    <div
                                                                                        class="mt-2 p-2 bg-light rounded">
                                                                                        <strong class="small">{{ _('How
                                                                                            to Execute:') }}</strong>
                                                                                        <ol
                                                                                            class="mb-0 mt-1 ps-3 small">
                                                                                            {% for step in
                                                                                            product.execution_steps %}
                                                                                            <li>{{ step }}</li>
                                                                                            {% endfor %}
                                                                                        </ol>
                                                                                    </div>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                        {% endif %}

                                                                        {% if prod_rec.sub_class_breakdown and
                                                                        prod_rec.sub_class_breakdown|length > 0 %}
                                                                        <div class="mt-3 p-2 bg-light rounded">
                                                                            <strong class="small">{{ _('Sub-Class
                                                                                Breakdown:') }}</strong>
                                                                            <ul class="mb-0 mt-1 ps-3 small">
                                                                                {% for sub in
                                                                                prod_rec.sub_class_breakdown %}
                                                                                <li>{{ sub.sub_class }}: ¥{{
                                                                                    '{:,.0f}'.format(sub.amount) }} ({{
                                                                                    '{:.1f}'.format(sub.percentage) }}%)
                                                                                </li>
                                                                                {% endfor %}
                                                                            </ul>
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}

                                                    <!-- Footer Info -->
                                                    <div
                                                        class="d-flex justify-content-between align-items-center flex-wrap">
                                                        {% if rec.estimated_effort %}
                                                        <span class="badge bg-light text-dark mb-1">
                                                            <i class="bi bi-clock me-1"></i>{{ rec.estimated_effort }}
                                                        </span>
                                                        {% endif %}
                                                        {% if rec.category %}
                                                        <span class="badge bg-light text-dark mb-1">
                                                            <i class="bi bi-tag me-1"></i>{{ rec.category }}
                                                        </span>
                                                        {% endif %}
                                                        {% if rec.urgency %}
                                                        <span class="badge 
                                                {% if rec.urgency == 'HIGH' %}bg-danger
                                                {% elif rec.urgency == 'MEDIUM' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %} mb-1">
                                                            <i class="bi bi-exclamation-triangle me-1"></i>{{
                                                            rec.urgency }}
                                                        </span>
                                                        {% endif %}
                                                        {% if rec.tax_implications %}
                                                        <span class="badge bg-warning text-dark mb-1"
                                                            data-bs-toggle="tooltip" data-bs-placement="top"
                                                            title="{{ rec.tax_implications }}">
                                                            <i class="bi bi-info-circle me-1"></i>{{ _('Tax Impact') }}
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <!-- Recommendation Statistics -->
                                    {% if recommendation_stats %}
                                    <div class="row mb-5">
                                        <div class="col-12">
                                            <div class="card border-0 shadow-sm bg-light">
                                                <div class="card-body p-4">
                                                    <h5 class="mb-4">
                                                        <i class="bi bi-graph-up me-2"></i>{{ _('Recommendation
                                                        Summary') }}
                                                    </h5>
                                                    <div class="row g-4">
                                                        <div class="col-lg-3 col-md-6 col-sm-6">
                                                            <div class="text-center">
                                                                <small class="text-muted d-block mb-2">{{ _('Total
                                                                    Recommendations') }}</small>
                                                                <div class="h3 mb-0 text-primary">{{
                                                                    recommendation_stats.total_count }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-md-6 col-sm-6">
                                                            <div class="text-center">
                                                                <small class="text-muted d-block mb-2">{{ _('High
                                                                    Priority') }}</small>
                                                                <div class="h3 mb-0 text-danger">{{
                                                                    recommendation_stats.high_priority_count }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-md-6 col-sm-6">
                                                            <div class="text-center">
                                                                <small class="text-muted d-block mb-2">{{ _('Total
                                                                    Potential Impact') }}</small>
                                                                <div class="h3 mb-0 text-success">¥{{
                                                                    '{:,.0f}'.format(recommendation_stats.total_potential_impact)
                                                                    }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-md-6 col-sm-6">
                                                            <div class="text-center">
                                                                <small class="text-muted d-block mb-2">{{ _('Average
                                                                    Priority') }}</small>
                                                                <div class="h3 mb-0 text-info">{{
                                                                    '{:.0f}'.format(recommendation_stats.avg_priority)
                                                                    }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- End Phase 2 Recommendations -->

                                    <!-- PHASE 7.2.2 + 7.3.2: Tactical Rebalancing Analysis Section - Moved from Dashboard -->
                                    <div class="row mb-5">
                                        <div class="col-12">
                                            <h3 class="section-title border-bottom pb-3 mb-4">
                                                <i class="bi bi-graph-up-arrow me-2"></i>{{ _('Tactical Rebalancing
                                                Analysis') }}
                                            </h3>

                                            <!-- Info Alert: Strategic vs Tactical Recommendations -->
                                            <div class="alert alert-primary border-start border-primary border-4 mb-4"
                                                role="alert">
                                                <div class="d-flex align-items-start">
                                                    <i class="bi bi-info-circle-fill me-3 mt-1"
                                                        style="font-size: 1.5rem;"></i>
                                                    <div>
                                                        <h5 class="alert-heading mb-2">{{ _('Understanding Strategic vs
                                                            Tactical Recommendations') }}</h5>
                                                        <p class="mb-2">
                                                            <strong>{{ _('Strategic Recommendations (above):')
                                                                }}</strong> {{ _('Market regime-based advice driven by
                                                            macroeconomic conditions,') }}
                                                            {{ _('valuation metrics, and sentiment indicators. These
                                                            provide high-level guidance on overall portfolio
                                                            positioning') }}
                                                            {{ _('and asset class selection based on market cycles.') }}
                                                        </p>
                                                        <p class="mb-0">
                                                            <strong>{{ _('Tactical Rebalancing Analysis (below):')
                                                                }}</strong> {{ _('Drift-based guidance comparing your
                                                            current allocation') }}
                                                            {{ _('against target weights. These recommendations focus on
                                                            maintaining portfolio discipline and risk management') }}
                                                            {{ _('by rebalancing when allocations deviate significantly
                                                            from your investment strategy.') }}
                                                        </p>
                                                        <hr class="my-3">
                                                        <p class="mb-0 small">
                                                            <i class="bi bi-lightbulb me-1"></i><strong>{{ _('Best
                                                                Practice:') }}</strong> {{ _('Use strategic
                                                            recommendations for new capital') }}
                                                            {{ _('deployment and market-timing decisions. Use tactical
                                                            rebalancing for portfolio maintenance and risk control.') }}
                                                            {{ _('When they conflict, consider your investment timeline
                                                            and market conditions to determine the appropriate
                                                            balance.') }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sub-Section: Rebalancing Overview -->
                                        <div class="col-12 mb-4">
                                            <div class="table-container">
                                                <h4 class="section-title d-flex align-items-center">
                                                    <span>{{ _('Rebalancing Overview') }}</span>
                                                    <button id="toggleRebalancingBtn"
                                                        class="btn btn-sm btn-outline-secondary ms-3" type="button"
                                                        onclick="toggleRebalancing()">{{ _('Hide') }}</button>
                                                </h4>
                                                <div id="rebalancingPanel">
                                                    <p class="text-muted mb-3">
                                                        {{ _('The following recommendations are based on the
                                                        rebalanceable portion of your portfolio.') }}
                                                        {{ _('Assets such as Real Estate and Insurance are excluded from
                                                        this calculation.') }}
                                                    </p>

                                                    <!-- Portfolio Value Differences Explanation -->
                                                    <div class="alert alert-info mb-4">
                                                        <h6><i class="bi bi-info-circle"></i> {{ _('Portfolio Value
                                                            Differences Explained') }}</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p class="mb-2"><strong>{{ _('Balance Sheet Total:') }}
                                                                        ¥{{
                                                                        '{:,.0f}'.format(total_portfolio_value_numeric)
                                                                        }}</strong></p>
                                                                <small class="text-muted">{{ _('Includes all assets from
                                                                    your balance sheet (real estate, insurance,
                                                                    investments, cash, etc.)') }}</small>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <p class="mb-2"><strong>{{ _('Rebalancing Total:') }}
                                                                        ¥{{
                                                                        '{:,.0f}'.format(rebalancing_data.total_portfolio_value)
                                                                        }}</strong></p>
                                                                <small class="text-muted">{{ _('Excludes
                                                                    non-rebalanceable assets like real estate') }} (¥{{
                                                                    '{:,.0f}'.format(rebalancing_data.non_rebalanceable_value)
                                                                    }}) {{ _('and insurance assets') }}</small>
                                                            </div>
                                                        </div>
                                                        <hr class="my-2">
                                                        <p class="mb-0 small">
                                                            <strong>{{ _('Note:') }}</strong> {{ _('Performance analysis
                                                            tables exclude insurance assets') }} (¥{{
                                                            '{:,.0f}'.format(insurance_value) }}) {{ _('per policy
                                                            configuration,') }}
                                                            {{ _('while rebalancing analysis additionally excludes real
                                                            estate as it\'s marked non-rebalanceable.') }}
                                                        </p>
                                                    </div>

                                                    <div class="row text-center">
                                                        <div class="col-md-4">
                                                            <div class="kpi-card">
                                                                <div class="kpi-value">¥{{
                                                                    '{:,.0f}'.format(rebalancing_data.total_portfolio_value)
                                                                    }}</div>
                                                                <div class="kpi-label">{{ _('Total Portfolio Value') }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="kpi-card">
                                                                <div class="kpi-value">¥{{
                                                                    '{:,.0f}'.format(rebalancing_data.non_rebalanceable_value)
                                                                    }}</div>
                                                                <div class="kpi-label">{{ _('Non-Rebalanceable Assets')
                                                                    }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="kpi-card">
                                                                <div class="kpi-value">¥{{
                                                                    '{:,.0f}'.format(rebalancing_data.rebalanceable_value)
                                                                    }}</div>
                                                                <div class="kpi-label">{{ _('Rebalanceable
                                                                    Sub-Portfolio') }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sub-Section: Rebalancing Analysis -->
                                            <div class="col-12 mb-4">
                                                <div class="table-container">
                                                    <h4 class="section-title">{{ _('Rebalancing Drift Analysis') }}</h4>
                                                    <p class="text-muted mb-3">
                                                        {{ _('Two-level analysis showing drift for both top-level asset
                                                        classes and sub-categories, with targets based on the Growth
                                                        strategy profile.') }}
                                                    </p>

                                                    <!-- Top-Level Classes Table -->
                                                    <h5 class="mb-3">{{ _('Top-Level Asset Classes') }}</h5>
                                                    <div class="table-responsive mb-4">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>{{ _('Asset Class') }}</th>
                                                                    <th class="text-end">{{ _('Current %') }}</th>
                                                                    <th class="text-end">{{ _('Target %') }}</th>
                                                                    <th class="text-end">{{ _('Drift') }}</th>
                                                                    <th class="text-end">{{ _('Current Value') }}</th>
                                                                    <th class="text-end">{{ _('Target Value') }}</th>
                                                                    <th class="text-center">{{ _('Status') }}</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for item in rebalancing_data.top_level_table %}
                                                                <tr
                                                                    class="{% if item.drift|abs > 10 %}bg-danger bg-opacity-10{% elif item.drift|abs > 5 %}bg-warning bg-opacity-10{% endif %}">
                                                                    <td><strong>{{ item.asset_class }}</strong></td>
                                                                    <td class="text-end">{{
                                                                        '{:.1f}'.format(item.current_pct) }}%</td>
                                                                    <td class="text-end">{{
                                                                        '{:.1f}'.format(item.target_pct) }}%</td>
                                                                    <td
                                                                        class="text-end {% if item.drift > 0 %}text-success{% elif item.drift < 0 %}text-danger{% endif %}">
                                                                        {{ '{:+.1f}'.format(item.drift) }}%
                                                                    </td>
                                                                    <td class="text-end">¥{{
                                                                        '{:,.0f}'.format(item.current_value) }}</td>
                                                                    <td class="text-end">¥{{
                                                                        '{:,.0f}'.format(item.target_value) }}</td>
                                                                    <td class="text-center">
                                                                        {% if not item.is_rebalanceable %}
                                                                        <span class="badge bg-secondary">{{
                                                                            _('Non-Rebalanceable') }}</span>
                                                                        {% elif item.target_pct == 0 %}
                                                                        <!-- Special case: zero target, use absolute drift -->
                                                                        {% if item.drift|abs > 10 %}
                                                                        <span class="badge bg-danger">{{ _('High Risk')
                                                                            }}</span>
                                                                        {% elif item.drift|abs > 5 %}
                                                                        <span class="badge bg-warning">{{ _('Medium
                                                                            Risk') }}</span>
                                                                        {% else %}
                                                                        <span class="badge bg-success">{{ _('On Target')
                                                                            }}</span>
                                                                        {% endif %}
                                                                        {% else %}
                                                                        <!-- Normal case: relative drift from target -->
                                                                        {% set relative_drift = (item.drift|abs /
                                                                        item.target_pct * 100) %}
                                                                        {% if relative_drift > 50 %}
                                                                        <span class="badge bg-danger">{{ _('High Risk')
                                                                            }}</span>
                                                                        {% elif relative_drift > 25 %}
                                                                        <span class="badge bg-warning">{{ _('Medium
                                                                            Risk') }}</span>
                                                                        {% else %}
                                                                        <span class="badge bg-success">{{ _('On Target')
                                                                            }}</span>
                                                                        {% endif %}
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <!-- Sub-Classes Table -->
                                                    <h5 class="mb-3">{{ _('Sub-Class Breakdown') }}</h5>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>{{ _('Top-Level Class') }}</th>
                                                                    <th>{{ _('Sub-Category') }}</th>
                                                                    <th class="text-end">{{ _('Current %') }}</th>
                                                                    <th class="text-end">{{ _('Target %') }}</th>
                                                                    <th class="text-end">{{ _('Drift') }}</th>
                                                                    <th class="text-end">{{ _('Current Value') }}</th>
                                                                    <th class="text-end">{{ _('Target Value') }}</th>
                                                                    <th class="text-center">{{ _('Status') }}</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for item in rebalancing_data.sub_level_table %}
                                                                <tr
                                                                    class="{% if item.drift|abs > 10 %}bg-danger bg-opacity-10{% elif item.drift|abs > 5 %}bg-warning bg-opacity-10{% endif %}">
                                                                    <td class="text-muted">{{ item.asset_class }}</td>
                                                                    <td><strong>{{ item.sub_category }}</strong></td>
                                                                    <td class="text-end">{{
                                                                        '{:.1f}'.format(item.current_pct) }}%</td>
                                                                    <td class="text-end">{{
                                                                        '{:.1f}'.format(item.target_pct) }}%</td>
                                                                    <td
                                                                        class="text-end {% if item.drift > 0 %}text-success{% elif item.drift < 0 %}text-danger{% endif %}">
                                                                        {{ '{:+.1f}'.format(item.drift) }}%
                                                                    </td>
                                                                    <td class="text-end">¥{{
                                                                        '{:,.0f}'.format(item.current_value) }}</td>
                                                                    <td class="text-end">¥{{
                                                                        '{:,.0f}'.format(item.target_value) }}</td>
                                                                    <td class="text-center">
                                                                        {% if not item.is_rebalanceable %}
                                                                        <span class="badge bg-secondary">{{
                                                                            _('Non-Rebalanceable') }}</span>
                                                                        {% elif item.target_pct == 0 %}
                                                                        <!-- Special case: zero target, use absolute drift -->
                                                                        {% if item.drift|abs > 10 %}
                                                                        <span class="badge bg-danger">{{ _('High Risk')
                                                                            }}</span>
                                                                        {% elif item.drift|abs > 5 %}
                                                                        <span class="badge bg-warning">{{ _('Medium
                                                                            Risk') }}</span>
                                                                        {% else %}
                                                                        <span class="badge bg-success">{{ _('On Target')
                                                                            }}</span>
                                                                        {% endif %}
                                                                        {% else %}
                                                                        <!-- Normal case: relative drift from target -->
                                                                        {% set relative_drift = (item.drift|abs /
                                                                        item.target_pct * 100) %}
                                                                        {% if relative_drift > 50 %}
                                                                        <span class="badge bg-danger">{{ _('High Risk')
                                                                            }}</span>
                                                                        {% elif relative_drift > 25 %}
                                                                        <span class="badge bg-warning">{{ _('Medium
                                                                            Risk') }}</span>
                                                                        {% else %}
                                                                        <span class="badge bg-success">{{ _('On Target')
                                                                            }}</span>
                                                                        {% endif %}
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sub-Section: Recommended Actions -->
                                            <div class="col-12 mb-4">
                                                <div class="table-container">
                                                    <h4 class="section-title">{{ _('Recommended Actions') }}</h4>

                                                    {% if rebalancing_data.needs_rebalancing and
                                                    rebalancing_data.hierarchical_recommendations %}
                                                    <div class="alert alert-info" role="alert">
                                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                                        <strong>{{ _('Rebalancing Recommended:') }}</strong> {{ _('Your
                                                        portfolio has drifted from target allocations. Consider the
                                                        following hierarchical actions:') }}
                                                    </div>

                                                    <!-- Hierarchical Recommendations -->
                                                    <div class="recommendation-hierarchy">
                                                        {% for recommendation in
                                                        rebalancing_data.hierarchical_recommendations %}
                                                        <div class="card mb-3 recommendation-card">
                                                            <div class="card-header bg-light">
                                                                <h5 class="mb-0 d-flex align-items-center">
                                                                    <span class="me-2">{{ recommendation.icon }}</span>
                                                                    <strong>{{ recommendation.action_text }} ¥{{
                                                                        "{:,.0f}".format(recommendation.total_amount) }}
                                                                        {{ _('的') }} {{
                                                                        recommendation.top_level_category }}</strong>
                                                                    <span
                                                                        class="badge bg-{% if recommendation.action_type == 'buy' %}success{% else %}warning{% endif %} ms-2">
                                                                        {% if recommendation.drift > 0 %}+{% endif %}{{
                                                                        "{:.1f}".format(recommendation.drift) }}% {{
                                                                        _('偏移') }}
                                                                    </span>
                                                                </h5>
                                                            </div>

                                                            <div class="card-body">
                                                                <div class="sub-recommendations">
                                                                    {% for sub_rec in recommendation.sub_recommendations
                                                                    %}
                                                                    <div
                                                                        class="sub-recommendation-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                                        <div class="sub-action-details">
                                                                            <i
                                                                                class="bi bi-{% if sub_rec.action == '买入' %}arrow-up-circle text-success{% else %}arrow-down-circle text-warning{% endif %} me-2"></i>
                                                                            <span class="fw-medium">{{ sub_rec.action }}
                                                                                ¥{{ "{:,.0f}".format(sub_rec.amount)
                                                                                }}</span>
                                                                            <span class="text-muted ms-2">{{ _('的') }}
                                                                                "{{ sub_rec.sub_category }}"</span>
                                                                        </div>
                                                                        <div class="sub-action-meta text-end">
                                                                            <small class="text-muted d-block">
                                                                                {{ _('当前持仓:') }} ¥{{
                                                                                "{:,.0f}".format(sub_rec.current_value)
                                                                                }}
                                                                            </small>
                                                                            <small class="text-muted">
                                                                                {{ _('偏移:') }} {% if sub_rec.drift > 0
                                                                                %}+{% endif %}{{
                                                                                "{:.1f}".format(sub_rec.drift) }}%
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>

                                                    <div class="mt-3">
                                                        <small class="text-muted">
                                                            <i class="bi bi-info-circle"></i>
                                                            <strong>{{ _('Implementation Notes:') }}</strong>
                                                            {{ _('Execute trades gradually to minimize market impact.
                                                            Prioritize sub-categories with larger drifts first.') }}
                                                            {{ _('Consider transaction costs and tax implications before
                                                            implementing changes.') }}
                                                            {{ _('Review your investment timeline and risk tolerance
                                                            before making significant adjustments.') }}
                                                        </small>
                                                    </div>

                                                    {% elif rebalancing_data.needs_rebalancing %}
                                                    <!-- Fallback to old format if hierarchical_recommendations not available -->
                                                    <div class="alert alert-info" role="alert">
                                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                                        <strong>{{ _('Rebalancing Recommended:') }}</strong> {{ _('Your
                                                        portfolio has drifted from target allocations. Consider the
                                                        following actions:') }}
                                                    </div>

                                                    <div class="list-group">
                                                        {% for trade in rebalancing_data.recommended_trades %}
                                                        <div
                                                            class="list-group-item d-flex justify-content-between align-items-center">
                                                            <span><i class="bi bi-arrow-right-circle text-primary"></i>
                                                                {{ trade }}</span>
                                                            <span class="badge bg-primary rounded-pill">{{ _('Action
                                                                Required') }}</span>
                                                        </div>
                                                        {% endfor %}
                                                    </div>

                                                    {% else %}
                                                    <div class="alert alert-success" role="alert">
                                                        <i class="bi bi-check-circle-fill"></i>
                                                        <strong>{{ _('Portfolio Well-Balanced:') }}</strong> {{ _('Your
                                                        current allocation is within acceptable tolerance levels.') }}
                                                        {{ _('No immediate rebalancing actions are required.') }}
                                                    </div>

                                                    <div class="mt-3">
                                                        <small class="text-muted">
                                                            <i class="bi bi-info-circle"></i>
                                                            <strong>{{ _('Maintenance:') }}</strong>
                                                            {{ _('Continue monitoring your portfolio quarterly. Consider
                                                            rebalancing if any category drifts more than 5% from target
                                                            allocation.') }}
                                                        </small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <!-- End PHASE 7.2.2 + 7.3.2: Tactical Rebalancing Analysis Section -->

                                        <!-- Module 1: Intelligent Incremental Capital Allocator -->
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header bg-primary text-white">
                                                        <h5 class="mb-0">
                                                            <i class="bi bi-calculator me-2"></i>{{ _('New Capital
                                                            Injection Simulation') }}
                                                            <span class="small">({{ _('新资金注入模拟') }})</span>
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-3">
                                                            {{ _('Simulate how new capital should be deployed to
                                                            minimize portfolio allocation drift.') }}
                                                            {{ _('The system recommends investing in the most
                                                            under-allocated asset class.') }}
                                                        </p>

                                                        {% if capital_allocation_suggestion.target_class %}
                                                        <div class="alert alert-info mb-3">
                                                            <strong><i class="bi bi-info-circle me-2"></i>{{
                                                                _('Portfolio Allocation Gaps:') }}</strong><br>
                                                            {% if proportional_allocation and
                                                            proportional_allocation.allocations|length > 1 %}
                                                            <span class="fs-6">{{
                                                                proportional_allocation.allocations|length }} {{
                                                                _('asset classes are under-allocated') }}</span>
                                                            <br>
                                                            <small class="text-muted">
                                                                {{ _('Primary gap:') }} {{
                                                                capital_allocation_suggestion.target_class }} ({{
                                                                "{:.2f}".format(capital_allocation_suggestion.drift)
                                                                }}%)
                                                            </small>
                                                            {% else %}
                                                            <span class="fs-5">{{
                                                                capital_allocation_suggestion.target_class }} ({{
                                                                capital_allocation_suggestion.target_class_en }})</span>
                                                            {{ _('is under-allocated by') }} <strong>{{
                                                                "{:.2f}".format(capital_allocation_suggestion.drift)
                                                                }}%</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                {{ _('Current:') }} {{
                                                                "{:.2f}".format(capital_allocation_suggestion.current_pct)
                                                                }}% |
                                                                {{ _('Target:') }} {{
                                                                "{:.2f}".format(capital_allocation_suggestion.target_pct)
                                                                }}%
                                                            </small>
                                                            {% endif %}
                                                        </div>

                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="newCapitalAmount" class="form-label">
                                                                    <strong>{{ _('Enter New Capital Amount (¥)')
                                                                        }}</strong>
                                                                </label>
                                                                <input type="number"
                                                                    class="form-control form-control-lg"
                                                                    id="newCapitalAmount"
                                                                    placeholder="{{ _('e.g., 50000') }}" min="0"
                                                                    step="1000">
                                                            </div>
                                                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                                                <button class="btn btn-primary btn-lg w-100"
                                                                    onclick="calculateCapitalAllocation()">
                                                                    <i class="bi bi-calculator-fill me-2"></i>{{
                                                                    _('Calculate Allocation (计算分配)') }}
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <!-- Proportional Allocation Results -->
                                                        <div id="allocationRecommendation" class="d-none mt-3">
                                                            <div class="alert alert-success" role="alert">
                                                                <h5 class="alert-heading"><i
                                                                        class="bi bi-check-circle me-2"></i>{{
                                                                    _('Recommended Proportional Allocation') }}</h5>
                                                                <p id="recommendationSummary" class="mb-2 fs-6"></p>
                                                            </div>

                                                            <div id="proportionalTable" class="table-responsive mb-3">
                                                                <!-- Will be populated by JavaScript -->
                                                            </div>

                                                            <div id="portfolioImpact" class="alert alert-light">
                                                                <h6><i class="bi bi-graph-up me-2"></i>{{ _('Portfolio
                                                                    Impact') }}</h6>
                                                                <div class="row text-center">
                                                                    <div class="col-md-4">
                                                                        <small class="text-muted">{{ _('Total Drift
                                                                            Before') }}</small>
                                                                        <div id="driftBefore" class="fs-5 fw-bold">-
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <small class="text-muted">{{ _('Total Drift
                                                                            After') }}</small>
                                                                        <div id="driftAfter"
                                                                            class="fs-5 fw-bold text-success">-</div>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <small class="text-muted">{{ _('Improvement')
                                                                            }}</small>
                                                                        <div id="driftImprovement"
                                                                            class="fs-5 fw-bold text-primary">-</div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Sub-class breakdown accordion -->
                                                            <div id="subClassAccordion" class="accordion d-none">
                                                                <!-- Will be populated by JavaScript for each asset class -->
                                                            </div>
                                                        </div> {% else %}
                                                        <div class="alert alert-warning">
                                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                                            <strong>{{ _('No allocation gap detected.') }}</strong>
                                                            {{ _('Your portfolio is currently well-balanced according to
                                                            your target allocation.') }}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Module 2: RSU Risk Management -->
                                        {% if rsu_alerts and rsu_alerts|length > 0 %}
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="card border-warning">
                                                    <div class="card-header bg-warning text-dark">
                                                        <h5 class="mb-0">
                                                            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{
                                                            _('RSU Risk Management Alerts') }}
                                                            <span class="badge bg-dark ms-2">{{ rsu_alerts|length
                                                                }}</span>
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-3">
                                                            <strong>{{ _('Automated alerts for RSU vesting events
                                                                requiring action.') }}</strong>
                                                            {{ _('Review your planned actions and ensure timely
                                                            execution.') }}
                                                        </p>

                                                        {% for alert in rsu_alerts %}
                                                        <div class="alert {% if alert.status == 'vested' %}alert-danger{% else %}alert-warning{% endif %} mb-3"
                                                            role="alert">
                                                            <h6 class="alert-heading">
                                                                {% if alert.status == 'vested' %}
                                                                ⚠️ <strong>{{ _('Action Required:') }}</strong> {{
                                                                _('Recent Vesting Event') }}
                                                                {% else %}
                                                                🔔 <strong>{{ _('Upcoming:') }}</strong> {{ _('Vesting
                                                                Event Approaching') }}
                                                                {% endif %}
                                                            </h6>
                                                            <hr>
                                                            <p class="mb-2">
                                                                {% if alert.status == 'vested' %}
                                                                {{ _('A batch of') }} <strong>{{ alert.shares
                                                                    }}</strong> {{ _('shares of') }} <strong>{{
                                                                    alert.asset_id }}</strong>
                                                                {{ _('vested on') }} <strong>{{
                                                                    alert.vesting_date.strftime('%Y-%m-%d') }}</strong>
                                                                ({{ alert.days_ago }} {{ _('days ago') }}).
                                                                {% else %}
                                                                {{ _('A batch of') }} <strong>{{ alert.shares
                                                                    }}</strong> {{ _('shares of') }} <strong>{{
                                                                    alert.asset_id }}</strong>
                                                                {{ _('will vest on') }} <strong>{{
                                                                    alert.vesting_date.strftime('%Y-%m-%d') }}</strong>
                                                                ({{ _('in') }} {{ -alert.days_ago }} {{ _('days') }}).
                                                                {% endif %}
                                                            </p>
                                                            <p class="mb-0">
                                                                <strong>{{ _('Your Plan:') }}</strong> <em>"{{
                                                                    alert.plan }}"</em>
                                                            </p>
                                                        </div>
                                                        {% endfor %}

                                                        <div class="alert alert-info mt-3 mb-0">
                                                            <small>
                                                                <i class="bi bi-info-circle me-1"></i>
                                                                <strong>{{ _('Note:') }}</strong> {{ _('RSU alerts are
                                                                configured in') }}
                                                                <code>config/rsu_schedule.yaml</code>.
                                                                {{ _('Update this file to manage your vesting schedule
                                                                and action plans.') }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header bg-light">
                                                        <h5 class="mb-0">
                                                            <i class="bi bi-check-circle me-2"></i>{{ _('RSU Risk
                                                            Management') }}
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-0">
                                                            <i class="bi bi-shield-check me-2"></i>
                                                            {{ _('No actionable RSU alerts at this time. Configure your
                                                            vesting schedule in') }}
                                                            <code>config/rsu_schedule.yaml</code> {{ _('to enable
                                                            automated alerts.') }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                    </div>
                                    <!-- End of Action Compass Tab -->

                                    <!-- Market Thermometer Tab -->
                                    <div class="tab-pane fade" id="market-thermometer" role="tabpanel"
                                        aria-labelledby="market-thermometer-tab">

                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <h2 class="section-title">
                                                    <i class="bi bi-thermometer-half me-2"></i>{{ _('Market Sentiment
                                                    Indicators') }}
                                                </h2>
                                                <p class="text-muted">
                                                    {{ _('Real-time macroeconomic indicators providing a quick
                                                    assessment of current market conditions.') }}
                                                    {{ _('Data updated:') }} {{ market_thermometer.last_updated[:10] if
                                                    market_thermometer.last_updated else 'N/A' }}
                                                </p>
                                            </div>
                                        </div> <!-- End header row -->

                                        <!-- Row 1: Shiller P/E, Fear & Greed, VIX -->
                                        <div class="row mb-5">
                                            <!-- Shiller P/E Ratio Card -->
                                            <div class="col-lg-4 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.shiller_pe.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.shiller_pe.level }}-header">
                                                        <i class="bi bi-graph-up me-2"></i>{{ _('Shiller P/E Ratio') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.shiller_pe.level }}-text">
                                                            {{ "%.2f"|format(market_thermometer.shiller_pe.value) }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.shiller_pe.level }}-text">
                                                            {{ market_thermometer.shiller_pe.zone }}
                                                        </div>
                                                        <p class="indicator-explanation">
                                                            {{ _('The Cyclically Adjusted P/E ratio measures market
                                                            valuation by comparing stock prices to 10-year average
                                                            earnings.') }}
                                                            {% if market_thermometer.shiller_pe.level == 0 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Market is
                                                            extremely undervalued.') }}
                                                            {% elif market_thermometer.shiller_pe.level == 1 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Market is
                                                            undervalued.') }}
                                                            {% elif market_thermometer.shiller_pe.level == 2 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Market is
                                                            fairly valued.') }}
                                                            {% elif market_thermometer.shiller_pe.level == 3 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Market is
                                                            overvalued.') }}
                                                            {% elif market_thermometer.shiller_pe.level == 4 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Market is
                                                            extremely overvalued.') }}
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-graph-up me-2"></i>{{ _('Shiller P/E Ratio') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-value level-error-text">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                        </div>
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                        <p class="indicator-explanation text-danger"
                                                            style="font-size: 0.85rem; word-break: break-word;">
                                                            {{ market_thermometer.shiller_pe.error_message }}
                                                        </p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Fear & Greed Index Card -->
                                            <div class="col-lg-4 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.fear_greed.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.fear_greed.level }}-header">
                                                        <i class="bi bi-bar-chart-line me-2"></i>{{ _('Fear & Greed
                                                        Index') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.fear_greed.level }}-text">
                                                            {{ "%.0f"|format(market_thermometer.fear_greed.value) }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.fear_greed.level }}-text">
                                                            {{ market_thermometer.fear_greed.zone }}
                                                        </div>
                                                        <p class="indicator-explanation">
                                                            {{ _("CNN's Fear & Greed Index measures investor sentiment
                                                            on a 0-100 scale.") }}
                                                            {% if market_thermometer.fear_greed.level == 0 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Extreme
                                                            fear - contrarian opportunity.') }}
                                                            {% elif market_thermometer.fear_greed.level == 1 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Fearful
                                                            sentiment.') }}
                                                            {% elif market_thermometer.fear_greed.level == 2 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Neutral
                                                            sentiment.') }}
                                                            {% elif market_thermometer.fear_greed.level == 3 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Greedy
                                                            sentiment.') }}
                                                            {% elif market_thermometer.fear_greed.level == 4 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Extreme
                                                            greed - high risk.') }}
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-bar-chart-line me-2"></i>{{ _('Fear & Greed
                                                        Index') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-value level-error-text">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                        </div>
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                        <p class="indicator-explanation text-danger"
                                                            style="font-size: 0.85rem; word-break: break-word;">
                                                            {{ _('API temporarily unavailable (rate limited)') }}
                                                        </p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- VIX Card -->
                                            <div class="col-lg-4 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.vix.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.vix.level }}-header">
                                                        <i class="bi bi-activity me-2"></i>{{ _('VIX (Volatility
                                                        Index)') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.vix.level }}-text">
                                                            {{ "%.2f"|format(market_thermometer.vix.value) }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.vix.level }}-text">
                                                            {{ market_thermometer.vix.zone }}
                                                        </div>
                                                        <p class="indicator-explanation">
                                                            {{ _('CBOE Volatility Index measures expected market
                                                            volatility. Higher VIX = higher fear.') }}
                                                            {% if market_thermometer.vix.level == 0 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Extreme
                                                            fear - potential opportunity.') }}
                                                            {% elif market_thermometer.vix.level == 1 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Elevated
                                                            fear - caution warranted.') }}
                                                            {% elif market_thermometer.vix.level == 2 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Normal
                                                            volatility.') }}
                                                            {% elif market_thermometer.vix.level == 3 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Low fear -
                                                            complacency risk.') }}
                                                            {% elif market_thermometer.vix.level == 4 %}
                                                            <strong>{{ _('Interpretation:') }}</strong> {{ _('Extreme
                                                            complacency - high risk.') }}
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-activity me-2"></i>{{ _('VIX (Volatility
                                                        Index)') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-value level-error-text">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                        </div>
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                        <p class="indicator-explanation text-danger"
                                                            style="font-size: 0.85rem; word-break: break-word;">
                                                            {{ market_thermometer.vix.error_message }}
                                                        </p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Row 2: International Buffett Indicators -->
                                        <div class="row mb-5">
                                            <div class="col-12 mb-3">
                                                <h4 class="text-muted"><i class="bi bi-globe me-2"></i>{{ _('Buffett
                                                    Indicator - Global View') }}</h4>
                                                <p class="text-muted small">{{ _('Total market capitalization to GDP
                                                    ratio by region') }}</p>
                                            </div>

                                            <!-- US Buffett Indicator -->
                                            <div class="col-lg-3 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.buffett_us.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.buffett_us.level }}-header">
                                                        <i class="bi bi-flag-usa me-2"></i>{{ _('United States') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.buffett_us.level }}-text">
                                                            {{ "%.1f%%"|format(market_thermometer.buffett_us.value) }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.buffett_us.level }}-text">
                                                            {{ market_thermometer.buffett_us.zone }}
                                                        </div>
                                                        <p class="indicator-explanation small mb-1">
                                                            {{ _('Data as of') }} {{ market_thermometer.buffett_us.date
                                                            if
                                                            market_thermometer.buffett_us.date else 'N/A' }} · {{
                                                            _('Source:') }}
                                                            {{ market_thermometer.buffett_us.source if
                                                            market_thermometer.buffett_us.source else _('Unknown') }}
                                                        </p>
                                                        {% if market_thermometer.buffett_us.data_age_warning %}
                                                        <p class="indicator-warning mb-0">{{
                                                            market_thermometer.buffett_us.data_age_warning }}</p>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-flag-usa me-2"></i>{{ _('United States') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- China Buffett Indicator -->
                                            <div class="col-lg-3 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.buffett_china.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.buffett_china.level }}-header">
                                                        <i class="bi bi-globe-asia-australia me-2"></i>{{ _('China') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.buffett_china.level }}-text">
                                                            {{ "%.1f%%"|format(market_thermometer.buffett_china.value)
                                                            }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.buffett_china.level }}-text">
                                                            {{ market_thermometer.buffett_china.zone }}
                                                        </div>
                                                        <p class="indicator-explanation small mb-1">
                                                            {{ _('Data as of') }} {{
                                                            market_thermometer.buffett_china.date if
                                                            market_thermometer.buffett_china.date else 'N/A' }} ·
                                                            {{ _('Source:') }} {{
                                                            market_thermometer.buffett_china.source if
                                                            market_thermometer.buffett_china.source else _('Unknown') }}
                                                        </p>
                                                        {% if market_thermometer.buffett_china.data_age_warning %}
                                                        <p class="indicator-warning mb-0">{{
                                                            market_thermometer.buffett_china.data_age_warning }}</p>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-globe-asia-australia me-2"></i>{{ _('China') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Japan Buffett Indicator -->
                                            <div class="col-lg-3 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.buffett_japan.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.buffett_japan.level }}-header">
                                                        <i class="bi bi-globe-asia-australia me-2"></i>{{ _('Japan') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.buffett_japan.level }}-text">
                                                            {{ "%.1f%%"|format(market_thermometer.buffett_japan.value)
                                                            }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.buffett_japan.level }}-text">
                                                            {{ market_thermometer.buffett_japan.zone }}
                                                        </div>
                                                        <p class="indicator-explanation small mb-1">
                                                            {{ _('Data as of') }} {{
                                                            market_thermometer.buffett_japan.date if
                                                            market_thermometer.buffett_japan.date else 'N/A' }} ·
                                                            {{ _('Source:') }} {{
                                                            market_thermometer.buffett_japan.source if
                                                            market_thermometer.buffett_japan.source else _('Unknown') }}
                                                        </p>
                                                        {% if market_thermometer.buffett_japan.data_age_warning %}
                                                        <p class="indicator-warning mb-0">{{
                                                            market_thermometer.buffett_japan.data_age_warning }}</p>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-globe-asia-australia me-2"></i>{{ _('Japan') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Europe Buffett Indicator -->
                                            <div class="col-lg-3 col-md-6 mb-4">
                                                <div class="card thermometer-card">
                                                    {% if market_thermometer.buffett_europe.status == 'success' %}
                                                    <div
                                                        class="card-header level-{{ market_thermometer.buffett_europe.level }}-header">
                                                        <i class="bi bi-globe-europe-africa me-2"></i>{{ _('Europe
                                                        (UK)') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div
                                                            class="indicator-value level-{{ market_thermometer.buffett_europe.level }}-text">
                                                            {{ "%.1f%%"|format(market_thermometer.buffett_europe.value)
                                                            }}
                                                        </div>
                                                        <div
                                                            class="indicator-zone level-{{ market_thermometer.buffett_europe.level }}-text">
                                                            {{ market_thermometer.buffett_europe.zone }}
                                                        </div>
                                                        <p class="indicator-explanation small mb-1">
                                                            {{ _('Data as of') }} {{
                                                            market_thermometer.buffett_europe.date if
                                                            market_thermometer.buffett_europe.date else 'N/A' }} ·
                                                            {{ _('Source:') }} {{
                                                            market_thermometer.buffett_europe.source if
                                                            market_thermometer.buffett_europe.source else _('Unknown')
                                                            }}
                                                        </p>
                                                        {% if market_thermometer.buffett_europe.data_age_warning %}
                                                        <p class="indicator-warning mb-0">{{
                                                            market_thermometer.buffett_europe.data_age_warning }}</p>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <div class="card-header level-error-header">
                                                        <i class="bi bi-globe-europe-africa me-2"></i>{{ _('Europe
                                                        (UK)') }}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="indicator-zone level-error-text">{{ _('Data
                                                            Unavailable') }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Information Box -->
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="thermometer-info-box">
                                                    <h5><i class="bi bi-info-circle me-2"></i>{{ _('About Market
                                                        Thermometer') }}
                                                    </h5>
                                                    <p class="mb-2">
                                                        {{ _('The Market Thermometer provides a snapshot of current
                                                        market conditions using complementary indicators:') }}
                                                    </p>
                                                    <ul class="mb-2">
                                                        <li><strong>{{ _('Shiller P/E Ratio:') }}</strong> {{
                                                            _('Long-term valuation metric smoothing short-term earnings
                                                            volatility') }}</li>
                                                        <li><strong>{{ _('Fear & Greed Index:') }}</strong> {{
                                                            _('Real-time sentiment gauge (CNN - may be rate limited)')
                                                            }}</li>
                                                        <li><strong>{{ _('VIX:') }}</strong> {{ _('Market volatility
                                                            expectations (inverse sentiment indicator)') }}</li>
                                                        <li><strong>{{ _('Buffett Indicator:') }}</strong> {{ _('Macro
                                                            valuation comparing market size to GDP by region') }}</li>
                                                    </ul>
                                                    <p class="mb-0 text-muted">
                                                        <i class="bi bi-lightbulb me-1"></i>
                                                        <strong>{{ _('Investment Tip:') }}</strong>
                                                        {{ _('Use these indicators as context, not timing signals.
                                                        Markets can remain overvalued or undervalued for extended
                                                        periods. Consider dollar-cost averaging in extreme zones.') }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <!-- End of Market Thermometer Tab -->

                                </div>
                                <!-- End of Tab Content -->

                                <!-- Bootstrap JavaScript -->
                                <script
                                    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                                <!-- Chart.js Configuration -->
                                <script>
                                    // Parse JSON data from Python
                                    const topLevelData = JSON.parse('{{ top_level_allocation_json | safe }}');
                                    const subClassData = JSON.parse('{{ sub_class_allocation_json | safe }}');

                                    // Color palettes - Professional blues, teals, greys, and greens
                                    const topLevelColors = [
                                        '#2E86AB',  // Ocean Blue
                                        '#A23B72',  // Deep Rose
                                        '#F18F01',  // Vibrant Orange
                                        '#C73E1D',  // Brick Red
                                        '#4A90E2',  // Sky Blue
                                        '#7ED321',  // Fresh Green
                                        '#50C878',  // Emerald Green
                                        '#6C757D',  // Professional Grey
                                        '#17A2B8',  // Teal
                                        '#6F42C1',  // Purple
                                        '#E83E8C',  // Pink
                                        '#FFC107'   // Amber
                                    ];

                                    const subClassColors = [
                                        '#2E86AB',  // Ocean Blue
                                        '#3A9BC1',  // Light Ocean Blue
                                        '#A23B72',  // Deep Rose
                                        '#C75B8C',  // Light Rose
                                        '#F18F01',  // Vibrant Orange
                                        '#F4A431',  // Light Orange
                                        '#C73E1D',  // Brick Red
                                        '#D1604D',  // Light Red
                                        '#4A90E2',  // Sky Blue
                                        '#6BA3E8',  // Light Sky Blue
                                        '#7ED321',  // Fresh Green
                                        '#95DC51',  // Light Green
                                        '#50C878',  // Emerald Green
                                        '#73D398',  // Light Emerald
                                        '#6C757D',  // Professional Grey
                                        '#8A9196',  // Light Grey
                                        '#17A2B8',  // Teal
                                        '#41B5C6',  // Light Teal
                                        '#6F42C1',  // Purple
                                        '#8A5FCF'   // Light Purple
                                    ];

                                    // Register Chart.js datalabels plugin
                                    Chart.register(ChartDataLabels);

                                    // Common chart options
                                    const chartOptions = {
                                        responsive: true,
                                        maintainAspectRatio: true,
                                        plugins: {
                                            legend: {
                                                position: 'bottom',
                                                labels: {
                                                    padding: 20,
                                                    usePointStyle: true,
                                                    font: {
                                                        size: 12
                                                    }
                                                }
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function (context) {
                                                        const label = context.label || '';
                                                        const value = context.formattedValue;
                                                        const percentage = ((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                                        return `${label}: ${value} (${percentage}%)`;
                                                    }
                                                }
                                            },
                                            datalabels: {
                                                display: function (context) {
                                                    // Only show labels for slices > 3% to avoid clutter
                                                    const percentage = (context.parsed / context.dataset.data.reduce((a, b) => a + b, 0)) * 100;
                                                    return percentage > 3;
                                                },
                                                formatter: function (value, context) {
                                                    const percentage = ((value / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                                    return percentage + '%';
                                                },
                                                color: '#ffffff',
                                                font: {
                                                    weight: 'bold',
                                                    size: 11
                                                },
                                                textStrokeColor: '#000000',
                                                textStrokeWidth: 1
                                            }
                                        }
                                    };

                                    // Top-Level Chart
                                    const topLevelCtx = document.getElementById('topLevelChart').getContext('2d');
                                    new Chart(topLevelCtx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: topLevelData.labels,
                                            datasets: [{
                                                data: topLevelData.values,
                                                backgroundColor: topLevelColors.slice(0, topLevelData.labels.length),
                                                borderWidth: 2,
                                                borderColor: '#ffffff'
                                            }]
                                        },
                                        options: chartOptions
                                    });

                                    // Sub-Class Chart
                                    const subClassCtx = document.getElementById('subClassChart').getContext('2d');
                                    new Chart(subClassCtx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: subClassData.labels,
                                            datasets: [{
                                                data: subClassData.values,
                                                backgroundColor: subClassColors.slice(0, subClassData.labels.length),
                                                borderWidth: 2,
                                                borderColor: '#ffffff'
                                            }]
                                        },
                                        options: chartOptions
                                    });

                                    // Portfolio Growth Chart
                                    const portfolioGrowthData = JSON.parse('{{ portfolio_growth_json | safe }}');
                                    const portfolioGrowthCtx = document.getElementById('portfolioGrowthChart').getContext('2d');
                                    new Chart(portfolioGrowthCtx, {
                                        type: 'line',
                                        data: {
                                            labels: portfolioGrowthData.dates,
                                            datasets: [{
                                                label: '{{ _('Portfolio Value(CNY)') }}',
                                                data: portfolioGrowthData.values,
                                                borderColor: '#667eea',
                                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                                borderWidth: 3,
                                                fill: true,
                                                tension: 0.4,
                                                pointBackgroundColor: '#667eea',
                                                pointBorderColor: '#ffffff',
                                                pointBorderWidth: 2,
                                                pointRadius: 4,
                                                pointHoverRadius: 6
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: {
                                                intersect: false,
                                                mode: 'index'
                                            },
                                            plugins: {
                                                legend: {
                                                    display: false
                                                },
                                                tooltip: {
                                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                    titleColor: '#ffffff',
                                                    bodyColor: '#ffffff',
                                                    borderColor: '#667eea',
                                                    borderWidth: 1,
                                                    cornerRadius: 8,
                                                    displayColors: false,
                                                    callbacks: {
                                                        label: function (context) {
                                                            return '¥' + context.parsed.y.toLocaleString();
                                                        }
                                                    }
                                                },
                                                datalabels: {
                                                    display: false
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    grid: {
                                                        display: false
                                                    },
                                                    ticks: {
                                                        color: '#6c757d'
                                                    }
                                                },
                                                y: {
                                                    grid: {
                                                        color: 'rgba(0, 0, 0, 0.1)'
                                                    },
                                                    ticks: {
                                                        color: '#6c757d',
                                                        callback: function (value) {
                                                            return '¥' + (value / 1000000).toFixed(1) + 'M';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });

                                    // Cash Flow Stacked Chart
                                    const cashFlowData = JSON.parse('{{ cash_flow_json | safe }}');
                                    const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
                                    new Chart(cashFlowCtx, {
                                        type: 'bar',
                                        data: {
                                            labels: cashFlowData.dates,
                                            datasets: [
                                                {
                                                    label: '{{ _('Income') }}',
                                                    data: cashFlowData.income,
                                                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                                    borderColor: 'rgba(40, 167, 69, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '{{ _('Expenses') }}',
                                                    data: cashFlowData.expenses,
                                                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                                    borderColor: 'rgba(220, 53, 69, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '{{ _('Investments') }}',
                                                    data: cashFlowData.investments,
                                                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                                    borderColor: 'rgba(102, 126, 234, 1)',
                                                    borderWidth: 1
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: {
                                                intersect: false,
                                                mode: 'index'
                                            },
                                            plugins: {
                                                legend: {
                                                    display: true,
                                                    position: 'top',
                                                    labels: {
                                                        usePointStyle: true,
                                                        padding: 20
                                                    }
                                                },
                                                tooltip: {
                                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                    titleColor: '#ffffff',
                                                    bodyColor: '#ffffff',
                                                    borderColor: '#667eea',
                                                    borderWidth: 1,
                                                    cornerRadius: 8,
                                                    callbacks: {
                                                        label: function (context) {
                                                            const value = Math.abs(context.parsed.y);
                                                            return context.dataset.label + ': ¥' + value.toLocaleString();
                                                        },
                                                        footer: function (tooltipItems) {
                                                            let income = 0, expense = 0, investment = 0;
                                                            tooltipItems.forEach(function (item) {
                                                                if (item.dataset.label === 'Income') income = item.parsed.y;
                                                                else if (item.dataset.label === 'Expenses') expense = Math.abs(item.parsed.y);
                                                                else if (item.dataset.label === 'Investments') investment = Math.abs(item.parsed.y);
                                                            });
                                                            const netFlow = income - expense - investment;
                                                            return '{{ _('Net Cash Flow: ') }} ¥' + netFlow.toLocaleString();
                                                        }
                                                    }
                                                },
                                                datalabels: {
                                                    display: false
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    stacked: true,
                                                    grid: {
                                                        display: false
                                                    },
                                                    ticks: {
                                                        color: '#6c757d'
                                                    }
                                                },
                                                y: {
                                                    stacked: true,
                                                    grid: {
                                                        color: 'rgba(0, 0, 0, 0.1)'
                                                    },
                                                    ticks: {
                                                        color: '#6c757d',
                                                        callback: function (value) {
                                                            return '¥' + (value / 1000).toFixed(0) + 'K';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });

                                    // Time-Weighted Return Chart
                                    const twrData = JSON.parse('{{ twr_json | safe }}');
                                    const twrCtx = document.getElementById('twrChart').getContext('2d');
                                    new Chart(twrCtx, {
                                        type: 'line',
                                        data: {
                                            labels: twrData.dates,
                                            datasets: [{
                                                label: '{{ _('Time- Weighted Return(%)') }}',
                                                data: twrData.twr_values,
                                                borderColor: 'rgba(102, 126, 234, 1)',
                                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                                borderWidth: 2,
                                                fill: true,
                                                tension: 0.1,
                                                pointRadius: 3,
                                                pointHoverRadius: 5,
                                                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                                                pointBorderColor: '#ffffff',
                                                pointBorderWidth: 2
                                            }]
                                    },
                                        options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                            intersect: false,
                                            mode: 'index'
                                        },
                                        plugins: {
                                            legend: {
                                                display: true,
                                                position: 'top',
                                                labels: {
                                                    usePointStyle: true,
                                                    padding: 20
                                                }
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                titleColor: '#ffffff',
                                                bodyColor: '#ffffff',
                                                borderColor: '#667eea',
                                                borderWidth: 1,
                                                cornerRadius: 8,
                                                callbacks: {
                                                    label: function (context) {
                                                        const value = context.parsed.y;
                                                        return '{{ _('TWR: ') }} ' + (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
                                                    }
                                                }
                                            },
                                            datalabels: {
                                                display: false
                                            }
                                        },
                                        scales: {
                                            x: {
                                                grid: {
                                                    display: false
                                                },
                                                ticks: {
                                                    color: '#6c757d'
                                                }
                                            },
                                            y: {
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.1)'
                                                },
                                                ticks: {
                                                    color: '#6c757d',
                                                    callback: function (value) {
                                                        return (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    });

                                    // Portfolio Drawdown History Chart
                                    const drawdownData = JSON.parse('{{ drawdown_json | safe }}');
                                    const drawdownCtx = document.getElementById('drawdownChart').getContext('2d');
                                    new Chart(drawdownCtx, {
                                        type: 'line',
                                        data: {
                                            labels: drawdownData.dates,
                                            datasets: [{
                                                label: '{{ _('Drawdown(%)') }}',
                                                    data: drawdownData.drawdown_values,
                                                        borderColor: 'rgba(220, 53, 69, 1)',
                                                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                                                borderWidth: 2,
                                                                    fill: true,
                                                                        tension: 0.1,
                                                                            pointRadius: 2,
                                                                                pointHoverRadius: 4,
                                                                                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                                                                                        pointBorderColor: '#ffffff',
                                                                                            pointBorderWidth: 2
                                            }]
                                        },
                                    options: {
                                        responsive: true,
                                            maintainAspectRatio: false,
                                                interaction: {
                                            intersect: false,
                                                mode: 'index'
                                        },
                                        plugins: {
                                            legend: {
                                                display: true,
                                                    position: 'top',
                                                        labels: {
                                                    usePointStyle: true,
                                                        padding: 20
                                                }
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                    titleColor: '#ffffff',
                                                        bodyColor: '#ffffff',
                                                            borderColor: '#dc3545',
                                                                borderWidth: 1,
                                                                    cornerRadius: 8,
                                                                        callbacks: {
                                                    label: function (context) {
                                                        const value = context.parsed.y;
                                                        return '{{ _('Drawdown: ') }} -' + value.toFixed(2) + '%';
                                                    },
                                                    afterLabel: function (context) {
                                                        if (drawdownData.max_drawdown_pct && context.dataIndex === drawdownData.dates.length - 1) {
                                                            return ['{{ _('Max Drawdown: ') }} -' + drawdownData.max_drawdown_pct.toFixed(2) + '%'];
                                                        }
                                                        return [];
                                                    }
                                                }
                                            },
                                            datalabels: {
                                                display: false
                                            }
                                        },
                                        scales: {
                                            x: {
                                                grid: {
                                                    display: false
                                                },
                                                ticks: {
                                                    color: '#6c757d'
                                                }
                                            },
                                            y: {
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.1)'
                                                },
                                                ticks: {
                                                    color: '#6c757d',
                                                        callback: function (value) {
                                                            return '-' + value.toFixed(1) + '%';
                                                        }
                                                },
                                                reverse: false
                                            }
                                        }
                                    }
                                    });

                                    // 12-Month Forecast Chart
                                    const forecastData = JSON.parse('{{ forecast_json | safe }}');
                                    const forecastCtx = document.getElementById('forecastChart').getContext('2d');
                                    new Chart(forecastCtx, {
                                        type: 'line',
                                        data: {
                                            labels: forecastData.dates,
                                            datasets: [
                                                {
                                                    label: '{{ _('Income Forecast') }}',
                                                    data: forecastData.income_forecast,
                                                    borderColor: 'rgba(40, 167, 69, 1)',
                                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                                    borderWidth: 3,
                                                    fill: false,
                                                    tension: 0.4,
                                                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                                                    pointBorderColor: '#fff',
                                                    pointBorderWidth: 2,
                                                    pointRadius: 6
                                                },
                                                {
                                                    label: '{{ _('Expenses Forecast') }}',
                                                    data: forecastData.expenses_forecast,
                                                    borderColor: 'rgba(220, 53, 69, 1)',
                                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                                    borderWidth: 3,
                                                    fill: false,
                                                    tension: 0.4,
                                                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                                                    pointBorderColor: '#fff',
                                                    pointBorderWidth: 2,
                                                    pointRadius: 6
                                                },
                                                {
                                                    label: '{{ _('Investments Forecast') }}',
                                                    data: forecastData.investments_forecast,
                                                    borderColor: 'rgba(102, 126, 234, 1)',
                                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                                    borderWidth: 3,
                                                    fill: false,
                                                    tension: 0.4,
                                                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                                                    pointBorderColor: '#fff',
                                                    pointBorderWidth: 2,
                                                    pointRadius: 6
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: {
                                                intersect: false,
                                                mode: 'index'
                                            },
                                            plugins: {
                                                legend: {
                                                    display: true,
                                                    position: 'top',
                                                    labels: {
                                                        font: {
                                                            size: 12
                                                        },
                                                        usePointStyle: true,
                                                        pointStyle: 'circle'
                                                    }
                                                },
                                                tooltip: {
                                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                                    titleColor: '#333',
                                                    bodyColor: '#333',
                                                    borderColor: '#dee2e6',
                                                    borderWidth: 1,
                                                    cornerRadius: 8,
                                                    displayColors: true,
                                                    callbacks: {
                                                        label: function (context) {
                                                            const value = Math.abs(context.parsed.y);
                                                            return context.dataset.label + ': ¥' + value.toLocaleString();
                                                        },
                                                        afterBody: function (tooltipItems) {
                                                            if (tooltipItems.length > 0) {
                                                                let income = 0, expense = 0, investment = 0;
                                                                tooltipItems.forEach(function (item) {
                                                                    if (item.dataset.label === 'Income Forecast') income = item.parsed.y;
                                                                    else if (item.dataset.label === 'Expenses Forecast') expense = Math.abs(item.parsed.y);
                                                                    else if (item.dataset.label === 'Investments Forecast') investment = Math.abs(item.parsed.y);
                                                                });
                                                                const netFlow = income - expense - investment;
                                                                return '{{ _('Projected Net Flow: ') }} ¥' + netFlow.toLocaleString();
                                                            }
                                                        }
                                                    }
                                                },
                                                datalabels: {
                                                    display: false
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    grid: {
                                                        display: false
                                                    },
                                                    ticks: {
                                                        color: '#6c757d'
                                                    }
                                                },
                                                y: {
                                                    grid: {
                                                        color: 'rgba(0, 0, 0, 0.1)'
                                                    },
                                                    ticks: {
                                                        color: '#6c757d',
                                                        callback: function (value) {
                                                            return '¥' + (value / 1000).toFixed(0) + 'K';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });

                                    // Update Forecast Summary Table
                                    const forecastSummary = calculateForecastSummary(forecastData);
                                    updateForecastSummaryTable(forecastSummary);

                                    function calculateForecastSummary(data) {
                                        const income = data.income_forecast;
                                        const expenses = data.expenses_forecast.map(x => Math.abs(x));
                                        const investments = data.investments_forecast.map(x => Math.abs(x));

                                        return {
                                            avgIncome: income.reduce((a, b) => a + b, 0) / income.length,
                                            totalIncome: income.reduce((a, b) => a + b, 0),
                                            avgExpenses: expenses.reduce((a, b) => a + b, 0) / expenses.length,
                                            totalExpenses: expenses.reduce((a, b) => a + b, 0),
                                            avgInvestments: investments.reduce((a, b) => a + b, 0) / investments.length,
                                            totalInvestments: investments.reduce((a, b) => a + b, 0)
                                        };
                                    }

                                    function updateForecastSummaryTable(summary) {
                                        document.getElementById('avgIncome').textContent = '¥' + summary.avgIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('totalIncome').textContent = '¥' + summary.totalIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('avgExpenses').textContent = '¥' + summary.avgExpenses.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('totalExpenses').textContent = '¥' + summary.totalExpenses.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('avgInvestments').textContent = '¥' + summary.avgInvestments.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('totalInvestments').textContent = '¥' + summary.totalInvestments.toLocaleString('en-US', { maximumFractionDigits: 0 });

                                        const avgNetFlow = summary.avgIncome - summary.avgExpenses - summary.avgInvestments;
                                        const totalNetFlow = summary.totalIncome - summary.totalExpenses - summary.totalInvestments;

                                        document.getElementById('avgNetFlow').textContent = '¥' + avgNetFlow.toLocaleString('en-US', { maximumFractionDigits: 0 });
                                        document.getElementById('totalNetFlow').textContent = '¥' + totalNetFlow.toLocaleString('en-US', { maximumFractionDigits: 0 });

                                        // Update trend indicators (simplified)
                                        document.getElementById('netFlowTrend').textContent = totalNetFlow > 0 ? '{{ _('Positive') }}' : '{{ _('Negative') }}';
                                        document.getElementById('netFlowTrend').className = totalNetFlow > 0 ? 'badge bg-success' : 'badge bg-danger';
                                    }
                                </script>

                                <!-- Gains Comparison Chart Configuration -->
                                <script>
                                    // Gains Comparison Bar Chart
                                    const gainsCtx = document.getElementById('gainsComparisonChart').getContext('2d');
                                    const gainsData = {
                                        labels: ['{{ _('Realized Gains') }}', '{{ _('Unrealized Gains') }}'],
                                        datasets: [{
                                            label: '{{ _('Gains(CNY)') }}',
                                            data: [{{ gains_analysis_data.realized_gains }}, {{ gains_analysis_data.unrealized_gains }}],
                                        backgroundColor: [
                                            'rgba(40, 167, 69, 0.8)',   // Green for realized gains
                                            'rgba(0, 123, 255, 0.8)'    // Blue for unrealized gains
                                        ],
                                        borderColor: [
                                            'rgba(40, 167, 69, 1)',
                                            'rgba(0, 123, 255, 1)'
                                        ],
                                        borderWidth: 2
            }]
        };

                                    {% if gains_analysis_data.subclass_breakdown %}
                                    // Sub-class level stacked bar chart
                                    const subclassCtx = document.getElementById('subclassGainsChart').getContext('2d');
                                    const subclassLabels = [{% for subclass in gains_analysis_data.subclass_breakdown.keys() %}'{{ subclass }}'{% if not loop.last %}, {% endif %} {% endfor %}];
                                    const realizedData = [{% for subclass, data in gains_analysis_data.subclass_breakdown.items() %}{ { data.realized_gains } } {% if not loop.last %}, {% endif %} {% endfor %}];
                                    const unrealizedData = [{% for subclass, data in gains_analysis_data.subclass_breakdown.items() %}{ { data.unrealized_gains } } {% if not loop.last %}, {% endif %} {% endfor %}];

                                    const subclassData = {
                                        labels: subclassLabels,
                                        datasets: [
                                            {
                                                label: '{{ _('Realized Gains') }}',
                                                data: realizedData,
                                                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                                borderColor: 'rgba(40, 167, 69, 1)',
                                                borderWidth: 1
                                            },
                                            {
                                                label: '{{ _('Unrealized Gains') }}',
                                                data: unrealizedData,
                                                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                                                borderColor: 'rgba(0, 123, 255, 1)',
                                                borderWidth: 1
                                            }
                                        ]
                                    };
                                    {% endif %}

                                    // Initialize main gains chart
                                    new Chart(gainsCtx, {
                                        type: 'bar',
                                        data: gainsData,
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: {
                                                    display: false
                                                },
                                                title: {
                                                    display: false
                                                },
                                                datalabels: {
                                                    display: false
                                                }
                                            },
                                            scales: {
                                                y: {
                                                    beginAtZero: true,
                                                    ticks: {
                                                        callback: function (value) {
                                                            return '¥' + new Intl.NumberFormat('zh-CN').format(value);
                                                        }
                                                    }
                                                }
                                            },
                                            interaction: {
                                                intersect: false,
                                                mode: 'index'
                                            }
                                        }
                                    });

                                    // Sortable table functionality for Lifetime Performance
                                    function sortLifetimeTable(columnIndex) {
                                        const table = document.getElementById('lifetimePerformanceTable');
                                        const tbody = table.getElementsByTagName('tbody')[0];
                                        const rows = Array.from(tbody.getElementsByTagName('tr'));

                                        // Toggle sort direction
                                        if (!table.sortDirection) table.sortDirection = {};
                                        const isAscending = !table.sortDirection[columnIndex];
                                        table.sortDirection[columnIndex] = isAscending;

                                        // Sort rows
                                        rows.sort((a, b) => {
                                            const aVal = a.getElementsByTagName('td')[columnIndex].textContent.trim();
                                            const bVal = b.getElementsByTagName('td')[columnIndex].textContent.trim();

                                            // Handle numeric columns (XIRR % and Profit/Loss)
                                            if (columnIndex === 4 || columnIndex === 5) {
                                                const aNum = parseFloat(aVal.replace(/[¥,%]/g, '')) || 0;
                                                const bNum = parseFloat(bVal.replace(/[¥,%]/g, '')) || 0;
                                                return isAscending ? aNum - bNum : bNum - aNum;
                                            }

                                            // Handle text columns
                                            return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                        });

                                        // Reappend sorted rows
                                        rows.forEach(row => tbody.appendChild(row));

                                        // Update sort icons
                                        const headers = table.getElementsByTagName('th');
                                        for (let i = 0; i < headers.length; i++) {
                                            const icon = headers[i].querySelector('i');
                                            if (icon) {
                                                icon.className = i === columnIndex ?
                                                    (isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down') :
                                                    'fas fa-sort';
                                            }
                                        }
                                    }

                                    // Initialize sub-class stacked bar chart (if data present)
                                    {% if gains_analysis_data.subclass_breakdown %}
                                    new Chart(subclassCtx, {
                                        type: 'bar',
                                        data: subclassData,
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: {
                                                    display: true,
                                                    position: 'top'
                                                },
                                                title: { display: false },
                                                datalabels: {
                                                    display: false
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    stacked: true,
                                                    ticks: { maxRotation: 45, minRotation: 0 }
                                                },
                                                y: {
                                                    stacked: true,
                                                    beginAtZero: true,
                                                    ticks: {
                                                        callback: function (value) {
                                                            return '¥' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });
                                    {% endif %}
                                </script>

                                <script>
                                    // Action Compass: Capital Allocation Calculator
                                    function calculateCapitalAllocation() {
                                        const amount = parseFloat(document.getElementById('newCapitalAmount').value);
                                        const resultDiv = document.getElementById('allocationRecommendation');
                                        const resultSummary = document.getElementById('recommendationSummary');
                                        const proportionalTable = document.getElementById('proportionalTable');
                                        const subClassAccordion = document.getElementById('subClassAccordion');

                                        if (!amount || amount <= 0) {
                                            alert('Please enter a valid capital amount greater than 0.');
                                            return;
                                        }

                                        // Get proportional allocation data from backend (if available)
                                        {% if proportional_allocation and proportional_allocation.allocations %}
                                        const proportionalData = {{ proportional_allocation | tojson
                                    }};
                                    const subClassData = {{ sub_class_breakdowns | tojson }};
                                    const rebalanceableValue = proportionalData.rebalanceable_value || 1;  // Prevent division by zero

                                    // Calculate proportional allocations based on user input
                                    const allocations = proportionalData.allocations.map(a => {
                                        const scaledAmount = amount * a.percentage / 100;
                                        // Recalculate new drift dynamically based on actual capital input
                                        const capitalImpactOnDrift = (scaledAmount / rebalanceableValue) * 100;
                                        const newDrift = a.current_drift + capitalImpactOnDrift;

                                        return {
                                            asset_class: a.asset_class,
                                            asset_class_en: a.asset_class_en,
                                            amount: scaledAmount.toFixed(2),
                                            percentage: a.percentage,
                                            new_drift: newDrift,
                                            current_drift: a.current_drift,
                                            current_pct: a.current_pct,
                                            target_pct: a.target_pct
                                        };
                                    });

                                    // Generate summary
                                    const summary = allocations.map((a, i) => {
                                        const formattedAmount = parseFloat(a.amount).toLocaleString('en-US');
                                        return `<strong>¥${formattedAmount}</strong> to ${a.asset_class} (${a.asset_class_en})`;
                                    }).join(', ');

                                    resultSummary.innerHTML = `Allocate: ${summary}`;

                                    // Build proportional allocation table
                                    let tableHtml = '<table class="table table-hover"><thead class="table-light">';
                                    tableHtml += '<tr><th>Asset Class</th><th>Amount (¥)</th><th>Percentage</th><th>Current</th><th>Target</th><th>New Drift</th></tr></thead><tbody>';

                                    allocations.forEach(a => {
                                        const formattedAmount = parseFloat(a.amount).toLocaleString('en-US');
                                        const driftClass = parseFloat(a.new_drift) < 0 ? 'text-danger' : 'text-success';
                                        tableHtml += `<tr>
                        <td><strong>${a.asset_class}</strong><br><small class="text-muted">${a.asset_class_en}</small></td>
                        <td class="fs-5">¥${formattedAmount}</td>
                        <td>${a.percentage.toFixed(1)}%</td>
                        <td>${a.current_pct.toFixed(2)}%</td>
                        <td>${a.target_pct.toFixed(2)}%</td>
                        <td class="${driftClass}">${a.new_drift.toFixed(2)}%</td>
                    </tr>`;
                                    });
                                    tableHtml += '</tbody></table>';
                                    proportionalTable.innerHTML = tableHtml;

                                    // Update portfolio impact metrics (recalculate dynamically)
                                    const driftBefore = proportionalData.total_drift_before;

                                    // Calculate new total drift by summing absolute new drifts
                                    // Note: This approximation assumes allocated classes dominate the drift
                                    const newTotalDrift = allocations.reduce((sum, a) => sum + Math.abs(a.new_drift), 0);
                                    const improvement = driftBefore - newTotalDrift;

                                    document.getElementById('driftBefore').textContent = Math.abs(driftBefore).toFixed(2) + '%';
                                    document.getElementById('driftAfter').textContent = newTotalDrift.toFixed(2) + '%';
                                    document.getElementById('driftImprovement').textContent = improvement.toFixed(2) + '%';

                                    // Build sub-class breakdown accordion (if available)
                                    if (subClassData && subClassData.length > 0) {
                                        let accordionHtml = '<h6 class="mt-3 mb-2"><i class="bi bi-diagram-3 me-2"></i>Detailed Sub-Class Breakdown</h6>';
                                        const referenceAmount = proportionalData.reference_capital || 100000;  // Get reference amount

                                        subClassData.forEach((breakdown, index) => {
                                            const assetClass = breakdown.asset_class;
                                            const totalAmount = (amount * breakdown.total_amount / referenceAmount).toFixed(2);

                                            accordionHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <strong>${assetClass}</strong> <span class="ms-2 text-muted">(¥${parseFloat(totalAmount).toLocaleString('en-US')})</span>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#subClassAccordion">
                                <div class="accordion-body">
                                    <table class="table table-sm">
                                        <thead><tr><th>Sub-Class</th><th>Amount</th><th>Priority</th><th>Drift</th><th>Rationale</th></tr></thead>
                                        <tbody>`;

                                            breakdown.sub_allocations.forEach(sub => {
                                                const subAmount = (amount * sub.amount / referenceAmount).toFixed(2);
                                                const priorityBadge = sub.priority === 'HIGH' ? 'danger' : (sub.priority === 'MEDIUM' ? 'warning' : 'secondary');
                                                accordionHtml += `<tr>
                                <td><strong>${sub.sub_class}</strong><br><small class="text-muted">${sub.sub_class_cn}</small></td>
                                <td>¥${parseFloat(subAmount).toLocaleString('en-US')} (${sub.percentage.toFixed(1)}%)</td>
                                <td><span class="badge bg-${priorityBadge}">${sub.priority}</span></td>
                                <td class="text-danger">${sub.drift.toFixed(2)}%</td>
                                <td><small>${sub.rationale}</small></td>
                            </tr>`;
                                            });

                                            accordionHtml += '</tbody></table></div></div></div>';
                                        });

                                        subClassAccordion.innerHTML = accordionHtml;
                                        subClassAccordion.classList.remove('d-none');
                                    } else {
                                        subClassAccordion.classList.add('d-none');
                                    }

                                    {% else %}
                                    // Fallback to single-class allocation
                                    const targetClass = '{{ capital_allocation_suggestion.target_class }}';
                                    const targetClassEn = '{{ capital_allocation_suggestion.target_class_en }}';

                                    const formattedAmount = amount.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });

                                    resultSummary.innerHTML = `Based on your current allocation gap, allocate the entire <strong>¥${formattedAmount}</strong> to purchase <strong>${targetClass} (${targetClassEn})</strong> assets.`;
                                    proportionalTable.innerHTML = '';
                                    document.getElementById('portfolioImpact').classList.add('d-none');
                                    subClassAccordion.classList.add('d-none');
                                    {% endif %}

                                    // Show the result
                                    resultDiv.classList.remove('d-none');
            }

                                    function toggleXirrDiag() {
                                        const panel = document.getElementById('xirrDiagnosticsPanel');
                                        const btn = document.getElementById('toggleXirrBtn');
                                        if (panel.style.display === 'none') { panel.style.display = 'block'; btn.textContent = 'Hide Diagnostics'; }
                                        else { panel.style.display = 'none'; btn.textContent = 'Show Diagnostics'; }
                                    }

                                    function toggleLifetimePerf() {
                                        const panel = document.getElementById('lifetimePerformancePanel');
                                        const btn = document.getElementById('toggleLifetimeBtn');
                                        if (panel.style.display === 'none') { panel.style.display = 'block'; btn.textContent = 'Hide Table'; }
                                        else { panel.style.display = 'none'; btn.textContent = 'Show Table'; }
                                    }

                                    function toggleRebalancing() {
                                        const panel = document.getElementById('rebalancingPanel');
                                        const btn = document.getElementById('toggleRebalancingBtn');
                                        if (panel.style.display === 'none') { panel.style.display = 'block'; btn.textContent = 'Hide'; }
                                        else { panel.style.display = 'none'; btn.textContent = 'Show'; }
                                    }

                                    function toggleSubclassGains() {
                                        const panel = document.getElementById('subclassGainsPanel');
                                        const btn = document.getElementById('toggleSubclassGainsBtn');
                                        if (panel.style.display === 'none') {
                                            panel.style.display = 'block';
                                            btn.textContent = 'Hide Details';
                                            btn.classList.remove('btn-outline-secondary');
                                            btn.classList.add('btn-secondary');
                                        } else {
                                            panel.style.display = 'none';
                                            btn.textContent = 'Show Details';
                                            btn.classList.remove('btn-secondary');
                                            btn.classList.add('btn-outline-secondary');
                                        }
                                    }

                                    // Phase 3 Enhancement: Initialize tooltips for XIRR warning indicators
                                    document.addEventListener('DOMContentLoaded', function () {
                                        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                                        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                                            return new bootstrap.Tooltip(tooltipTriggerEl);
                                        });
                                    });
                                </script>
</body>

</html>