{% extends "base.html" %}

{% block title %}{{ _('Upload Data') }} - Personal Investment System{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
            <i class="fas fa-file-upload text-green-600 mr-3"></i>{{ _('Upload Your Data') }}
        </h1>
        <p class="text-gray-600">
            {{ _('Import transactions from CSV or Excel files.') }}
        </p>
    </div>

    <!-- Templates Section -->
    <div class="bg-blue-50 rounded-xl p-6 mb-8 border border-blue-100">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-download mr-2"></i>{{ _('Download Templates') }}
        </h3>
        <p class="text-blue-700 mb-4">
            {{ _('Not sure about the format? Download our templates:') }}
        </p>
        <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('onboarding.download_template', template_type='transactions') }}"
                class="inline-flex items-center bg-white text-blue-700 px-4 py-2 rounded-lg border border-blue-200 hover:bg-blue-100 transition font-medium text-sm">
                <i class="fas fa-exchange-alt mr-2"></i>{{ _('Transactions Template') }}
            </a>
            <a href="{{ url_for('onboarding.download_template', template_type='holdings') }}"
                class="inline-flex items-center bg-white text-blue-700 px-4 py-2 rounded-lg border border-blue-200 hover:bg-blue-100 transition font-medium text-sm">
                <i class="fas fa-briefcase mr-2"></i>{{ _('Holdings Template') }}
            </a>
            <a href="{{ url_for('onboarding.download_template', template_type='balance_sheet') }}"
                class="inline-flex items-center bg-white text-blue-700 px-4 py-2 rounded-lg border border-blue-200 hover:bg-blue-100 transition font-medium text-sm">
                <i class="fas fa-balance-scale mr-2"></i>{{ _('Balance Sheet Template') }}
            </a>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-100">
        <form action="{{ url_for('onboarding.upload_file') }}" method="POST" enctype="multipart/form-data"
            id="upload-form">

            <!-- Dropzone -->
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all duration-300"
                id="dropzone">
                <input type="file" name="file" id="file-input" accept=".csv,.xlsx,.xls" required class="hidden">
                <div id="dropzone-content">
                    <div class="text-5xl mb-4">üìÅ</div>
                    <p class="text-gray-700 text-lg mb-2">{{ _('Drag and drop your file here') }}</p>
                    <p class="text-gray-500">{{ _('or') }} <strong class="text-blue-600">{{ _('click to browse')
                            }}</strong></p>
                    <p class="text-gray-400 text-sm mt-4">
                        {{ _('Supported: CSV, Excel (.xlsx, .xls)') }} ¬∑ {{ _('Max size: 50MB') }}
                    </p>
                </div>
            </div>

            <!-- Selected File Info -->
            <div id="file-info" class="hidden mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file-alt text-green-600 text-2xl mr-3"></i>
                        <div>
                            <p class="font-semibold text-green-800" id="file-name"></p>
                            <p class="text-sm text-green-600" id="file-size"></p>
                        </div>
                    </div>
                    <button type="button" onclick="clearFile()" class="text-gray-400 hover:text-red-500 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submit-btn"
                class="w-full mt-6 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all duration-300 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                <i class="fas fa-upload mr-2"></i>{{ _('Upload and Continue') }}
            </button>
        </form>
    </div>

    <!-- Back Link -->
    <div class="text-center mt-6">
        <a href="{{ url_for('onboarding.index') }}"
            class="inline-flex items-center text-gray-500 hover:text-gray-700 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>{{ _('Back to options') }}
        </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const submitBtn = document.getElementById('submit-btn');
        const dropzoneContent = document.getElementById('dropzone-content');

        // Click to open file dialog
        dropzone.addEventListener('click', () => fileInput.click());

        // Drag and drop handlers
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Validate file type
            const allowedTypes = ['.csv', '.xlsx', '.xls'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedTypes.includes(ext)) {
                alert('Invalid file type. Please upload CSV or Excel files.');
                return;
            }

            // Update UI
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
            dropzoneContent.innerHTML = `
            <div class="text-5xl mb-4">‚úì</div>
            <p class="text-green-700 text-lg font-semibold">${file.name}</p>
            <p class="text-green-600 text-sm">${'{{ _("Ready to upload") }}'}</p>
        `;
            submitBtn.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        window.clearFile = function () {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            dropzoneContent.innerHTML = `
            <div class="text-5xl mb-4">üìÅ</div>
            <p class="text-gray-700 text-lg mb-2">${'{{ _("Drag and drop your file here") }}'}</p>
            <p class="text-gray-500">${'{{ _("or") }}'} <strong class="text-blue-600">${'{{ _("click to browse") }}'}</strong></p>
            <p class="text-gray-400 text-sm mt-4">${'{{ _("Supported: CSV, Excel (.xlsx, .xls)") }}'} ¬∑ ${'{{ _("Max size: 50MB") }}'}</p>
        `;
            submitBtn.disabled = true;
        };
    });
</script>
{% endblock %}