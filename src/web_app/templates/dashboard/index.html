{% extends "base.html" %}

{% block title %}Dashboard - Investment System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Value Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Total Value</h3>
            <i class="fas fa-wallet text-blue-500 text-2xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900" id="total-value">Loading...</p>
        <p class="text-sm text-gray-500 mt-2">Updated: <span id="last-updated">-</span></p>
    </div>

    <!-- Holdings Count Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Active Holdings</h3>
            <i class="fas fa-layer-group text-green-500 text-2xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900" id="holdings-count">Loading...</p>
    </div>

    <!-- Historical Records Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-700">History Points</h3>
            <i class="fas fa-history text-purple-500 text-2xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900" id="history-count">Loading...</p>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Asset Allocation</h3>
        <div class="relative h-64">
            <canvas id="allocationChart"></canvas>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Portfolio Trend</h3>
        <div class="relative h-64">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchPortfolioData();
    });

    async function fetchPortfolioData() {
        try {
            const response = await fetch('/api/portfolio_overview');
            const result = await response.json();
            
            if (result.status === 'success') {
                const data = result.data;
                
                // Update cards
                document.getElementById('total-value').textContent = formatCurrency(data.total_portfolio_value);
                document.getElementById('holdings-count').textContent = data.current_holdings_count;
                document.getElementById('history-count').textContent = data.historical_records;
                document.getElementById('last-updated').textContent = new Date(data.generated_at).toLocaleTimeString();
                
                // Initialize charts (mock data for now as API doesn't return full chart data yet)
                initCharts(data);
            }
        } catch (error) {
            console.error('Error fetching portfolio data:', error);
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(value);
    }

    function initCharts(data) {
        // Allocation Chart
        const ctxAlloc = document.getElementById('allocationChart').getContext('2d');
        
        // Prepare allocation data
        let allocLabels = [];
        let allocValues = [];
        if (data.allocation) {
            allocLabels = Object.keys(data.allocation);
            allocValues = Object.values(data.allocation);
        } else {
            // Fallback mock data if empty
            allocLabels = ['Equity', 'Fixed Income', 'Cash', 'Alternative'];
            allocValues = [60, 20, 10, 10];
        }

        new Chart(ctxAlloc, {
            type: 'doughnut',
            data: {
                labels: allocLabels,
                datasets: [{
                    data: allocValues,
                    backgroundColor: [
                        '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', 
                        '#EC4899', '#6366F1', '#14B8A6', '#F43F5E'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Trend Chart
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        
        // Prepare trend data
        let trendLabels = [];
        let trendValues = [];
        if (data.trend && data.trend.dates && data.trend.values) {
            trendLabels = data.trend.dates;
            trendValues = data.trend.values;
        } else {
             // Fallback mock data
            trendLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            trendValues = [100000, 102000, 101500, 105000, 108000, 110000];
        }

        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: trendValues,
                    borderColor: '#3B82F6',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
</script>
{% endblock %}
