{% extends "base.html" %}

{% block title %}Cash Flow & Wealth Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div
    class="bg-gradient-to-r from-teal-600 to-cyan-600 rounded-b-lg shadow-lg text-white p-6 mb-8 -mt-8 mx-4 rounded-t-none">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-2"><i class="fas fa-money-bill-wave mr-2"></i> Cash Flow & Wealth Dashboard
        </h1>
        <p class="opacity-90">Comprehensive analysis of your income, expenses, savings, and net worth trends</p>
    </div>
</div>

<div class="container mx-auto px-4">
    <!-- At-a-Glance KPIs -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 border-b-4 border-teal-500 pb-2 mb-6">Financial Overview</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Net Worth -->
            <div
                class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition-shadow duration-300 flex flex-col justify-center items-center text-center h-32 border-t-4 border-teal-500">
                <div class="text-2xl font-bold text-gray-800 mb-1" id="kpi-net-worth">--</div>
                <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Total Net Worth</div>
                <div class="text-xs text-gray-400 mt-1">Includes all assets</div>
            </div>

            <!-- YTD Growth -->
            <div
                class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition-shadow duration-300 flex flex-col justify-center items-center text-center h-32 border-t-4 border-green-500">
                <div class="text-2xl font-bold text-gray-800 mb-1" id="kpi-growth">--</div>
                <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">YTD Growth</div>
                <div class="text-xs text-gray-400 mt-1">Annualized rate</div>
            </div>

            <!-- Avg Savings Rate -->
            <div
                class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition-shadow duration-300 flex flex-col justify-center items-center text-center h-32 border-t-4 border-blue-500">
                <div class="text-2xl font-bold text-gray-800 mb-1" id="kpi-savings-rate">--</div>
                <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Avg Savings Rate</div>
                <div class="text-xs text-gray-400 mt-1">Income - Expense / Income</div>
            </div>

            <!-- Avg Monthly Net Flow -->
            <div
                class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition-shadow duration-300 flex flex-col justify-center items-center text-center h-32 border-t-4 border-purple-500">
                <div class="text-2xl font-bold text-gray-800 mb-1" id="kpi-net-flow">--</div>
                <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Avg Mth Net Flow</div>
                <div class="text-xs text-gray-400 mt-1">Monthly surplus</div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-8">
        <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="showTab('net-worth')" id="tab-btn-net-worth"
                class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200 bg-gradient-to-r from-teal-600 to-cyan-600 text-white shadow-md">
                <i class="fas fa-chart-line mr-2"></i>Net Worth & Health
            </button>
            <button onclick="showTab('cash-flow')" id="tab-btn-cash-flow"
                class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">
                <i class="fas fa-exchange-alt mr-2"></i>Cash Flow Summary
            </button>
            <button onclick="showTab('expenses')" id="tab-btn-expenses"
                class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">
                <i class="fas fa-receipt mr-2"></i>Expenses Analysis
            </button>
        </div>

        <!-- Tab Content: Net Worth & Health -->
        <div id="tab-net-worth" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Net Worth Trend Chart -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-area mr-2 text-teal-500"></i> Net Worth Trend
                    </h3>
                    <div class="h-80">
                        <canvas id="chart-net-worth-trend"></canvas>
                    </div>
                </div>

                <!-- Asset Allocation -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-pie-chart mr-2 text-purple-500"></i> Asset Allocation
                    </h3>
                    <div class="h-80">
                        <canvas id="chart-asset-allocation"></canvas>
                    </div>
                </div>
            </div>

            <!-- Financial Health Ratios -->
            <div class="mt-6 bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-heartbeat mr-2 text-red-500"></i> Financial Health Ratios
                </h3>
                <div class="h-64">
                    <canvas id="chart-ratios"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab Content: Cash Flow Summary -->
        <div id="tab-cash-flow" class="tab-content hidden">
            <!-- Income vs Expense -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-balance-scale mr-2 text-green-500"></i> Income vs Expense Trend
                </h3>
                <div class="h-80">
                    <canvas id="chart-income-expense"></canvas>
                </div>
            </div>

            <!-- Net Cash Flow -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-arrow-trend-up mr-2 text-blue-500"></i> Net Cash Flow
                </h3>
                <div class="h-64">
                    <canvas id="chart-net-cash-flow"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab Content: Expenses Analysis -->
        <div id="tab-expenses" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Expense Breakdown -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-orange-500"></i> Expenses by Category (Top 6)
                    </h3>
                    <div class="h-80">
                        <canvas id="chart-expense-breakdown"></canvas>
                    </div>
                </div>

                <!-- Expense Trend -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-layer-group mr-2 text-indigo-500"></i> Essential vs Non-Essential Trend
                    </h3>
                    <div class="h-80">
                        <canvas id="chart-expense-trend"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tab switching
    function showTab(tabName) {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        // Show selected tab
        document.getElementById('tab-' + tabName).classList.remove('hidden');

        // Update button styles
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-gradient-to-r', 'from-teal-600', 'to-cyan-600', 'text-white', 'shadow-md');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        const activeBtn = document.getElementById('tab-btn-' + tabName);
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-gradient-to-r', 'from-teal-600', 'to-cyan-600', 'text-white', 'shadow-md');
    }

    // Chart color palette
    const COLORS = {
        primary: '#0d9488',    // teal-600
        secondary: '#06b6d4',  // cyan-500
        success: '#22c55e',    // green-500
        danger: '#ef4444',     // red-500
        warning: '#f59e0b',    // amber-500
        purple: '#8b5cf6',     // violet-500
        navy: '#1e40af',       // blue-800
        gray: '#6b7280'        // gray-500
    };

    const CHART_COLORS = ['#0d9488', '#8b5cf6', '#22c55e', '#f59e0b', '#1e40af', '#6b7280'];

    // Currency formatter
    function formatCurrency(value) {
        if (Math.abs(value) >= 1000000) return '¥' + (value / 1000000).toFixed(1) + 'M';
        if (Math.abs(value) >= 1000) return '¥' + (value / 1000).toFixed(0) + 'K';
        return '¥' + value.toFixed(0);
    }

    // Common chart options
    const commonLineOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top', labels: { usePointStyle: true, padding: 15 } },
            tooltip: {
                callbacks: {
                    label: ctx => ctx.dataset.label + ': ¥' + ctx.parsed.y.toLocaleString()
                }
            }
        },
        scales: {
            y: { ticks: { callback: v => formatCurrency(v) }, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        }
    };

    document.addEventListener("DOMContentLoaded", fetchData);

    function fetchData() {
        fetch('/wealth/api/summary')
            .then(r => r.json())
            .then(data => {
                if (data.error) { console.error("API Error:", data.error); return; }
                console.log("Dashboard Data:", data);
                updateKPIs(data.summary);
                renderCharts(data);
            })
            .catch(err => console.error("Fetch Error:", err));
    }

    function updateKPIs(summary) {
        if (!summary) return;
        document.getElementById('kpi-net-worth').innerText = summary.net_worth;
        document.getElementById('kpi-growth').innerText = summary.net_worth_growth_ytd;
        document.getElementById('kpi-savings-rate').innerText = summary.savings_rate;
        document.getElementById('kpi-net-flow').innerText = summary.monthly_details?.avg_net_cash_flow || '--';
    }

    function renderCharts(data) {
        // 1. Net Worth Trend
        const nwCtx = document.getElementById('chart-net-worth-trend').getContext('2d');
        if (data.balance_sheet?.trend_chart?.labels?.length > 0) {
            const nwDs = data.balance_sheet.trend_chart.datasets.find(d => d.label === 'Net_Worth_Calc_CNY');
            const assetsDs = data.balance_sheet.trend_chart.datasets.find(d => d.label === 'Total_Assets_Calc_CNY');
            const liabDs = data.balance_sheet.trend_chart.datasets.find(d => d.label === 'Total_Liabilities_Calc_CNY');

            new Chart(nwCtx, {
                type: 'line',
                data: {
                    labels: data.balance_sheet.trend_chart.labels,
                    datasets: [
                        { label: 'Net Worth', data: nwDs?.data || [], borderColor: COLORS.primary, backgroundColor: 'rgba(13, 148, 136, 0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 3 },
                        { label: 'Assets', data: assetsDs?.data || [], borderColor: COLORS.purple, borderDash: [5, 5], tension: 0.4, pointRadius: 0, borderWidth: 2 },
                        { label: 'Liabilities', data: liabDs?.data || [], borderColor: COLORS.danger, borderDash: [3, 3], tension: 0.4, pointRadius: 0, borderWidth: 2 }
                    ]
                },
                options: commonLineOptions
            });
        }

        // 2. Asset Allocation
        const allocCtx = document.getElementById('chart-asset-allocation').getContext('2d');
        if (data.balance_sheet?.asset_allocation?.labels?.length > 0) {
            new Chart(allocCtx, {
                type: 'doughnut',
                data: {
                    labels: data.balance_sheet.asset_allocation.labels,
                    datasets: [{ data: data.balance_sheet.asset_allocation.data, backgroundColor: CHART_COLORS, borderWidth: 2, borderColor: '#fff' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { usePointStyle: true } },
                        tooltip: { callbacks: { label: ctx => ctx.label + ': ¥' + ctx.parsed.toLocaleString() } }
                    }
                }
            });
        }

        // 3. Financial Health Ratios
        const ratiosCtx = document.getElementById('chart-ratios').getContext('2d');
        if (data.balance_sheet?.ratios_chart?.labels?.length > 0) {
            const debtDs = data.balance_sheet.ratios_chart.datasets.find(d => d.label === 'Debt_to_Asset_Ratio');
            const liqDs = data.balance_sheet.ratios_chart.datasets.find(d => d.label === 'Liquidity_Ratio');

            new Chart(ratiosCtx, {
                type: 'line',
                data: {
                    labels: data.balance_sheet.ratios_chart.labels,
                    datasets: [
                        { label: 'Debt/Asset Ratio', data: debtDs?.data || [], borderColor: COLORS.danger, tension: 0.4, pointRadius: 2, borderWidth: 2, yAxisID: 'y' },
                        { label: 'Liquidity Ratio', data: liqDs?.data || [], borderColor: COLORS.secondary, tension: 0.4, pointRadius: 2, borderWidth: 2, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + (ctx.parsed.y * 100).toFixed(1) + '%' } } },
                    scales: {
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Debt/Asset' }, ticks: { callback: v => (v * 100).toFixed(0) + '%' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Liquidity' }, grid: { drawOnChartArea: false }, ticks: { callback: v => v.toFixed(1) + 'x' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 4. Income vs Expense
        const cfCtx = document.getElementById('chart-income-expense').getContext('2d');
        const incomeDs = data.cash_flow?.income_chart?.datasets?.find(d => d.label === 'Total_Income_Calc_CNY');
        const expenseDs = data.cash_flow?.expense_chart?.datasets?.find(d => d.label === 'Total_Expense_Calc_CNY');

        if (incomeDs && expenseDs) {
            new Chart(cfCtx, {
                type: 'bar',
                data: {
                    labels: data.cash_flow.income_chart.labels,
                    datasets: [
                        { label: 'Income', data: incomeDs.data, backgroundColor: COLORS.success, borderRadius: 4 },
                        { label: 'Expense', data: expenseDs.data, backgroundColor: COLORS.danger, borderRadius: 4 }
                    ]
                },
                options: commonLineOptions
            });
        }

        // 5. Net Cash Flow
        const netCfCtx = document.getElementById('chart-net-cash-flow').getContext('2d');
        if (data.cash_flow?.net_cash_flow_chart?.labels?.length > 0) {
            const netCfDs = data.cash_flow.net_cash_flow_chart.datasets.find(d => d.label === 'Net_Cash_Flow');
            const netData = netCfDs?.data || [];
            const barColors = netData.map(v => v >= 0 ? COLORS.success : COLORS.danger);

            new Chart(netCfCtx, {
                type: 'bar',
                data: { labels: data.cash_flow.net_cash_flow_chart.labels, datasets: [{ label: 'Net Cash Flow', data: netData, backgroundColor: barColors, borderRadius: 4 }] },
                options: { ...commonLineOptions, plugins: { ...commonLineOptions.plugins, legend: { display: false } } }
            });
        }

        // 6. Expense Breakdown
        const expBreakCtx = document.getElementById('chart-expense-breakdown').getContext('2d');
        if (data.cash_flow?.expense_breakdown?.labels?.length > 0) {
            new Chart(expBreakCtx, {
                type: 'pie',
                data: { labels: data.cash_flow.expense_breakdown.labels, datasets: [{ data: data.cash_flow.expense_breakdown.data, backgroundColor: CHART_COLORS, borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { usePointStyle: true } }, tooltip: { callbacks: { label: ctx => ctx.label + ': ¥' + ctx.parsed.toLocaleString() } } } }
            });
        }

        // 7. Expense Trend (Stacked)
        const expTrendCtx = document.getElementById('chart-expense-trend').getContext('2d');
        const stacked = data.cash_flow?.expense_stacked_chart;
        if (stacked?.datasets?.length > 0) {
            const datasets = stacked.datasets.map((ds, i) => ({
                label: ds.label.replace('_Expense_Calc', '').replace('_', ' '),
                data: ds.data,
                backgroundColor: i === 0 ? COLORS.navy : COLORS.warning,
                borderRadius: 2
            }));

            new Chart(expTrendCtx, {
                type: 'bar',
                data: { labels: stacked.labels, datasets },
                options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { stacked: true, grid: { display: false } }, y: { ...commonLineOptions.scales.y, stacked: true } } }
            });
        }
    }
</script>
{% endblock %}