{% extends "base.html" %}

{% block title %}Add Transaction - Investment System{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Add Transaction</h1>
        <a href="{{ url_for('transactions.list_transactions') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-1"></i> Back to List
        </a>
    </div>

    <div class="bg-white shadow-md rounded-lg p-6">
        <form action="{{ url_for('transactions.add_transaction') }}" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Date -->
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                    <input type="date" id="date" name="date" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                </div>

                <!-- Transaction Type -->
                <div>
                    <label for="transaction_type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                    <select id="transaction_type" name="transaction_type" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                        <option value="Buy">Buy</option>
                        <option value="Sell">Sell</option>
                        <option value="Dividend_Cash">Dividend (Cash)</option>
                        <option value="Dividend_Reinvest">Dividend (Reinvest)</option>
                        <option value="Interest">Interest</option>
                        <option value="Fee">Fee</option>
                    </select>
                </div>

                <!-- Asset Type -->
                <div>
                    <label for="asset_type" class="block text-sm font-medium text-gray-700 mb-1">Asset Type *</label>
                    <select id="asset_type" name="asset_type" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                        <option value="Stock">Stock</option>
                        <option value="Fund">Fund</option>
                        <option value="Crypto">Crypto</option>
                        <option value="Bond">Bond</option>
                        <option value="Gold">Gold</option>
                        <option value="Insurance">Insurance</option>
                        <option value="RSU">RSU</option>
                        <option value="Deposit">Deposit</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Asset Selection -->
                <div class="md:col-span-2">
                    <label for="asset_search" class="block text-sm font-medium text-gray-700 mb-1">Select Asset
                        *</label>
                    <input type="text" id="asset_search" list="asset_list"
                        placeholder="Type to search existing assets (e.g. Apple)..."
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                    <datalist id="asset_list"></datalist>
                    <p class="text-xs text-gray-500 mt-1">Start typing to see matching assets from your portfolio. If
                        adding a new asset,
                        type the full name.</p>
                </div>

                <!-- Hidden Asset ID (filled automatically) -->
                <input type="hidden" id="asset_id" name="asset_id">

                <!-- Asset Name (read-only, auto-filled) -->
                <div>
                    <label for="asset_name" class="block text-sm font-medium text-gray-700 mb-1">Asset Name *</label>
                    <input type="text" id="asset_name" name="asset_name" required
                        placeholder="Auto-filled from selection"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border bg-gray-50">
                </div>

                <!-- Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (Net) *</label>
                    <input type="number" id="amount" name="amount" step="0.01" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                    <p class="text-xs text-gray-500 mt-1">Negative for outflow (Buy), Positive for inflow (Sell)</p>
                </div>

                <!-- Currency -->
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                    <select id="currency" name="currency"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                        <option value="CNY" selected>CNY</option>
                        <option value="USD">USD</option>
                        <option value="HKD">HKD</option>
                    </select>
                </div>

                <!-- Shares -->
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700 mb-1">Shares</label>
                    <input type="number" id="shares" name="shares" step="0.0001"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                </div>

                <!-- Price -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price per Share</label>
                    <input type="number" id="price" name="price" step="0.0001"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <a href="{{ url_for('transactions.list_transactions') }}"
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">Cancel</a>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition shadow">Save
                    Transaction</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const assetTypeSelect = document.getElementById('asset_type');
        const assetIdInput = document.getElementById('asset_id');
        const assetIdLabel = document.querySelector('label[for="asset_id"]');
        const sharesInput = document.getElementById('shares');
        const priceInput = document.getElementById('price');
        const amountInput = document.getElementById('amount');
        const transactionTypeSelect = document.getElementById('transaction_type');

        // Dynamic labels and visibility based on Asset Type
        // Dynamic labels and visibility based on Asset Type
        function updateFormFields() {
            const type = assetTypeSelect.value;

            // Logic for shares/price visibility
            if (type === 'Deposit') {
                sharesInput.parentElement.style.display = 'none';
                priceInput.parentElement.style.display = 'none';
            } else {
                sharesInput.parentElement.style.display = 'block';
                priceInput.parentElement.style.display = 'block';
            }
        }

        // Auto-calculate Amount
        function calculateAmount() {
            const shares = parseFloat(sharesInput.value);
            const price = parseFloat(priceInput.value);
            const txnType = transactionTypeSelect.value;

            if (!isNaN(shares) && !isNaN(price)) {
                let total = shares * price;

                // Apply sign convention
                if (txnType === 'Buy' || txnType === 'Dividend_Reinvest') {
                    total = -Math.abs(total); // Outflow
                } else if (txnType === 'Sell') {
                    total = Math.abs(total); // Inflow
                }

                amountInput.value = total.toFixed(2);
            }
        }

        assetTypeSelect.addEventListener('change', updateFormFields);
        sharesInput.addEventListener('input', calculateAmount);
        priceInput.addEventListener('input', calculateAmount);
        transactionTypeSelect.addEventListener('change', calculateAmount);

        // Initialize
        updateFormFields();

        // Fetch assets from API for autocomplete
        fetch('/api/assets/list')
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API data received:', data);
                const datalist = document.getElementById('asset_list');

                if (!datalist) {
                    console.error('Datalist element not found!');
                    return;
                }

                datalist.innerHTML = '';

                if (data.assets && data.assets.length > 0) {
                    console.log(`Processing ${data.assets.length} assets...`);

                    // Create options with proper attributes
                    data.assets.forEach((asset, index) => {
                        const option = document.createElement('option');
                        option.value = asset.Asset_Name;
                        option.setAttribute('data-asset-id', asset.Asset_ID);
                        option.label = asset.Asset_Name; // Explicit label for better browser support
                        datalist.appendChild(option);

                        // Log first few for debugging
                        if (index < 3) {
                            console.log(`Added option: ${asset.Asset_Name}`, option);
                        }
                    });

                    console.log(`‚úÖ Loaded ${data.assets.length} assets for dropdown`);
                    console.log('Datalist children count:', datalist.children.length);
                    console.log('First option:', datalist.children[0]);
                } else {
                    console.warn('‚ö†Ô∏è No assets returned from API');
                }
            })
            .catch(error => {
                console.error('‚ùå Error fetching assets:', error);
            });

        // Auto-fill Asset ID and Asset Name when selection made
        const assetSearchInput = document.getElementById('asset_search');

        assetSearchInput.addEventListener('input', function (e) {
            const selectedValue = e.target.value;
            const datalist = document.getElementById('asset_list');
            const options = Array.from(datalist.querySelectorAll('option'));

            console.log('Input changed to:', selectedValue);
            console.log('Available options:', options.length);

            // Find matching option
            let foundMatch = false;
            options.forEach(option => {
                if (option.value === selectedValue) {
                    // Auto-fill hidden Asset ID and visible Asset Name
                    const assetId = option.getAttribute('data-asset-id') || selectedValue;
                    document.getElementById('asset_id').value = assetId;
                    document.getElementById('asset_name').value = selectedValue;
                    foundMatch = true;
                    console.log('‚úÖ Matched asset:', selectedValue, 'ID:', assetId);
                }
            });

            // If no match, treat as new asset (manual entry)
            if (!foundMatch && selectedValue.length > 0) {
                document.getElementById('asset_id').value = selectedValue;
                document.getElementById('asset_name').value = selectedValue;
                console.log('üìù Manual entry:', selectedValue);
            }
        });

        // Also try 'change' event for better browser compatibility
        assetSearchInput.addEventListener('change', function (e) {
            console.log('Change event fired with value:', e.target.value);
        });
    });
</script>
{% endblock %}