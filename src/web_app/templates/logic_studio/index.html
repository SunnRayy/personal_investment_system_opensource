{% extends "base.html" %}

{% block title %}{{ _('Logic Studio') }} - WealthOS{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">{{ _('Logic Studio') }}</h1>
        <p class="text-gray-600 mt-2">{{ _('Configure classification rules and calculation strategies.') }}</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Sidebar Navigation -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <nav class="flex flex-col">
                    <a href="#" onclick="showTaxonomyList()"
                        class="px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500"
                        id="navTaxonomy">
                        {{ _('Taxonomy Editor') }}
                    </a>
                    <a href="#" onclick="showStrategySelector()"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent"
                        id="navStrategy">
                        {{ _('Strategy Selector') }}
                    </a>
                    <a href="#" onclick="showRuleBuilder()"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent"
                        id="navRules">
                        {{ _('Auto-Classification Rules') }}
                    </a>
                    <a href="#" onclick="showAssetAudit()"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent"
                        id="navAudit">
                        {{ _('Asset Audit') }}
                    </a>
                    <a href="#" onclick="showAssetTier()"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent"
                        id="navTier">
                        {{ _('Asset Tier') }}
                    </a>
                    <a href="{{ url_for('logic_studio.allocations') }}"
                        class="px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent"
                        id="navAllocation">
                        {{ _('Target Allocation') }}
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="md:col-span-3">
            <!-- Taxonomy List View -->
            <div id="taxonomyListView" class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">{{ _('Taxonomy Editor') }}</h2>
                    <button onclick="openCreateTaxonomyModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        + {{ _('New Taxonomy') }}
                    </button>
                </div>

                <!-- Taxonomy List Container -->
                <div id="taxonomyList" class="space-y-4">
                    <!-- Dynamic Content -->
                    <div class="text-center py-8 text-gray-500">{{ _('Loading taxonomies...') }}</div>
                </div>
            </div>

            <!-- Tag Manager View (Hidden by default) -->
            <div id="tagManagerView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <button onclick="showTaxonomyList()" class="mr-4 text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800" id="selectedTaxonomyName">Region</h2>
                            <p class="text-sm text-gray-500" id="selectedTaxonomyDesc">{{ _('Manage tags for this
                                taxonomy') }}</p>
                        </div>
                    </div>
                    <button onclick="openCreateTagModal()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        + {{ _('New Tag') }}
                    </button>
                </div>

                <!-- Tags List -->
                <div id="tagList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Dynamic Tags -->
                </div>
            </div>

            <!-- Strategy Selector View (Hidden by default) -->
            <div id="strategySelectorView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">{{ _('Strategy Selector') }}</h2>

                    <!-- Asset Search -->
                    <div class="relative mb-6">
                        <input type="text" id="assetSearchInput"
                            placeholder="{{ _('Search for an asset to configure...') }}"
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            oninput="debounceSearch(this.value)">
                        <div id="assetSearchResults"
                            class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            <!-- Results -->
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <div id="strategyConfigForm" class="hidden border-t pt-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900" id="configAssetName">{{ _('Asset Name') }}
                                </h3>
                                <p class="text-sm text-gray-500" id="configAssetId">ID: 123</p>
                            </div>
                            <span id="configAssetClass"
                                class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">Equity</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Cost Basis -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Cost Basis Method')
                                    }}</label>
                                <select id="costBasisMethod"
                                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="FIFO">FIFO (First In, First Out)</option>
                                    <option value="LIFO">LIFO (Last In, First Out)</option>
                                    <option value="AvgCost">Average Cost</option>
                                    <option value="SpecificLot">Specific Lot</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">{{ _('Determines how realized gains are
                                    calculated.') }}</p>
                            </div>

                            <!-- Currency Strategy -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Currency Strategy')
                                    }}</label>
                                <select id="currencyStrategy"
                                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onchange="toggleFixedRate()">
                                    <option value="Spot">Spot Rate (Daily)</option>
                                    <option value="Fixed">Fixed Rate</option>
                                    <option value="Hedged">Hedged (Ignore FX)</option>
                                </select>
                                <input type="number" id="fixedCurrencyRate" placeholder="Rate"
                                    class="mt-2 w-full px-3 py-2 border rounded hidden">
                            </div>

                            <!-- Dividend Strategy -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Dividend Strategy')
                                    }}</label>
                                <select id="dividendStrategy"
                                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="Cash">Cash Payout</option>
                                    <option value="Reinvest">Reinvest (DRIP)</option>
                                </select>
                            </div>

                            <!-- Notes -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Notes') }}</label>
                                <textarea id="strategyNotes" rows="3"
                                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="saveStrategy()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium">
                                {{ _('Save Configuration') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rule Builder View (Hidden by default) -->
            <div id="ruleBuilderView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">{{ _('Auto-Classification Rules') }}</h2>
                    <div class="space-x-2">
                        <button onclick="runAutoTagging()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            ▶ {{ _('Run Auto-Tagging') }}
                        </button>
                        <button onclick="openCreateRuleModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            + {{ _('New Rule') }}
                        </button>
                    </div>
                </div>

                <!-- Rules List -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Name') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Pattern') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Tag') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody id="ruleList" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic Rules -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Asset Audit View (Hidden by default) -->
            <div id="assetAuditView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">{{ _('Asset Audit') }}</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="auditSearch" placeholder="{{ _('Filter assets...') }}"
                            class="px-3 py-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            oninput="filterAuditTable()">
                        <button onclick="loadAuditData()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <!-- Batch Action Toolbar -->
                    <div id="batchActionBar"
                        class="bg-blue-50 p-4 mb-4 rounded flex justify-between items-center hidden">
                        <span class="text-blue-800 font-medium"><span id="selectedCount">0</span> {{ _('assets
                            selected') }}</span>
                        <div class="space-x-2">
                            <button onclick="openBatchEditTypeModal()"
                                class="px-3 py-1 bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-50">
                                {{ _('Edit Type') }}
                            </button>
                        </div>
                    </div>

                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Asset') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Type') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Current Tag') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Top Level') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Active Rule') }}</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {{ _('Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody id="auditList" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Target Allocation View (Hidden by default) -->
            <div id="allocationView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">{{ _('Target Allocation') }}</h2>
                    <div>
                        <select id="riskProfileSelect" onchange="loadAllocations()"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option>{{ _('Select a Profile...') }}</option>
                        </select>
                        <span id="activeProfileBtnContainer" class="flex items-center"></span>
                    </div>
                </div>

                <div id="allocationContent" class="space-y-6">
                    <!-- Dynamic Content -->
                    <div class="text-center py-8 text-gray-500">{{ _('Select a profile to view allocations.') }}</div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="saveAllocations()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium">
                        Save Changes
                    </button>
                </div>
            </div>

            <!-- Asset Tier View (Hidden by default) -->
            <div id="assetTierView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">{{ _('Asset Tier Manager') }}</h2>
                    <div class="flex space-x-2">
                        <button onclick="runAutoTagging()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            ▶ {{ _('Run Auto-Tagging') }}
                        </button>
                        <button onclick="openCreateRuleModalForTier()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            + {{ _('Add Tier Rule') }}
                        </button>
                    </div>
                </div>

                <!-- Tier Summary Cards -->
                <div id="tierSummaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Dynamic Cards -->
                </div>

                <div class="border-t pt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">{{ _('Tier Classification Audit') }}</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="tierAuditSearch" placeholder="{{ _('Filter assets...') }}"
                                class="px-3 py-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                oninput="filterTierAuditTable()">
                            <select id="tierFilter" onchange="filterTierAuditTable()"
                                class="px-3 py-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">{{ _('All Assets') }}</option>
                                <option value="unclassified">{{ _('Unclassified Only') }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {{ _('Asset') }}</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {{ _('Current Tier') }}</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {{ _('Active Rule') }}</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody id="tierAuditList" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tier Target Allocations -->
                <div class="border-t pt-8 mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">{{ _('Tier Target Allocations') }}</h3>
                        <button onclick="saveTierAllocations()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            {{ _('Save Allocations') }}
                        </button>
                    </div>
                    <div id="tierAllocationEditor" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Dynamic Allocation Inputs -->
                    </div>
                    <p id="tierAllocationTotal" class="text-sm text-gray-500 mt-4"></p>
                </div>

                <!-- Tier Classification Rules -->
                <div class="border-t pt-8 mt-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">{{ _('Tier Classification Rules') }}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{{
                                        _('Rule Name') }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{{
                                        _('Pattern') }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{{
                                        _('Tier') }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{{
                                        _('Priority') }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{{
                                        _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody id="tierRulesList" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic Rules -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Taxonomy Modal -->
<div id="createTaxonomyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Create New Taxonomy') }}</h3>
            <div class="mt-2 px-7 py-3">
                <input type="text" id="newTaxonomyName" placeholder="{{ _('Name (e.g. Region)') }}"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="newTaxonomyDesc" placeholder="{{ _('Description') }}"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="newTaxonomyHierarchical" class="mr-2">
                    <label for="newTaxonomyHierarchical" class="text-sm text-gray-600">{{ _('Hierarchical (allows parent
                        tags)') }}</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="newTaxonomyMultiple" class="mr-2">
                    <label for="newTaxonomyMultiple" class="text-sm text-gray-600">{{ _('Allow Multiple Tags per Asset')
                        }}</label>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="createTaxonomyBtn" onclick="createTaxonomy()"
                    class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    {{ _('Create') }}
                </button>
                <button onclick="closeCreateTaxonomyModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Tag Modal -->
<div id="createTagModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Create New Tag') }}</h3>
            <div class="mt-2 px-7 py-3">
                <input type="text" id="newTagName" placeholder="Name (e.g. US)"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="newTagDesc" placeholder="Description"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Color') }}</label>
                    <select id="newTagColor"
                        class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="yellow">Yellow</option>
                        <option value="purple">Purple</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="createTagBtn" onclick="createTag()"
                    class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                    {{ _('Create Tag') }}
                </button>
                <button onclick="closeCreateTagModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div id="editTagModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Edit Tag') }}</h3>
            <div class="mt-2 px-7 py-3">
                <input type="hidden" id="editTagId">
                <input type="text" id="editTagName" placeholder="Name (e.g. US)"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="editTagDesc" placeholder="Description"
                    class="mb-3 px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('Color') }}</label>
                    <select id="editTagColor"
                        class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="yellow">Yellow</option>
                        <option value="purple">Purple</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="updateTag()"
                    class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    {{ _('Save Changes') }}
                </button>
                <button onclick="closeEditTagModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Rule Modal -->
<div id="createRuleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Create Classification Rule') }}</h3>
            <div class="mt-2 px-7 py-3 text-left">
                <label class="block text-xs font-medium text-gray-700 mb-1">{{ _('Rule Name') }}</label>
                <input type="text" id="newRuleName" placeholder="e.g. US Tech ETFs"
                    class="mb-3 px-3 py-2 border rounded w-full">

                <label class="block text-xs font-medium text-gray-700 mb-1">{{ _('Pattern (Regex or Text)') }}</label>
                <input type="text" id="newRulePattern" placeholder="e.g. VOO|SPY|QQQ"
                    class="mb-3 px-3 py-2 border rounded w-full">

                <label class="block text-xs font-medium text-gray-700 mb-1">{{ _('Match Type') }}</label>
                <select id="newRuleMatchType" class="mb-3 px-3 py-2 border rounded w-full">
                    <option value="contains">{{ _('Contains') }}</option>
                    <option value="exact">{{ _('Exact Match') }}</option>
                    <option value="regex">{{ _('Regex') }}</option>
                </select>

                <label class="block text-xs font-medium text-gray-700 mb-1">{{ _('Apply Tag') }}</label>
                <select id="newRuleTaxonomy" class="mb-2 px-3 py-2 border rounded w-full"
                    onchange="loadRuleTags(this.value)">
                    <option value="">{{ _('Select Taxonomy...') }}</option>
                </select>
                <select id="newRuleTag" class="mb-3 px-3 py-2 border rounded w-full" disabled>
                    <option value="">{{ _('Select Tag...') }}</option>
                </select>

                <label class="block text-xs font-medium text-gray-700 mb-1">{{ _('Priority (higher = runs first)')
                    }}</label>
                <input type="number" id="newRulePriority" value="200" min="0" max="1000"
                    class="mb-3 px-3 py-2 border rounded w-full" placeholder="200">
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="createRule()"
                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    {{ _('Create Rule') }}
                </button>
                <button onclick="closeCreateRuleModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Edit Type Modal -->
<div id="batchEditTypeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Batch Edit Asset Type') }}</h3>
            <p class="text-sm text-gray-500 mt-2">{{ _('Updating') }} <span id="batchCountDisplay">0</span> {{
                _('assets') }}</p>
            <div class="mt-2 px-7 py-3">
                <div class="mb-4 text-left">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ _('New Asset Type') }}</label>
                    <input type="text" id="batchNewType"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        placeholder="e.g. ETF">
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="submitBatchUpdate()"
                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    {{ _('Update All') }}
                </button>
                <button onclick="closeBatchEditTypeModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Asset Modal -->
<div id="editAssetModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ _('Edit Asset Details') }}</h3>
            <div class="mt-2 px-7 py-3">
                <input type="hidden" id="editAssetId">
                <div class="mb-4 text-left">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ _('Asset Type') }}</label>
                    <input type="text" id="editAssetType"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="updateAsset()"
                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    {{ _('Save Changes') }}
                </button>
                <button onclick="closeEditAssetModal()"
                    class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTaxonomyId = null;
    let currentParentId = null;
    let currentTags = [];

    document.addEventListener('DOMContentLoaded', function () {
        console.log('Logic Studio initialized');
        loadTaxonomies();
    });

    // --- Taxonomy Functions ---

    function loadTaxonomies() {
        fetch('/logic-studio/api/taxonomies')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('taxonomyList');
                list.innerHTML = '';

                if (data.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-500">No taxonomies found. Create one to get started.</div>';
                    return;
                }

                data.forEach(tax => {
                    const div = document.createElement('div');
                    div.className = 'border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition';
                    div.onclick = () => selectTaxonomy(tax.id, tax.name, tax.description);

                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-medium text-gray-900">${tax.name}</h3>
                                <p class="text-sm text-gray-500">${tax.description || ''}</p>
                            </div>
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${tax.tags_count} Tags</span>
                        </div>
                    `;
                    list.appendChild(div);
                });
            })
            .catch(error => console.error('Error loading taxonomies:', error));
    }

    function createTaxonomy() {
        const name = document.getElementById('newTaxonomyName').value;
        const desc = document.getElementById('newTaxonomyDesc').value;
        const isHierarchical = document.getElementById('newTaxonomyHierarchical').checked;
        const allowMultiple = document.getElementById('newTaxonomyMultiple').checked;

        if (!name) {
            alert('Name is required');
            return;
        }

        fetch('/logic-studio/api/taxonomies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: desc,
                is_hierarchical: isHierarchical,
                allow_multiple: allowMultiple
            })
        })
            .then(response => {
                if (response.ok) {
                    closeCreateTaxonomyModal();
                    loadTaxonomies();
                    // Clear inputs
                    document.getElementById('newTaxonomyName').value = '';
                    document.getElementById('newTaxonomyDesc').value = '';
                } else {
                    response.json().then(data => alert(data.error || 'Error creating taxonomy'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function selectTaxonomy(id, name, desc) {
        currentTaxonomyId = id;
        document.getElementById('selectedTaxonomyName').textContent = name;
        document.getElementById('selectedTaxonomyDesc').textContent = desc || 'Manage tags';

        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.remove('hidden');

        loadTags(id);
    }

    function showTaxonomyList() {
        currentTaxonomyId = null;
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.add('hidden');
        document.getElementById('allocationView').classList.add('hidden');
        document.getElementById('taxonomyListView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';
        document.getElementById('navStrategy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navAllocation').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';

        loadTaxonomies(); // Refresh counts
    }

    // --- Tag Functions ---

    function loadTags(taxonomyId) {
        fetch(`/logic-studio/api/taxonomies/${taxonomyId}/tags`)
            .then(response => response.json())
            .then(data => {
                currentTags = data; // Store for edit modal
                const list = document.getElementById('tagList');
                list.innerHTML = '';

                if (data.length === 0) {
                    list.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">No tags found. Create one to get started.</div>';
                    return;
                }

                // Group by hierarchy
                const topLevelTags = data.filter(t => t.is_top_level || !t.parent_id);
                const subTags = data.filter(t => !t.is_top_level && t.parent_id);

                topLevelTags.forEach(tag => {
                    const children = subTags.filter(t => t.parent_id === tag.id);

                    const div = document.createElement('div');
                    div.className = `bg-white rounded shadow-sm border border-gray-200 overflow-hidden`;

                    let childrenHtml = '';
                    if (children.length > 0) {
                        childrenHtml = '<div class="bg-gray-50 px-4 py-2 space-y-2">';
                        children.forEach(child => {
                            childrenHtml += `
                                <div class="flex justify-between items-center text-sm bg-white p-2 rounded border border-gray-100 group">
                                    <span>${child.name}</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-400">Sub-class</span>
                                        <button onclick="openEditTagModal(${child.id})" class="text-blue-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition" title="Edit">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button onclick="deleteTag(${child.id})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        childrenHtml += '</div>';
                    }

                    div.innerHTML = `
                        <div class="p-4 border-l-4 border-${tag.color}-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="flex items-center">
                                        <h4 class="font-medium text-gray-900 text-lg">${tag.name}</h4>
                                        <button onclick="openEditTagModal(${tag.id})" class="text-gray-400 hover:text-blue-600 ml-2 text-xs" title="Edit">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button onclick="deleteTag(${tag.id})" class="text-gray-400 hover:text-red-600 ml-2 text-xs" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500">${tag.description || 'Top Level Class'}</p>
                                </div>
                                <button onclick="openCreateTagModal(${tag.id})" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">
                                    + Sub Class
                                </button>
                            </div>
                        </div>
                        ${childrenHtml}
                    `;
                    list.appendChild(div);
                });

                // Render orphans if any (non-top-level but no parent found in current list? or flat list)
                // For now assuming strict hierarchy for Asset Class
            })
            .catch(error => console.error('Error loading tags:', error));
    }

    function createTag() {
        if (!currentTaxonomyId) return;

        const name = document.getElementById('newTagName').value;
        const desc = document.getElementById('newTagDesc').value;
        const color = document.getElementById('newTagColor').value;

        if (!name) {
            alert('Name is required');
            return;
        }

        const payload = {
            name: name,
            description: desc,
            color: color,
            parent_id: currentParentId,
            is_top_level: !currentParentId
        };

        fetch(`/logic-studio/api/taxonomies/${currentTaxonomyId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (response.ok) {
                    closeCreateTagModal();
                    loadTags(currentTaxonomyId);
                    // Clear inputs
                    document.getElementById('newTagName').value = '';
                    document.getElementById('newTagDesc').value = '';
                } else {
                    response.json().then(data => alert(data.error || 'Error creating tag'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // --- Modal Functions ---

    function openCreateTaxonomyModal() {
        document.getElementById('createTaxonomyModal').classList.remove('hidden');
    }

    function closeCreateTaxonomyModal() {
        document.getElementById('createTaxonomyModal').classList.add('hidden');
    }

    function openCreateTagModal(parentId = null) {
        currentParentId = parentId;
        document.getElementById('createTagModal').classList.remove('hidden');

        // Update title or show parent context if needed
        const title = document.querySelector('#createTagModal h3');
        title.textContent = parentId ? 'Create Sub Class' : 'Create New Tag';
    }

    function closeCreateTagModal() {
        document.getElementById('createTagModal').classList.add('hidden');
    }

    function deleteTag(tagId) {
        if (!confirm('Are you sure you want to delete this tag?')) return;

        fetch(`/logic-studio/api/tags/${tagId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    loadTags(currentTaxonomyId);
                } else {
                    response.json().then(data => alert(data.error || 'Error deleting tag'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function openEditTagModal(tagId) {
        const tag = currentTags.find(t => t.id === tagId);
        if (!tag) return;

        document.getElementById('editTagId').value = tag.id;
        document.getElementById('editTagName').value = tag.name;
        document.getElementById('editTagDesc').value = tag.description || '';
        document.getElementById('editTagColor').value = tag.color || 'blue';

        document.getElementById('editTagModal').classList.remove('hidden');
    }

    function closeEditTagModal() {
        document.getElementById('editTagModal').classList.add('hidden');
    }

    function updateTag() {
        const id = document.getElementById('editTagId').value;
        const name = document.getElementById('editTagName').value;
        const desc = document.getElementById('editTagDesc').value;
        const color = document.getElementById('editTagColor').value;

        if (!name) {
            alert('Name is required');
            return;
        }

        fetch(`/logic-studio/api/tags/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: desc,
                color: color
            })
        })
            .then(response => {
                if (response.ok) {
                    closeEditTagModal();
                    loadTags(currentTaxonomyId);
                } else {
                    response.json().then(data => alert(data.error || 'Error updating tag'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // --- Strategy Selector Functions ---

    function showStrategySelector() {
        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navStrategy').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';
    }

    // Debounce search
    let searchTimeout;
    function debounceSearch(query) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchAssets(query), 300);
    }

    function searchAssets(query) {
        if (!query || query.length < 2) {
            document.getElementById('assetSearchResults').classList.add('hidden');
            return;
        }

        fetch(`/workbench/api/search-assets?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('assetSearchResults');
                resultsDiv.innerHTML = '';

                if (data.length === 0) {
                    resultsDiv.innerHTML = '<div class="px-4 py-2 text-gray-500">No assets found</div>';
                } else {
                    data.forEach(asset => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-b-0';
                        div.onclick = () => selectAssetForStrategy(asset);
                        div.innerHTML = `
                            <div class="font-medium text-gray-900">${asset.asset_name}</div>
                            <div class="text-xs text-gray-500">${asset.asset_id} • ${asset.asset_class}</div>
                        `;
                        resultsDiv.appendChild(div);
                    });
                }
                resultsDiv.classList.remove('hidden');
            })
            .catch(error => console.error('Error searching assets:', error));
    }

    let currentConfigAssetId = null;

    function selectAssetForStrategy(asset) {
        currentConfigAssetId = asset.asset_id;

        // Update UI
        document.getElementById('configAssetName').textContent = asset.asset_name;
        document.getElementById('configAssetId').textContent = `ID: ${asset.asset_id}`;
        document.getElementById('configAssetClass').textContent = asset.asset_class;
        document.getElementById('assetSearchResults').classList.add('hidden');
        document.getElementById('assetSearchInput').value = asset.asset_name;

        // Load existing strategy
        loadStrategy(asset.asset_id);

        document.getElementById('strategyConfigForm').classList.remove('hidden');
    }

    function loadStrategy(assetId) {
        fetch(`/logic-studio/api/strategies/${assetId}`)
            .then(response => response.json())
            .then(data => {
                // Set defaults if empty
                document.getElementById('costBasisMethod').value = data.cost_basis_method || 'FIFO';
                document.getElementById('currencyStrategy').value = data.currency_strategy || 'Spot';
                document.getElementById('fixedCurrencyRate').value = data.fixed_currency_rate || '';
                document.getElementById('dividendStrategy').value = data.dividend_strategy || 'Cash';
                document.getElementById('strategyNotes').value = data.notes || '';

                toggleFixedRate();
            })
            .catch(error => console.error('Error loading strategy:', error));
    }

    function saveStrategy() {
        if (!currentConfigAssetId) return;

        const data = {
            cost_basis_method: document.getElementById('costBasisMethod').value,
            currency_strategy: document.getElementById('currencyStrategy').value,
            fixed_currency_rate: document.getElementById('fixedCurrencyRate').value,
            dividend_strategy: document.getElementById('dividendStrategy').value,
            notes: document.getElementById('strategyNotes').value
        };

        fetch(`/logic-studio/api/strategies/${currentConfigAssetId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert('Strategy configuration saved successfully!');
                } else {
                    response.json().then(data => alert(data.error || 'Error saving strategy'));
                }
            })
            .catch(error => console.error('Error saving strategy:', error));
    }

    function toggleFixedRate() {
        const strategy = document.getElementById('currencyStrategy').value;
        const input = document.getElementById('fixedCurrencyRate');
        if (strategy === 'Fixed') {
            input.classList.remove('hidden');
        } else {
            input.classList.add('hidden');
        }
    }

    // --- Rule Builder Functions ---

    function showRuleBuilder() {
        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.add('hidden');
        document.getElementById('ruleBuilderView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navStrategy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navRules').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';
        document.getElementById('navAudit').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';

        loadRules();
    }

    // --- Asset Audit Functions ---

    function showAssetAudit() {
        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.add('hidden');
        document.getElementById('ruleBuilderView').classList.add('hidden');
        document.getElementById('allocationView').classList.add('hidden');
        document.getElementById('assetAuditView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navStrategy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navRules').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navAudit').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';
        document.getElementById('navAllocation').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';

        loadAuditData();
    }

    let allAuditData = [];

    function loadAuditData() {
        const list = document.getElementById('auditList');
        list.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading audit data...</td></tr>';

        fetch('/logic-studio/api/audit')
            .then(response => response.json())
            .then(data => {
                allAuditData = data;
                renderAuditTable(data);
            })
            .catch(error => {
                console.error('Error loading audit data:', error);
                list.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading data</td></tr>';
            });
    }

    function renderAuditTable(data) {
        const list = document.getElementById('auditList');
        list.innerHTML = '';

        if (data.length === 0) {
            list.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No assets found.</td></tr>';
            return;
        }

        data.forEach(item => {
            const tr = document.createElement('tr');

            // Status Color Logic
            let statusClass = 'bg-gray-100 text-gray-800';
            if (!item.current_tag) statusClass = 'bg-red-100 text-red-800';
            else if (!item.top_level_class) statusClass = 'bg-yellow-100 text-yellow-800';
            else statusClass = 'bg-green-100 text-green-800';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="checkbox" class="asset-checkbox" value="${item.asset_id}" onchange="updateBatchSelection()">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${item.asset_name}</div>
                    <div class="text-xs text-gray-500">${item.asset_id}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${item.asset_type || '-'}
                    <button onclick="openEditAssetModal('${item.asset_id}', '${item.asset_type || ''}')" class="ml-2 text-gray-400 hover:text-blue-500">
                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${item.current_tag || 'Unmapped'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.top_level_class || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${item.active_rule ? `<span class="text-blue-600">${item.active_rule}</span>` : '<span class="text-gray-400">Manual/None</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="quickClassify('${item.asset_name}', '${item.asset_type}')" 
                        class="text-blue-600 hover:text-blue-900 mr-3">
                        ${item.active_rule ? 'Edit Rule' : 'Classify'}
                    </button>
                </td>
            `;
            list.appendChild(tr);
        });
    }

    function filterAuditTable() {
        const query = document.getElementById('auditSearch').value.toLowerCase();
        const filtered = allAuditData.filter(item =>
            item.asset_name.toLowerCase().includes(query) ||
            item.asset_id.toLowerCase().includes(query) ||
            (item.current_tag && item.current_tag.toLowerCase().includes(query))
        );
        renderAuditTable(filtered);
    }

    function quickClassify(assetName, assetType) {
        openCreateRuleModal();
        // Pre-fill
        document.getElementById('newRuleName').value = `Classify ${assetName}`;
        document.getElementById('newRulePattern').value = assetName;
        document.getElementById('newRuleMatchType').value = 'exact';
    }

    // --- Edit Asset Modal ---

    function openEditAssetModal(assetId, currentType) {
        document.getElementById('editAssetId').value = assetId;
        document.getElementById('editAssetType').value = currentType;
        document.getElementById('editAssetModal').classList.remove('hidden');
    }

    function closeEditAssetModal() {
        document.getElementById('editAssetModal').classList.add('hidden');
    }

    function updateAsset() {
        const assetId = document.getElementById('editAssetId').value;
        const newType = document.getElementById('editAssetType').value;

        fetch(`/logic-studio/api/assets/${assetId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ asset_type: newType })
        })
            .then(response => {
                if (response.ok) {
                    closeEditAssetModal();
                    loadAuditData(); // Refresh table
                } else {
                    response.json().then(data => alert(data.error || 'Error updating asset'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // --- Batch Operations ---

    function toggleSelectAll() {
        const checked = document.getElementById('selectAllCheckbox').checked;
        document.querySelectorAll('.asset-checkbox').forEach(cb => cb.checked = checked);
        updateBatchSelection();
    }

    function updateBatchSelection() {
        const selected = document.querySelectorAll('.asset-checkbox:checked').length;
        document.getElementById('selectedCount').innerText = selected;

        if (selected > 0) {
            document.getElementById('batchActionBar').classList.remove('hidden');
        } else {
            document.getElementById('batchActionBar').classList.add('hidden');
        }
    }

    function openBatchEditTypeModal() {
        const selected = document.querySelectorAll('.asset-checkbox:checked').length;
        if (selected === 0) return;

        document.getElementById('batchCountDisplay').innerText = selected;
        document.getElementById('batchNewType').value = '';
        document.getElementById('batchEditTypeModal').classList.remove('hidden');
    }

    function closeBatchEditTypeModal() {
        document.getElementById('batchEditTypeModal').classList.add('hidden');
    }

    function submitBatchUpdate() {
        const newType = document.getElementById('batchNewType').value;
        if (!newType) {
            alert('Please enter a type');
            return;
        }

        const assetIds = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);

        fetch('/logic-studio/api/assets/batch-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                asset_ids: assetIds,
                updates: { asset_type: newType }
            })
        })
            .then(response => {
                if (response.ok) {
                    closeBatchEditTypeModal();
                    loadAuditData(); // Refresh table
                    // Reset selection
                    document.getElementById('selectAllCheckbox').checked = false;
                    document.getElementById('batchActionBar').classList.add('hidden');
                } else {
                    response.json().then(data => alert(data.error || 'Error updating assets'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function loadRules() {
        fetch('/logic-studio/api/rules')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('ruleList');
                list.innerHTML = '';

                if (data.length === 0) {
                    list.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No rules found. Create one to automate tagging.</td></tr>';
                    return;
                }

                data.forEach(rule => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rule.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">${rule.match_type}: ${rule.pattern}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${rule.taxonomy_name} > <span class="font-medium text-gray-900">${rule.tag_name}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="deleteRule(${rule.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    list.appendChild(tr);
                });
            })
            .catch(error => console.error('Error loading rules:', error));
    }

    function openCreateRuleModal() {
        document.getElementById('createRuleModal').classList.remove('hidden');
        loadRuleTaxonomies();
    }

    function closeCreateRuleModal() {
        document.getElementById('createRuleModal').classList.add('hidden');
    }

    function loadRuleTaxonomies() {
        fetch('/logic-studio/api/taxonomies')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('newRuleTaxonomy');
                select.innerHTML = '<option value="">Select Taxonomy...</option>';
                data.forEach(tax => {
                    const option = document.createElement('option');
                    option.value = tax.id;
                    option.textContent = tax.name;
                    select.appendChild(option);
                });
            });
    }

    function loadRuleTags(taxonomyId) {
        const select = document.getElementById('newRuleTag');
        if (!taxonomyId) {
            select.innerHTML = '<option value="">Select Tag...</option>';
            select.disabled = true;
            return;
        }

        fetch(`/logic-studio/api/taxonomies/${taxonomyId}/tags`)
            .then(response => response.json())
            .then(data => {
                select.innerHTML = '<option value="">Select Tag...</option>';
                data.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    select.appendChild(option);
                });
                select.disabled = false;
            });
    }

    function createRule() {
        const name = document.getElementById('newRuleName').value;
        const pattern = document.getElementById('newRulePattern').value;
        const matchType = document.getElementById('newRuleMatchType').value;
        const taxonomyId = document.getElementById('newRuleTaxonomy').value;
        const tagId = document.getElementById('newRuleTag').value;
        const priorityInput = document.getElementById('newRulePriority').value;
        const priority = (priorityInput === '' || isNaN(priorityInput)) ? 200 : parseInt(priorityInput);

        if (!name || !pattern || !taxonomyId || !tagId) {
            alert('Please fill in all fields');
            return;
        }

        fetch('/logic-studio/api/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                pattern: pattern,
                match_type: matchType,
                taxonomy_id: taxonomyId,
                tag_id: tagId,
                priority: priority
            })
        })
            .then(response => {
                if (response.ok) {
                    closeCreateRuleModal();

                    // Show feedback
                    const btn = document.querySelector('button[onclick="createRule()"]');
                    const originalText = btn.innerText;
                    btn.innerText = 'Applying...';

                    // Trigger auto-tagging to apply the new rule immediately
                    fetch('/logic-studio/api/auto-tag', { method: 'POST' })
                        .then(() => {
                            loadRules();
                            loadAuditData(); // Refresh audit view
                            if (typeof loadTierData === 'function') loadTierData(); // Refresh Asset Tier view
                            btn.innerText = originalText;

                            // Clear inputs
                            document.getElementById('newRuleName').value = '';
                            document.getElementById('newRulePattern').value = '';
                        });
                } else {
                    response.json().then(data => alert(data.error || 'Error creating rule'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function deleteRule(ruleId) {
        if (!confirm('Are you sure you want to delete this rule?')) return;

        fetch(`/logic-studio/api/rules/${ruleId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    loadRules();
                } else {
                    alert('Error deleting rule');
                }
            });
    }

    function runAutoTagging() {
        if (!confirm('Run auto-tagging on all assets? This may take a moment.')) return;

        fetch('/logic-studio/api/auto-tag', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to run auto-tagging');
            });
    }

    // --- Allocation Functions ---

    function showAllocationView() {
        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.add('hidden');
        document.getElementById('ruleBuilderView').classList.add('hidden');
        document.getElementById('assetAuditView').classList.add('hidden');
        document.getElementById('allocationView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navStrategy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navRules').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navAudit').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navAllocation').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';

        loadRiskProfiles();
    }

    let riskProfiles = [];

    function loadRiskProfiles() {
        fetch('/logic-studio/api/risk-profiles')
            .then(response => response.json())
            .then(data => {
                riskProfiles = data;
                const select = document.getElementById('riskProfileSelect');
                const currentVal = select.value;
                select.innerHTML = '<option value="">Select a Profile...</option>';
                data.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.text = p.name + (p.is_active ? ' (Active)' : '');
                    select.appendChild(option);
                });
                if (currentVal) select.value = currentVal;
            });
    }

    function loadAllocations() {
        const profileId = parseInt(document.getElementById('riskProfileSelect').value);
        if (!profileId) {
            document.getElementById('allocationContent').innerHTML = '<div class="text-center py-8 text-gray-500">Select a profile to view allocations.</div>';
            document.getElementById('activeProfileBtnContainer').innerHTML = '';
            return;
        }

        // Update Active Profile Button
        const profile = riskProfiles.find(p => p.id === profileId);
        const activeBtnContainer = document.getElementById('activeProfileBtnContainer');

        if (profile) {
            if (profile.is_active) {
                activeBtnContainer.innerHTML = '<span class="text-green-600 font-medium ml-4 flex items-center"><i class="fas fa-check-circle mr-1"></i> Active Profile</span>';
            } else {
                activeBtnContainer.innerHTML = `<button onclick="setActiveProfile(${profileId})" class="ml-4 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded border border-gray-300 transition">Set as Active</button>`;
            }
        }

        // Fetch allocations and taxonomies to build the view
        Promise.all([
            fetch(`/logic-studio/api/risk-profiles/${profileId}/allocations`).then(r => r.json()),
            fetch('/logic-studio/api/taxonomies').then(r => r.json())
        ]).then(([allocations, taxonomies]) => {
            // Find Asset Class taxonomy
            const assetClassTax = taxonomies.find(t => t.name === 'Asset Class');
            if (!assetClassTax) {
                document.getElementById('allocationContent').innerHTML = '<div class="text-red-500">Asset Class taxonomy not found.</div>';
                return;
            }

            // Fetch tags for Asset Class
            fetch(`/logic-studio/api/taxonomies/${assetClassTax.id}/tags`)
                .then(r => r.json())
                .then(tags => {
                    renderAllocationTable(tags, allocations);
                });
        });
    }

    function setActiveProfile(id) {
        if (!confirm('Set this profile as the active profile for reports?')) return;

        fetch(`/logic-studio/api/risk-profiles/${id}/activate`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Reload profiles to update active status
                    loadRiskProfiles();
                    // Update button state immediately for better UX
                    setTimeout(() => loadAllocations(), 200);
                }
            });
    }

    function renderAllocationTable(tags, allocations) {
        const container = document.getElementById('allocationContent');
        container.innerHTML = '';

        // Group tags by hierarchy
        const topLevelTags = tags.filter(t => t.is_top_level || !t.parent_id);

        // Create table
        const table = document.createElement('table');
        table.className = 'min-w-full divide-y divide-gray-200';
        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Weight</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            </tbody>
        `;
        const tbody = table.querySelector('tbody');

        topLevelTags.forEach(tag => {
            const alloc = allocations.find(a => a.tag_id === tag.id);
            const weight = alloc ? alloc.target_weight : 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tag.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <input type="number" step="0.01" min="0" max="1" value="${weight}" 
                        class="allocation-input border rounded px-2 py-1 w-24" data-tag-id="${tag.id}">
                </td>
            `;
            tbody.appendChild(tr);
        });

        container.appendChild(table);
    }

    function saveAllocations() {
        const profileId = document.getElementById('riskProfileSelect').value;
        if (!profileId) return;

        const inputs = document.querySelectorAll('.allocation-input');
        const updates = Array.from(inputs).map(input => ({
            tag_id: parseInt(input.dataset.tagId),
            weight: parseFloat(input.value) || 0
        }));

        // Validate total weight
        const totalWeight = updates.reduce((sum, item) => sum + item.weight, 0);
        if (Math.abs(totalWeight - 1.0) > 0.001) {
            alert(`Total allocation must be 1.0 (100%). Current total: ${totalWeight.toFixed(2)} (${(totalWeight * 100).toFixed(0)}%)`);
            return;
        }

        fetch(`/logic-studio/api/risk-profiles/${profileId}/allocations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ allocations: updates })
        })
            .then(response => {
                if (response.ok) {
                    alert('Allocations saved successfully!');
                } else {
                    alert('Error saving allocations');
                }
            });
    }

    // --- Asset Tier Manager Functions ---

    function showAssetTier() {
        document.getElementById('taxonomyListView').classList.add('hidden');
        document.getElementById('tagManagerView').classList.add('hidden');
        document.getElementById('strategySelectorView').classList.add('hidden');
        document.getElementById('ruleBuilderView').classList.add('hidden');
        document.getElementById('allocationView').classList.add('hidden');
        document.getElementById('assetAuditView').classList.add('hidden');
        document.getElementById('assetTierView').classList.remove('hidden');

        // Update Nav
        document.getElementById('navTaxonomy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navStrategy').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navRules').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navAudit').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';
        document.getElementById('navTier').className = 'px-6 py-3 bg-blue-50 text-blue-700 font-medium border-l-4 border-blue-500';
        document.getElementById('navAllocation').className = 'px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent';

        loadTierData();
    }

    let allTierData = [];
    let tierTags = [];
    let tierAllocations = {};
    const ASSET_TIER_TAXONOMY_ID = 2; // Fixed ID from seeding

    async function loadTierData() {
        const cards = document.getElementById('tierSummaryCards');
        cards.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">Loading tier data...</div>';

        try {
            // 1. Load Tags for Asset Tier
            const tagsResponse = await fetch(`/logic-studio/api/taxonomies/${ASSET_TIER_TAXONOMY_ID}/tags`);
            tierTags = await tagsResponse.json();

            // 2. Load Tier-Specific Audit Data
            const auditResponse = await fetch('/logic-studio/api/tier-audit');
            const rawAuditData = await auditResponse.json();
            allTierData = rawAuditData;

            // 3. Load Tier Allocations from Active Profile
            const profilesRes = await fetch('/logic-studio/api/risk-profiles');
            const profiles = await profilesRes.json();
            const activeProfile = profiles.find(p => p.is_active);

            if (activeProfile) {
                const allocRes = await fetch(`/logic-studio/api/risk-profiles/${activeProfile.id}/allocations`);
                const allocs = await allocRes.json();
                // Filter for tier tags only
                tierAllocations = {};
                allocs.forEach(a => {
                    const tierTag = tierTags.find(t => t.id === a.tag_id);
                    if (tierTag) {
                        tierAllocations[tierTag.id] = a.target_weight;
                    }
                });
            }

            renderTierCards(tierTags, rawAuditData);
            renderTierAuditTable(rawAuditData);
            renderTierAllocationEditor(tierTags, tierAllocations);
            loadTierRules(); // Load tier-specific rules
        } catch (error) {
            console.error('Error loading tier data:', error);
            cards.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Error loading data.</div>';
        }
    }

    async function loadTierRules() {
        const list = document.getElementById('tierRulesList');
        list.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">Loading rules...</td></tr>';

        try {
            const response = await fetch('/logic-studio/api/rules');
            const allRules = await response.json();

            // Filter for Asset Tier taxonomy (ID 2)
            const tierRules = allRules.filter(r => r.taxonomy_id == ASSET_TIER_TAXONOMY_ID);

            list.innerHTML = '';
            if (tierRules.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">No tier rules found.</td></tr>';
                return;
            }

            // Sort by priority descending
            tierRules.sort((a, b) => (b.priority || 0) - (a.priority || 0));

            tierRules.forEach(rule => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${rule.name}</td>
                    <td class="px-4 py-2 text-sm text-gray-600"><code class="bg-gray-100 px-1 rounded">${rule.pattern}</code></td>
                    <td class="px-4 py-2 text-sm text-gray-600">${rule.tag_name}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${rule.priority || 0}</td>
                    <td class="px-4 py-2 text-sm">
                        <button onclick="deleteTierRule(${rule.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                list.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading tier rules:', error);
            list.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-center text-red-500">Error loading rules.</td></tr>';
        }
    }

    async function deleteTierRule(ruleId) {
        if (!confirm('Delete this rule?')) return;

        const res = await fetch(`/logic-studio/api/rules/${ruleId}`, { method: 'DELETE' });
        if (res.ok) {
            loadTierRules();
            loadTierData(); // Refresh audit table
        } else {
            alert('Error deleting rule.');
        }
    }

    function renderTierCards(tags, auditData) {
        const container = document.getElementById('tierSummaryCards');
        container.innerHTML = '';

        tags.forEach(tag => {
            const count = auditData.filter(item => item.current_tier === tag.name).length;

            const card = document.createElement('div');
            card.className = `bg-white p-6 rounded-lg shadow-sm border-l-4 border-${tag.color}-500`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-gray-900">${tag.name}</h3>
                    <span class="bg-${tag.color}-50 text-${tag.color}-700 px-2 py-1 rounded text-xs font-medium">${count} Assets</span>
                </div>
                <p class="text-sm text-gray-600 mb-4 h-12 overflow-hidden">${tag.description || 'Tier strategy'}</p>
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <span>${count} assets assigned</span>
                    <button onclick="selectTaxonomy(${ASSET_TIER_TAXONOMY_ID}, 'Asset Tier', '')" class="text-blue-600 hover:underline">Manage Tags</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function renderTierAuditTable(data) {
        const list = document.getElementById('tierAuditList');
        list.innerHTML = '';

        if (data.length === 0) {
            list.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No assets found.</td></tr>';
            return;
        }

        data.forEach(item => {
            const tr = document.createElement('tr');

            let tagClass = 'bg-gray-100 text-gray-800';
            if (!item.current_tier) tagClass = 'bg-red-100 text-red-800';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${item.asset_name}</div>
                    <div class="text-xs text-gray-500">${item.asset_id}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${tagClass}">
                        ${item.current_tier || 'Unmapped'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${item.active_rule ? `<span class="text-blue-600">${item.active_rule}</span>` : '<span class="text-gray-400">Manual</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="quickClassifyTier('${item.asset_name}')" class="text-blue-600 hover:text-blue-900">Classify</button>
                </td>
            `;
            list.appendChild(tr);
        });
    }

    function filterTierAuditTable() {
        const query = document.getElementById('tierAuditSearch').value.toLowerCase();
        const filter = document.getElementById('tierFilter').value;

        let filtered = allTierData.filter(item =>
            item.asset_name.toLowerCase().includes(query) ||
            item.asset_id.toLowerCase().includes(query) ||
            (item.current_tier && item.current_tier.toLowerCase().includes(query))
        );

        if (filter === 'unclassified') {
            filtered = filtered.filter(item => !item.current_tier);
        }

        renderTierAuditTable(filtered);
    }

    function openCreateRuleModalForTier() {
        openCreateRuleModal();
        setTimeout(() => {
            const taxonomySelect = document.getElementById('newRuleTaxonomy');
            taxonomySelect.value = ASSET_TIER_TAXONOMY_ID;
            loadRuleTags(ASSET_TIER_TAXONOMY_ID);
        }, 100);
    }

    function quickClassifyTier(assetName) {
        openCreateRuleModalForTier();
        document.getElementById('newRuleName').value = `Tier: ${assetName}`;
        document.getElementById('newRulePattern').value = assetName;
        document.getElementById('newRuleMatchType').value = 'exact';
    }

    function renderTierAllocationEditor(tags, allocations) {
        const container = document.getElementById('tierAllocationEditor');
        container.innerHTML = '';

        tags.forEach(tag => {
            const weight = allocations[tag.id] || 0;
            const pct = (weight * 100).toFixed(0);

            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg';
            div.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-2">${tag.name}</label>
                <div class="flex items-center">
                    <input type="number" step="1" min="0" max="100" value="${pct}"
                        class="tier-alloc-input border rounded px-3 py-2 w-24 mr-2 focus:ring-2 focus:ring-blue-500"
                        data-tag-id="${tag.id}">
                    <span class="text-gray-500">%</span>
                </div>
            `;
            container.appendChild(div);
        });

        updateTierAllocationTotal();

        // Add input listeners
        document.querySelectorAll('.tier-alloc-input').forEach(input => {
            input.addEventListener('input', updateTierAllocationTotal);
        });
    }

    function updateTierAllocationTotal() {
        const inputs = document.querySelectorAll('.tier-alloc-input');
        let total = 0;
        inputs.forEach(input => { total += parseFloat(input.value) || 0; });

        const el = document.getElementById('tierAllocationTotal');
        el.textContent = `Total: ${total.toFixed(0)}%`;
        el.className = Math.abs(total - 100) < 0.1 ? 'text-sm text-green-600 mt-4 font-medium' : 'text-sm text-red-500 mt-4 font-medium';
    }

    async function saveTierAllocations() {
        // Get active profile
        const profilesRes = await fetch('/logic-studio/api/risk-profiles');
        const profiles = await profilesRes.json();
        const activeProfile = profiles.find(p => p.is_active);

        if (!activeProfile) {
            alert('No active risk profile found.');
            return;
        }

        const inputs = document.querySelectorAll('.tier-alloc-input');
        const updates = Array.from(inputs).map(input => ({
            tag_id: parseInt(input.dataset.tagId),
            weight: (parseFloat(input.value) || 0) / 100 // Convert % to decimal
        }));

        // Validate
        const total = updates.reduce((sum, u) => sum + u.weight, 0);
        if (Math.abs(total - 1.0) > 0.01) {
            alert(`Total must be 100%. Current: ${(total * 100).toFixed(0)}%`);
            return;
        }

        const res = await fetch(`/logic-studio/api/risk-profiles/${activeProfile.id}/allocations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ allocations: updates })
        });

        if (res.ok) {
            alert('Tier allocations saved!');
            loadTierData(); // Refresh
        } else {
            alert('Error saving allocations.');
        }
    }
</script>
{% endblock %}